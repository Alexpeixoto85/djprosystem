
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema para DJs - V5.4</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #6a5acd; /* Roxo */
            --primary-hover: #5340b8;
            --background-soft: #f0f2f5;
            --background-card: #f9f9f9;
            --background-white: #ffffff;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #eee;
            --danger-color: #d9534f;
            --danger-hover: #c9302c;
            --success-color: #5cb85c;
            --warning-color: #f0ad4e;
            --info-color: #5bc0de;
            --contract-color: #4CAF50;
            --contract-hover: #45a049;
            --receipt-color: #007bff;
            --receipt-hover: #0056b3;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-soft);
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            font-size: 16px;
            line-height: 1.4;
        }
        .container {
            background-color: var(--background-white);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1200px;
            box-sizing: border-box;
            line-height: 1.3;
        }
        .cards-grid { display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;
        }
        .card { background-color: var(--background-card);
        border-radius: 8px; padding: 15px; display: flex; flex-direction: column;
        align-items: center; text-align: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        cursor: pointer; border-left: 5px solid var(--primary-color);}
        .card:hover { transform: translateY(-5px);
        box-shadow: 0 6px 10px rgba(0,0,0,0.1); }
        .icon-card { font-size: 2em; margin-bottom: 10px;
        color: var(--primary-color); }
        .card span { font-weight: bold; color: var(--text-primary); font-size: 1em;
        }
        .atalhos-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .settings-button { background: none; border: none;
        font-size: 1.5em; cursor: pointer; color: var(--text-secondary); transition: color 0.2s; }
        .settings-button:hover { color: var(--primary-color);
        }
        .btn-add { font-size: 1em; padding: 10px 15px; margin-bottom: 15px; background-color: var(--primary-color);
        color: white; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: background-color 0.2s;
        float: right; }
        .btn-add:hover { background-color: var(--primary-hover);
        }
        .btn-add .fas { font-size: 0.9em;
        }
        .btn-add-full { width: 100%; margin-bottom: 20px; font-size: 1.1em; padding: 12px;
        }
        .tab-content { margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px; display: none;
        clear: both; }
        .tab-content.active { display: block;
        }
        .tab-pane { display: none;
        }
        .tab-pane.active { display: block;
        }
        .form-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;
        }
        .form-group { flex: 1 1 48%;
        min-width: 200px; margin-bottom: 0;
        }
        .form-group.full-width { flex: 1 1 100%;
        }
        .form-group label { display: block; margin-bottom: 3px; font-weight: bold; color: #555;
        font-size: 0.9em; }
        .form-group input, .form-group textarea, .form-group select { width: 100%;
        padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9em; box-sizing: border-box;
        }
        .form-actions { margin-top: 15px;
        text-align: right; display: flex; justify-content: flex-end; gap: 10px;
        flex-wrap: wrap;}
        .btn { background-color: var(--primary-color);
        color: white; padding: 8px 15px; border: none;
        border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s;
        }
        .btn:hover { background-color: var(--primary-hover);
        }
        .btn-secondary { background-color: #ccc; color: var(--text-primary);
        }
        .btn-secondary:hover { background-color: #bbb;
        }
        .btn-small { padding: 5px 8px; font-size: 0.8em; margin: 0 2px;
        }
        .btn-danger { background-color: var(--danger-color);
        }
        .btn-danger:hover { background-color: var(--danger-hover);
        }
        .btn-success { background-color: var(--success-color);
        }
        .btn-whatsapp { background-color: #25D366; } .btn-whatsapp:hover { background-color: #1EAE51;
        }
        .btn-pdf { background-color: #E63946; } .btn-pdf:hover { background-color: #c02d38;
        }
        .btn-info { background-color: var(--info-color);
        }
        .btn-contract { background-color: var(--contract-color); } .btn-contract:hover { background-color: #45a049;
        }
        .btn-receipt { background-color: #007bff; } .btn-receipt:hover { background-color: #0056b3;
        }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0;
        width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; padding: 5px;
        box-sizing: border-box;}
        .modal-content { background-color: var(--background-white);
        margin: 1% auto; padding: 20px; border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 98%; max-width: 700px; position: relative; max-height: 98vh;
        overflow-y: auto;
        }
        .close-button { color: #aaa;
        position: absolute; top: 10px; right: 20px; font-size: 30px;
        font-weight: bold; cursor: pointer;
        }
        .close-button:hover { color: black;
        }
        .generic-table-container { width: 100%; overflow-x: auto; border: 1px solid #ddd; border-radius: 5px;
        margin-top: 15px; clear: both; }
        .generic-table { width: 100%;
        border-collapse: collapse; font-size: 0.85em;
        min-width: 600px; }
        .generic-table th, .generic-table td { padding: 8px 10px;
        text-align: left;
        border-bottom: 1px solid var(--border-color); white-space: nowrap; line-height: 1.2;
        }
        .generic-table th { background-color: var(--background-card);
        color: #555; font-weight: bold; position: sticky; top: 0; z-index: 1;
        }
        .generic-table tr:hover { background-color: #f0f0f0;
        }
        .generic-table td { white-space: normal;
        }
        .generic-table td:last-child { white-space: nowrap;
        width: auto;}
        .finance-table td.pendente { color: var(--warning-color); font-weight: bold;
        }
        .finance-table td.concluido, .finance-table td.pago, .finance-table td.receita { color: var(--success-color); font-weight: bold;
        }
        .finance-table td.cancelado, .finance-table td.despesa { color: var(--danger-color); font-weight: bold;
        }
        .finance-table td.a_receber { color: var(--warning-color);
        }
        .financial-summary { margin-top: 15px; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px;
        background-color: var(--background-card); }
        .financial-summary h4 { margin-top: 0;
        font-size: 1.1em;
        }
        .financial-summary p { font-size: 1em;
        margin: 5px 0;
        }
        .filters-container { margin-bottom: 15px;
        padding: 8px; background-color: var(--background-card); border-radius: 5px; display: flex;
        flex-wrap: wrap; justify-content: center; align-items: center;
        gap: 8px;}
        .filters-container .btn { background-color: #eee;
        color: #333; margin: 3px; padding: 6px 10px; font-size: 0.85em; }
        .filters-container .btn.active { background-color: var(--primary-color);
        color: #fff; }
        .filters-container .date-filter { display: flex; align-items: center; gap: 5px;
        }
        .filters-container .date-filter input { padding: 6px; border: 1px solid #ddd; border-radius: 4px;
        font-size: 0.85em; }
        #logo-preview { max-width: 120px;
        max-height: 80px; display: block;
        margin: 8px 0; border: 1px solid #ddd; padding: 3px;
        }
        #config-section { display: grid;
        grid-template-columns: 1fr 1fr; gap: 15px; }
        #config-section .form-group { min-width: 100%;
        }
        #birthday-alerts, #pending-orders-alerts { background-color: var(--info-color); color: white; padding: 12px; border-radius: 5px;
        margin-bottom: 15px;
        }
        #birthday-alerts h4, #pending-orders-alerts h4 { margin-top: 0;
        font-size: 1.1em;
        }
        #birthday-alerts ul, #pending-orders-alerts ul { padding-left: 15px;
        margin-top: 5px; font-size: 0.9em;
        }
        #birthday-alerts ul li, #pending-orders-alerts ul li { margin-bottom: 3px;
        }
        .btn-ok-birthday { /* Estilo para o novo botão OK dos alertas de aniversário */
            margin-left: 8px;
            padding: 2px 6px;
            font-size: 0.75em;
            line-height: 1.2;
            vertical-align: middle;
        }

        /* Estilos para as novas seções financeiras */
        .finance-section-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .finance-card {
            background-color: var(--background-card);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--primary-color);
        }

        .finance-card h4 {
            margin-top: 0;
            color: var(--text-primary);
            font-size: 1.1em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .finance-card p {
            margin: 5px 0;
            font-size: 0.95em;
            display: flex;
            justify-content: space-between;
        }

        .finance-card p strong {
            color: var(--text-primary);
        }
        .finance-card p span.positive { color: var(--success-color); font-weight: bold;
        }
        .finance-card p span.negative { color: var(--danger-color); font-weight: bold;
        }
        .finance-card p span.neutral { color: var(--warning-color); font-weight: bold;
        }

        /* Estilos para as tabelas de balanço */
        .balance-table-container {
            margin-top: 20px;
            margin-bottom: 30px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow-x: auto;
        }

        .balance-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
            min-width: 500px;
        }

        .balance-table th, .balance-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .balance-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        .balance-table tbody tr:nth-child(even) {
            background-color: var(--background-card);
        }
        .balance-table tbody tr:hover {
            background-color: #f0f0f0;
        }

        .balance-table tfoot td {
            font-weight: bold;
            background-color: #e9ecef;
            border-top: 2px solid var(--border-color);
        }

        /* Login Page Styles (hidden) */
        .login-container {
            display: none; /* Hide login screen by default */
        }
        .login-box {
            display: none; /* Hide login box as well */
        }

        /* Estilo para o botão de sair */
        .btn-logout {
            background-color: var(--danger-color);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
            margin-left: 15px;
        }
        .btn-logout:hover {
            background-color: var(--danger-hover);
        }

        /* Estilos para o Calendário */
        .calendar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background-color: var(--background-card);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 800px; /* Limita a largura máxima do calendário */
            margin-left: auto;
            margin-right: auto;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .calendar-header button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }

        .calendar-header button:hover {
            background-color: var(--primary-hover);
        }

        .calendar-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.4em;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            width: 100%;
        }

        .calendar-day-header, .calendar-day {
            text-align: center;
            padding: 10px 5px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .calendar-day-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        .calendar-day {
            background-color: var(--background-white);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            min-height: 80px;
            /* Altura mínima para cada célula do dia */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Alinha o número do dia ao topo */
            align-items: flex-start;
            /* Alinha o número do dia à direita */
            position: relative;
            /* Para posicionar o contador de eventos */
        }

        .calendar-day:hover {
            background-color: #e0e0e0;
            /* Um cinza claro para hover */
            transform: translateY(-2px);
        }

        .calendar-day.empty {
            background-color: #f5f5f5;
            /* Cinza mais claro para dias vazios */
            cursor: default;
            border-color: #f0f0f0;
        }
        .calendar-day.empty:hover {
            transform: none;
            background-color: #f5f5f5;
        }


        .calendar-day.has-events {
            /* background-color: #e6e0ff; /* Um roxo bem claro para indicar eventos */
            border: 2px solid var(--primary-color);
            /* Borda roxa mais forte */
            box-shadow: 0 0 5px rgba(106, 90, 205, 0.5);
            /* Sombra suave */
        }

        .calendar-day .day-number {
            font-weight: bold;
            font-size: 1.1em;
            color: var(--text-primary);
            margin-bottom: 5px;
            align-self: flex-end; /* Número do dia no canto superior direito */
            padding-right: 5px;
        }

        .calendar-day.current-month {
             background-color: #fdfdfd;
            /* Fundo ligeiramente diferente para dias do mês atual */
        }

        .calendar-day.other-month { /* Estilo para dias de outros meses, se você os exibir */
            color: #aaa;
            background-color: #f8f8f8;
        }
        .calendar-day.other-month:hover {
            transform: none;
            background-color: #f8f8f8;
        }


        .calendar-day.today {
            background-color: var(--info-color);
            /* Azul claro para o dia atual */
            color: white;
            border-color: var(--info-color);
        }
        .calendar-day.today .day-number {
             color: white;
        }

        .calendar-event-count {
            background-color: var(--danger-color);
            /* Vermelho para o contador */
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7em;
            position: absolute;
            top: 5px;
            left: 5px;
        }

        /* Modal para exibir eventos do dia */
        #dailyEventsModal .event-item {
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #dailyEventsModal .event-item:last-child {
            border-bottom: none;
        }
        #dailyEventsModal .event-item:hover {
            background-color: #f0f0f0;
        }
        #dailyEventsModal .event-item strong {
            color: var(--primary-color);
        }
        #dailyEventsModal .event-item p {
            margin: 3px 0;
            font-size: 0.9em;
        }
        #dailyEventsModal .event-item .event-actions {
            margin-top: 5px;
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }
        #dailyEventsModal .event-item ul {
            list-style: none;
            padding-left: 10px;
            margin: 5px 0;
            font-size: 0.85em;
        }
        #dailyEventsModal .event-item ul li {
            background-color: #f0f0f0;
            padding: 2px 5px;
            border-radius: 3px;
            margin-bottom: 2px;
        }

        /* Search Bar Style */
        .search-container {
            display: flex;
            justify-content: flex-end; /* Alinha à direita por padrão */
            margin-bottom: 15px;
            width: 100%; /* Ocupa toda a largura disponível para o input crescer */
        }
        .search-container input {
            flex-grow: 1;
            /* Permite que o input cresça */
            max-width: 300px;
            /* Largura máxima do input */
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
            box-sizing: border-box;
            background-color: var(--background-card);
        }
        .search-container input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(106, 90, 205, 0.2);
            /* Sombra roxa suave no foco */
        }

        /* NOVOS ESTILOS PARA O DASHBOARD FINANCEIRO */
        .finance-dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
        }

        .finance-chart-card {
            background-color: var(--background-card);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--info-color); /* Uma cor diferente para os gráficos */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 300px; /* Altura fixa para os gráficos */
        }

        .finance-chart-card h4 {
            margin-top: 0;
            color: var(--text-primary);
            font-size: 1.1em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .finance-chart-card canvas {
            max-width: 100%;
            max-height: calc(100% - 30px); /* Ajusta para caber o título */
        }

        /* Total não pago exibido */
        #total-nao-pagos-display {
            margin-top: 10px;
            padding: 8px 12px;
            background-color: var(--warning-color);
            color: white;
            border-radius: 5px;
            font-weight: bold;
            /* display: none; /* Oculto por padrão, será controlado por JS */ */
            text-align: center;
        }

        /* Estilo para a exibição do total financeiro filtrado */
        #total-financeiro-filtrado {
            margin-top: 15px;
            padding: 10px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
            display: none; /* Oculto por padrão, controlado por JS */
        }


        /* OTIMIZAÇÕES PARA IMPRESSÃO */
        @media print {
            body {
                margin: 0;
                padding: 0;
                font-size: 12px; /* Reduz o tamanho da fonte para impressão */
                line-height: 1.1;
            }
            .login-container { /* Esconde a tela de login */
                display: none;
            }
            .container {
                box-shadow: none;
                margin: 0;
                padding: 10mm; /* Margem de impressão */
                width: 100%;
                max-width: 100%;
                border-radius: 0;
                line-height: 1.1;
            }
            /* Esconder elementos não relevantes para impressão */
            .cards-grid, .atalhos-section, .btn-add-full, .filters-container, .form-actions,
            #config-section, .modal, .financial-summary, .finance-section-group, .btn-logout,
            .agenda-view-toggle, .calendar-container, .search-container, #birthday-alerts, #pending-orders-alerts,
            .finance-dashboard-grid, .finance-chart-card, #total-nao-pagos-display, #total-financeiro-filtrado { /* Adicionado para esconder gráficos e o display de não pagos */
                display: none !important;
            }

            .balance-table-container, .balance-table {
                display: block !important;
                /* Garante que tabelas de balanço sejam exibidas */
                width: 100% !important;
                overflow-x: visible !important;
                border: none !important;
                margin-top: 0 !important;
            }
            .balance-table {
                font-size: 10px;
                /* Ajuste de fonte para tabelas de balanço */
                page-break-inside: auto;
            }
            .balance-table th, .balance-table td {
                padding: 4px 6px;
                border-bottom: 0.5px solid #ccc;
            }

            .tab-content.active { display: block !important;
            /* Garante que o conteúdo da aba ativa seja impresso */
            }
            .tab-pane { display: block !important;
            /* Garante que painéis de aba sejam impressos se estiverem ativos */
            }

            .generic-table-container {
                overflow-x: visible !important;
                /* Remove scroll horizontal */
                border: none;
                margin-top: 0;
                line-height: 1.1;
            }
            .generic-table {
                width: 100%;
                font-size: 11px; /* Ajuste de fonte para tabelas genéricas */
                page-break-inside: auto;
                /* Tenta evitar quebra de tabela no meio da página */
            }
            .generic-table th, .generic-table td {
                padding: 5px 7px;
                /* Padding menor para economizar espaço */
                border-bottom: 0.5px solid #ccc;
                /* Borda mais fina */
                line-height: 1.1;
            }
            .generic-table thead { display: table-header-group;
            /* Repete o cabeçalho em cada página */
            }
            .generic-table tr { page-break-inside: avoid;
            page-break-after: auto; /* Tenta evitar quebra de linha no meio */
            }
            h3 { font-size: 1.2em;
            margin-top: 10px; margin-bottom: 5px;
            page-break-before: always; /* Força quebra de página antes de cada H3 (ex: início de nova seção de relatório) */
            }
            h3:first-of-type { /* Evita quebra de página antes do primeiro H3 */
                 page-break-before: auto;
            }
            p, label, input, select, textarea { font-size: 12px;
            line-height: 1.2; }

            /* Remove margens e paddings de elementos jsPDF, se necessário */
            .jsPDF {
                margin: 0;
                padding: 0;
            }
        }

        /* Media Queries para Responsividade */
        @media (max-width: 768px) { /* Tablets e telas menores */
            body { padding: 5px;
            font-size: 14px; }
            .container { padding: 15px;
            }
            .cards-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;
            }
            .card { padding: 10px;
            }
            .icon-card { font-size: 1.8em;
            }
            .btn-add { padding: 8px 12px; font-size: 0.9em;
            }
            .form-row { gap: 10px;
            /* Mantém o gap, mas os itens vão quebrar mais cedo */
            }
            .form-group { flex: 1 1 100%;
            min-width: unset; /* Ocupa 100% da largura */
            }
            .form-actions { flex-direction: column;
            gap: 10px; /* Botões em coluna */
            }
            .btn { width: 100%;
            box-sizing: border-box; /* Botões ocupam largura total */
            }
            .modal-content { padding: 20px;
            margin: 5% auto; /* Mais margem no mobile */
            }
            .close-button { top: 5px;
            right: 15px; font-size: 24px;
            }
            .filters-container { flex-direction: column;
            /* Filtros em coluna */
            }
            .filters-container .btn { width: auto;
            /* Botões de filtro com largura automática */
            }
            #config-section { grid-template-columns: 1fr;
            /* Configurações em uma coluna */
            }
            .finance-section-group { grid-template-columns: 1fr;
            /* Cards financeiros em uma coluna */
            }
            .finance-dashboard-grid { /* Ajuste para o novo dashboard financeiro */
                grid-template-columns: 1fr;
            }
            .login-box { padding: 30px 20px;
            /* Menos padding na caixa de login */
            }
            .search-container { justify-content: center;
            /* Centraliza a barra de pesquisa */
            }
            .search-container input { max-width: 100%;
            /* Input de pesquisa ocupa largura total */
            }
        }
         @media (max-width: 480px) { /* Smartphones */
            .cards-grid { grid-template-columns: 1fr 1fr;
            /* Dois cards por linha */
            }
            h2, h3 { font-size: 1.2em;
            /* Títulos menores */
            }
            .financial-summary p { font-size: 1em;
            /* Texto do resumo financeiro um pouco menor */
            }
            .btn-add { /* Ajusta o botão de adicionar principal */
                width: auto;
            /* Volta para largura automática */
                float: right;
            /* Mantém à direita */
            }
            .btn-add-full { /* Botão de adicionar pedido principal */
                width: 100%;
                float: none;
            }
             .atalhos-section {
                flex-direction: column;
                align-items: flex-start;
            }
            .atalhos-section h2 {
                margin-bottom: 10px;
            }
            .atalhos-section div { /* Contêiner dos botões de settings e logout */
                width: 100%;
                display: flex;
                justify-content: space-between;
            }
            .settings-button, .btn-logout {
                 font-size: 1.3em;
            /* Aumenta um pouco para facilitar o toque */
            }
            .btn-logout {
                margin-left: 0;
            /* Remove margem se não necessário */
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="mainSystem">
        <div id="birthday-alerts" style="display: none;">
            <h4><i class="fas fa-birthday-cake"></i> Aniversariantes Próximos!</h4>
            <ul id="birthday-list"></ul>
        </div>
        <div id="pending-orders-alerts" style="display: none; background-color: var(--danger-color);">
            <h4><i class="fas fa-exclamation-triangle"></i> Pedidos com Status Pendente!</h4>
            <ul id="pending-orders-list"></ul>
        </div>

        <div class="cards-grid">
            <div class="card" data-tab="pedidos"><i class="fas fa-file-invoice icon-card"></i><span>Pedidos</span></div>
            <div class="card" data-tab="agenda"><i class="fas fa-calendar-alt icon-card"></i><span>Agenda</span></div>
            <div class="card" data-tab="financeiro"><i class="fas fa-dollar-sign icon-card"></i><span>Financeiro</span></div>
            <div class="card" data-tab="clientes"><i class="fas fa-users icon-card"></i><span>Clientes</span></div>
            <div class="card" data-tab="materiaisEstoque"><i class="fas fa-boxes icon-card"></i><span>Materiais</span></div>
            <div class="card" data-tab="servicos"><i class="fas fa-clipboard-list icon-card"></i><span>Serviços</span></div>
        </div>

        <div class="atalhos-section">
            <h2>PAINEL DE CONTROLE</h2>
            <div>
                <button class="settings-button" data-tab="configuracoes" title="Configurações"><i class="fas fa-cog"></i></button>
                <button class="btn btn-logout" id="btn-logout" title="Sair"><i class="fas fa-sign-out-alt"></i> Sair</button>
            </div>
        </div>
        <button class="btn btn-add btn-add-full" id="btn-add-pedido-main"><i class="fas fa-plus"></i> CRIAR NOVO PEDIDO</button>

        <div id="tab-content" class="tab-content active">
            <div id="pedidos-tab" class="tab-pane active">
                <h3>Gerenciamento de Pedidos</h3>
                <div id="total-nao-pagos-display" style="display: none;"></div>
                <div class="filters-container">
                    <button class="btn filter-btn active" data-filter="todos">Todos</button>
                    <button class="btn filter-btn" data-filter="pendente">Pendentes</button>
                    <button class="btn filter-btn" data-filter="concluido">Concluídos</button>
                    <button class="btn filter-btn" data-filter="cancelado">Cancelados</button>
                    <button class="btn filter-btn" data-filter="sinal_pendente">Sinal Pendente</button>
                    <button class="btn filter-btn" data-filter="nao_pagos">Não Pagos</button>
                    <button class="btn btn-pdf btn-small" id="btn-report-pedidos"><i class="fas fa-file-pdf"></i> Relatório</button>
                </div>
                <div class="search-container">
                    <input type="text" id="search-pedidos" placeholder="Pesquisar pedidos por ID, Tipo, Cliente...">
                </div>
                <div class="generic-table-container">
                    <table class="generic-table finance-table">
                        <thead><tr><th>ID</th><th>Cliente</th><th>Tipo</th><th>Data</th><th>Status</th><th>Valor</th><th>Pago</th><th>Ações</th></tr></thead>
                        <tbody id="pedidos-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="agenda-tab" class="tab-pane">
                <h3>Agenda de Compromissos</h3>
                <div class="agenda-view-toggle" style="margin-bottom: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-small" id="btn-view-list"><i class="fas fa-list"></i> Lista</button>
                    <button class="btn btn-small active" id="btn-view-calendar"><i class="fas fa-calendar-alt"></i> Calendário</button>
                    <button class="btn btn-add btn-small" id="btn-add-agenda"><i class="fas fa-plus"></i> Adicionar</button>
                    <button class="btn btn-pdf btn-small" id="btn-report-agenda"><i class="fas fa-file-pdf"></i> Relatório</button>
                </div>
                <div class="search-container" id="search-agenda-container-list" style="display: none;"> <input type="text" id="search-agenda" placeholder="Pesquisar compromissos na lista...">
                </div>
                <div id="agenda-list-view" style="display: none;">
                    <div class="generic-table-container">
                        <table class="generic-table">
                            <thead><tr><th>Data</th><th>Horário</th><th>Descrição</th><th>Cliente</th><th>Status</th><th>Ações</th></tr></thead>
                            <tbody id="agenda-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="agenda-calendar-view" style="display: block;">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button id="prevMonth"><i class="fas fa-chevron-left"></i></button>
                            <h3 id="currentMonthYear"></h3>
                            <button id="nextMonth"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                        </div>
                    </div>
                </div>
            </div>

            <div id="financeiro-tab" class="tab-pane">
                <h3>Controle Financeiro</h3>
                <button class="btn btn-add" id="btn-add-despesa" style="background-color: var(--danger-color);"><i class="fas fa-minus"></i> Adicionar Despesa</button>
                <button class="btn btn-pdf btn-small" id="btn-report-financeiro" style="float:none; margin-left: 10px;"><i class="fas fa-file-pdf"></i> Relatório Completo</button>
                <button class="btn btn-warning btn-small" id="btn-report-sinal-pendente" style="float:none; margin-left: 10px;"><i class="fas fa-exclamation-circle"></i> Sinal Pendente</button>

                <div class="finance-dashboard-grid">
                    <div class="finance-summary finance-card">
                        <h4><i class="fas fa-chart-pie"></i> Resumo Geral:</h4>
                        <p>Total a Receber (Pedidos Pendentes): <span id="total-a-receber" class="neutral">R$ 0,00</span></p>
                        <p>Total Recebido: <span id="total-recebido" class="positive">R$ 0,00</span></p>
                        <p>Total Despesas: <span id="total-despesas-fin" class="negative">R$ 0,00</span></p>
                        <p><strong>Saldo Atual (Recebido - Despesas):</strong> <span id="saldo-atual" class="neutral">R$ 0,00</span></p>
                    </div>
                    <div class="financial-forecast finance-card">
                        <h4><i class="fas fa-chart-line"></i> Previsão Financeira:</h4>
                        <p>Total Previsto a Receber: <span id="previsto-a-receber" class="positive">R$ 0,00</span></p>
                        <p>Total Previsto a Pagar (Despesas Futuras): <span id="previsto-a-pagar" class="negative">R$ 0,00</span></p>
                        <p><strong>Saldo Projetado:</strong> <span id="saldo-projetado" class="neutral">R$ 0,00</span></p>
                    </div>
                    <div class="finance-chart-card">
                        <h4><i class="fas fa-chart-bar"></i> Faturamento Mensal</h4>
                        <canvas id="monthlyRevenueChart"></canvas>
                    </div>
                    <div class="finance-chart-card">
                        <h4><i class="fas fa-circle-notch"></i> Receitas vs Despesas</h4>
                        <canvas id="revenueExpenseChart"></canvas>
                    </div>
                </div>

                <div class="balance-table-container">
                    <h4>Balanço Mensal:</h4>
                    <table class="balance-table">
                        <thead><tr><th>Mês/Ano</th><th>Receitas</th><th>Despesas</th><th>Saldo</th></tr></thead>
                        <tbody id="monthly-balance-body"></tbody>
                    </table>
                </div>

                <div class="balance-table-container">
                    <h4>Balanço Anual:</h4>
                    <table class="balance-table">
                        <thead><tr><th>Ano</th><th>Receitas</th><th>Despesas</th><th>Saldo</th></tr></thead>
                        <tbody id="annual-balance-body"></tbody>
                        <tfoot id="annual-balance-footer"></tfoot>
                    </table>
                </div>

                <div class="filters-container">
                    <div>
                        <button class="btn finance-filter-btn active" data-filter="todos">Todos</button>
                        <button class="btn finance-filter-btn" data-filter="receita">Receitas</button>
                        <button class="btn finance-filter-btn" data-filter="despesa">Despesas</button>
                        <button class="btn finance-filter-btn" data-filter="a_receber">A Receber</button>
                    </div>
                    <div class="date-filter">
                        <label>De:</label> <input type="date" id="finance-start-date">
                        <label>Até:</label> <input type="date" id="finance-end-date">
                        <button class="btn btn-info btn-small" id="btn-filter-date"><i class="fas fa-filter"></i> Filtrar Período</button>
                        <button class="btn btn-secondary btn-small" id="btn-clear-date-filter"><i class="fas fa-times"></i> Limpar</button>
                    </div>
                </div>
                <div class="search-container">
                    <input type="text" id="search-financeiro" placeholder="Pesquisar lançamentos...">
                </div>
                <div id="total-financeiro-filtrado" style="margin-top: 15px; padding: 10px; background-color: var(--primary-color); color: white; border-radius: 5px; font-weight: bold; text-align: center; display: none;">
                    Total Filtrado: <span id="valor-total-filtrado">R$ 0,00</span>
                </div>
                <div class="generic-table-container">
                    <table class="generic-table finance-table">
                        <thead><tr><th>Data</th><th>Tipo</th><th>Descrição</th><th>Valor</th><th>Status/Pedido</th><th>Ações</th></tr></thead>
                        <tbody id="financeiro-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="clientes-tab" class="tab-pane">
                <h3>Gerenciamento de Clientes</h3>
                <button class="btn btn-add" id="btn-add-cliente"><i class="fas fa-user-plus"></i> Adicionar</button>
                <button class="btn btn-pdf btn-small" id="btn-report-clientes" style="float:none; margin-left: 10px;"><i class="fas fa-file-pdf"></i> Relatório</button>
                <div class="search-container" style="clear:both;">
                    <input type="text" id="search-clientes" placeholder="Pesquisar clientes...">
                </div>
                <div class="generic-table-container">
                    <table class="generic-table">
                        <thead><tr><th>Nome</th><th>Contato</th><th>Aniversário</th><th>Observações</th><th>Ações</th></tr></thead>
                        <tbody id="clientes-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="materiaisEstoque-tab" class="tab-pane">
                <h3>Materiais & Estoque</h3>
                <button class="btn btn-add" id="btn-add-material"><i class="fas fa-plus"></i> Adicionar</button>
                <button class="btn btn-pdf btn-small" id="btn-report-materiais" style="float:none; margin-left: 10px;"><i class="fas fa-file-pdf"></i> Relatório</button>
                <div class="search-container" style="clear:both;">
                    <input type="text" id="search-materiais" placeholder="Pesquisar materiais...">
                </div>
                <div class="generic-table-container">
                    <table class="generic-table">
                        <thead><tr><th>Item</th><th>Quantidade</th><th>Observações</th><th>Ações</th></tr></thead>
                        <tbody id="materiais-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="servicos-tab" class="tab-pane">
                <h3>Serviços Oferecidos</h3>
                <button class="btn btn-add" id="btn-add-servico"><i class="fas fa-plus"></i> Adicionar</button>
                <button class="btn btn-pdf btn-small" id="btn-report-servicos" style="float:none; margin-left: 10px;"><i class="fas fa-file-pdf"></i> Relatório</button>
                <div class="search-container" style="clear:both;">
                    <input type="text" id="search-servicos" placeholder="Pesquisar serviços...">
                </div>
                <div class="generic-table-container">
                    <table class="generic-table">
                        <thead><tr><th>Serviço</th><th>Descrição</th><th>Valor Base</th><th>Ações</th></tr></thead>
                        <tbody id="servicos-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="configuracoes-tab" class="tab-pane">
                <h3>Configurações Gerais</h3>
                <div id="config-section">
                    <div>
                        <h4>Dados da Empresa</h4>
                        <form id="config-form">
                            <div class="form-group full-width"><label>Nome da Empresa/DJ:</label><input type="text" name="empresaNome"></div>
                            <div class="form-group full-width"><label>CNPJ/CPF:</label><input type="text" name="empresaDoc"></div>
                            <div class="form-group full-width"><label>Endereço Completo:</label><input type="text" name="empresaEndereco"></div>
                            <div class="form-group full-width"><label>Telefone/WhatsApp:</label><input type="text" name="empresaContato"></div>
                            <div class="form-group full-width"><label>Email:</label><input type="email" name="empresaEmail"></div>
                            <div class="form-group full-width"><label>Website/Social:</label><input type="text" name="empresaSite"></div>
                            <div class="form-actions"><button type="submit" class="btn">Salvar Dados</button></div>
                        </form>
                    </div>
                    <div>
                        <h4>Logomarca</h4>
                        <div class="form-group full-width">
                            <label>Carregar Logomarca (PNG/JPG, ideal até 200KB):</label>
                            <input type="file" id="logoUpload" accept="image/png, image/jpeg">
                            <img id="logo-preview" src="#" alt="Pré-visualização da Logo" style="display: none;">
                            <button id="btn-remove-logo" class="btn btn-small btn-danger" style="display: none;"><i class="fas fa-trash"></i> Remover Logo</button>
                        </div>
                        <hr>
                        <h4>Backup & Restauração</h4>
                        <div class="form-group full-width">
                            <label>Faça o backup ou restaure seus dados:</label>
                            <button id="btn-export-data" class="btn btn-info"><i class="fas fa-download"></i> Exportar Backup</button>
                            <input type="file" id="import-file" accept=".json" style="display: none;">
                            <button id="btn-import-data" class="btn btn-warning"><i class="fas fa-upload"></i> Importar Backup</button>
                            <p><small>Importar um backup substituirá TODOS os dados atuais.</small></p>
                        </div>
                        <hr>
                        <h4>Dados do Sistema</h4>
                        <button id="btn-clear-data" class="btn btn-danger"><i class="fas fa-exclamation-triangle"></i> Limpar Todos os Dados</button>
                        <p><small><strong>Atenção:</strong> Esta ação é irreversível.</small></p>
                    </div>
                    <div class="full-width" style="grid-column: 1 / -1;">
                        <h4>Gerenciamento de Usuários</h4>
                        <form id="user-form">
                            <input type="hidden" name="id">
                            <div class="form-row">
                                <div class="form-group"><label>Usuário:</label><input type="text" name="username" required></div>
                                <div class="form-group"><label>Senha:</label><input type="password" name="password" required></div>
                            </div>
                            <div class="form-actions" style="justify-content: flex-start;">
                                <button type="submit" class="btn" id="btn-save-user">Salvar Usuário</button>
                                <button type="button" class="btn btn-secondary" id="btn-cancel-user-edit" style="display:none;">Cancelar Edição</button>
                            </div>
                        </form>
                        <div class="generic-table-container" style="margin-top: 20px;">
                            <table class="generic-table">
                                <thead><tr><th>Usuário</th><th>Ações</th></tr></thead>
                                <tbody id="users-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="pedidoModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span> <h2 id="pedido-modal-title">Novo Pedido</h2>
                <form id="pedido-form">
                    <input type="hidden" name="id">
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="pedido-cliente-select">Cliente:</label>
                            <select name="clienteId" id="pedido-cliente-select" required> <option value="">Selecione...</option> </select>
                            <small>Não encontrou? <a href="#" id="link-add-cliente-modal">Adicione um novo cliente</a>.</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Data do Evento:</label><input type="date" name="dataEvento" required></div>
                        <div class="form-group"><label>Tipo do Evento:</label><input type="text" name="tipoEvento" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Hora Início:</label><input type="time" name="horaInicio" required></div>
                        <div class="form-group"><label>Hora Final:</label><input type="time" name="horaFinal" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Tema do Evento:</label><input type="text" name="temaEvento"></div>
                        <div class="form-group"><label>Nº de Pessoas:</label><input type="number" name="numeroPessoas" min="1"></div>
                    </div>
                    <div class="form-row"><div class="form-group full-width"><label>Local do Evento:</label><input type="text" name="localEvento" required></div></div>
                    <div class="form-row">
                        <div class="form-group"><label>Valor Total (R$):</label><input type="number" step="0.01" name="valorTotal" required></div>
                        <div class="form-group">
                            <label for="status">Status:</label>
                            <select name="status"> <option value="pendente">Pendente</option> <option value="concluido">Concluido</option> <option value="cancelado">Cancelado</option> </select>
                        </div>
                    </div>
                    <div class="form-row"><div class="form-group full-width"><label>Serviços Inclusos (1 por linha):</label><textarea name="servicos" placeholder="DJ Sonorização (Até 100 pessoas)&#10;Iluminação Pista de Dança&#10;Projetor e Telão"></textarea></div></div>
                    <div class="form-row"><div class="form-group full-width"><label>Observações:</label><textarea name="observacoes"></textarea></div></div>
                    <div class="form-actions">
                        <button type="submit" class="btn"><i class="fas fa-save"></i> Salvar Pedido</button>
                        <button type="button" class="btn btn-pdf" id="btn-download-pdf"><i class="fas fa-file-pdf"></i> Baixar Pedido</button>
                        <button type="button" class="btn btn-whatsapp" id="btn-send-whatsapp"><i class="fab fa-whatsapp"></i> Enviar WhatsApp</button>
                        <button type="button" class="btn btn-secondary close-btn">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="clientModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span> <h2 id="client-modal-title">Adicionar Cliente</h2>
                <form id="client-form">
                    <input type="hidden" name="id">
                    <div class="form-row"><div class="form-group full-width"><label>Nome Completo:</label><input type="text" name="nome" required></div></div>
                    <div class="form-row">
                        <div class="form-group"><label>CPF/CNPJ:</label><input type="text" name="docCliente"></div>
                        <div class="form-group"><label>Contato (Tel/WhatsApp):</label><input type="text" name="contato"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Email:</label><input type="email" name="emailCliente"></div>
                        <div class="form-group"><label>Aniversário:</label><input type="date" name="aniversario"></div>
                    </div>
                    <div class="form-row"><div class="form-group full-width"><label>Endereço:</label><input type="text" name="enderecoCliente"></div></div>
                    <div class="form-row"><div class="form-group full-width"><label>Observações:</label><textarea name="obs"></textarea></div></div>
                    <div class="form-actions"><button type="submit" class="btn">Salvar</button><button type="button" class="btn btn-secondary close-btn">Cancelar</button></div>
                </form>
            </div>
        </div>

        <div id="pagamentoModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span> <h2>Lançar Pagamento Parcial/Total</h2>
                <form id="pagamento-form">
                    <input type="hidden" name="pedidoId">
                    <input type="hidden" name="financeiroId"> <div class="form-row"><div class="form-group full-width"><label>Descrição:</label><input type="text" name="descricao" value="Pagamento Recebido" required></div></div>
                    <div class="form-row"><div class="form-group"><label>Data:</label><input type="date" name="data" required></div></div>
                    <div class="form-row">
                        <div class="form-group"><label>Valor Recebido (R$):</label><input type="number" step="0.01" name="valor" required></div>
                        <div class="form-group">
                            <label for="formaPagamento">Forma de Pagamento:</label>
                            <select name="formaPagamento" id="formaPagamento" required>
                                <option value="">Selecione...</option>
                                <option value="PIX">PIX</option>
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="Transferencia Bancaria">Transferência Bancária</option>
                                <option value="Cartao de Credito">Cartão de Crédito</option>
                                <option value="Cartao de Debito">Cartão de Débito</option>
                                <option value="Boleto">Boleto</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions"><button type="submit" class="btn">Lançar Pagamento</button><button type="button" class="btn btn-secondary close-btn">Cancelar</button></div>
                </form>
            </div>
        </div>

        <div id="agendaDetailsModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h2>Detalhes do Compromisso</h2>
                <form id="agenda-details-form">
                    <input type="hidden" name="id">
                    <div class="form-row">
                        <div class="form-group full-width"><label>Cliente:</label><input type="text" name="cliente" readonly></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Data:</label><input type="date" name="data" readonly></div>
                        <div class="form-group"><label>Horário:</label><input type="time" name="horario" readonly></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width"><label>Descrição:</label><input type="text" name="descricao" readonly></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width"><label>Local do Evento:</label><input type="text" name="localEventoAgenda" readonly></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width"><label>Observações:</label><textarea name="obsAgenda" rows="3"></textarea></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Status:</label>
                            <select name="statusAgenda" id="statusAgendaSelect">
                                <option value="pendente">Pendente</option>
                                <option value="concluido">Concluído</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Pedido Relacionado:</label>
                            <input type="text" name="pedidoRelacionado" readonly>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-success" id="btn-complete-agenda"><i class="fas fa-check-circle"></i> Marcar como Concluído</button>
                        <button type="button" class="btn btn-danger" id="btn-cancel-agenda"><i class="fas fa-times-circle"></i> Marcar como Cancelado</button>
                        <button type="button" class="btn" id="btn-save-agenda-details"><i class="fas fa-save"></i> Salvar Observações/Status</button>
                        <button type="button" class="btn btn-info" id="btn-view-related-pedido" style="display:none;"><i class="fas fa-file-invoice"></i> Ver Pedido</button>
                        <button type="button" class="btn btn-secondary close-btn">Fechar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="addAgendaModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span> <h2 id="add-agenda-modal-title">Adicionar Compromisso</h2>
                <form id="add-agenda-form">
                    <input type="hidden" name="id">
                    <input type="hidden" name="pedidoId"> <div class="form-row"><div class="form-group full-width"><label>Descrição:</label><input type="text" name="descricao" required></div></div>
                    <div class="form-row">
                        <div class="form-group"><label>Data:</label><input type="date" name="data" required></div>
                        <div class="form-group"><label>Horário:</label><input type="time" name="horario" required></div>
                    </div>
                    <div class="form-row"><div class="form-group"><label>Cliente (Opcional):</label><input type="text" name="cliente"></div></div>
                    <div class="form-actions"><button type="submit" class="btn">Salvar</button><button type="button" class="btn btn-secondary close-btn">Cancelar</button></div>
                </form>
            </div>
        </div>

        <div id="materialModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span> <h2 id="material-modal-title">Adicionar Material</h2>
                <form id="material-form">
                    <input type="hidden" name="id">
                    <div class="form-row"><div class="form-group full-width"><label>Item:</label><input type="text" name="item" required></div></div>
                    <div class="form-row"><div class="form-group"><label>Quantidade:</label><input type="number" name="quantidade" min="0" value="1" required></div></div>
                    <div class="form-row"><div class="form-group full-width"><label>Observações:</label><textarea name="obs"></textarea></div></div>
                    <div class="form-actions"><button type="submit" class="btn">Salvar</button><button type="button" class="btn btn-secondary close-btn">Cancelar</button></div>
                </form>
            </div>
        </div>

        <div id="servicoModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span> <h2 id="servico-modal-title">Adicionar Serviço</h2>
                <form id="servico-form">
                    <input type="hidden" name="id">
                    <div class="form-row"><div class="form-group full-width"><label>Serviço:</label><input type="text" name="nome" required></div></div>
                    <div class="form-row"><div class="form-group full-width"><label>Descrição:</label><textarea name="descricao"></textarea></div></div>
                    <div class="form-row"><div class="form-group"><label>Valor Base (R$):</label><input type="number" step="0.01" name="valor"></div></div>
                    <div class="form-actions"><button type="submit" class="btn">Salvar</button><button type="button" class="btn btn-secondary close-btn">Cancelar</button></div>
                </form>
            </div>
        </div>

        <div id="despesaModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span> <h2>Adicionar Despesa</h2>
                <form id="despesa-form">
                    <input type="hidden" name="id">
                    <div class="form-row"><div class="form-group full-width"><label>Descrição:</label><input type="text" name="descricao" required></div></div>
                    <div class="form-row"><div class="form-group"><label>Data:</label><input type="date" name="data" required></div></div>
                    <div class="form-row"><div class="form-group"><label>Valor (R$):</label><input type="number" step="0.01" name="valor" required></div></div>
                    <div class="form-actions"><button type="submit" class="btn">Salvar Despesa</button><button type="button" class="btn btn-secondary close-btn">Cancelar</button></div>
                </form>
            </div>
        </div>

        <div id="dailyEventsModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h2 id="daily-events-modal-title">Compromissos do Dia</h2>
                <div id="daily-events-list"></div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary close-btn">Fechar</button>
                </div>
            </div>
        </div>

    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("CRM DJ V5.4 - Inicializando Sistema...");
            const { jsPDF } = window.jspdf;
            // ==================================================================
            // 1. SELETORES GLOBAIS
            // ==================================================================
            const selectors = {
                cards: document.querySelectorAll('.card'),
                tabContent: document.getElementById('tab-content'),
                tabPanes: document.querySelectorAll('.tab-pane'),
                settingsButton: document.querySelector('.settings-button'),
                pedidosTableBody: document.getElementById('pedidos-table-body'),
                pedidoModal: document.getElementById('pedidoModal'),
                pedidoForm: document.getElementById('pedido-form'),
                btnAddPedido: document.getElementById('btn-add-pedido-main'),
                filterButtons: document.querySelectorAll('.filter-btn'),
                pedidoClienteSelect: document.getElementById('pedido-cliente-select'),
                linkAddClienteModal: document.getElementById('link-add-cliente-modal'),
                clientesTableBody: document.getElementById('clientes-table-body'),
                clientModal: document.getElementById('clientModal'),
                clientForm: document.getElementById('client-form'),
                btnAddCliente: document.getElementById('btn-add-cliente'),
                agendaTableBody: document.getElementById('agenda-table-body'),
                addAgendaModal: document.getElementById('addAgendaModal'),
                addAgendaForm: document.getElementById('add-agenda-form'),
                btnAddAgenda: document.getElementById('btn-add-agenda'),
                materiaisTableBody: document.getElementById('materiais-table-body'),
                materialModal: document.getElementById('materialModal'),
                materialForm: document.getElementById('material-form'),
                btnAddMaterial: document.getElementById('btn-add-material'),
                servicosTableBody: document.getElementById('servicos-table-body'),
                servicoModal: document.getElementById('servicoModal'),
                servicoForm: document.getElementById('servico-form'),
                btnAddServico: document.getElementById('btn-add-servico'),
                financeiroTableBody: document.getElementById('financeiro-table-body'),
                totalAReceber: document.getElementById('total-a-receber'),
                totalRecebido: document.getElementById('total-recebido'),
                totalDespesasFin: document.getElementById('total-despesas-fin'),
                saldoAtual: document.getElementById('saldo-atual'),
                btnAddDespesa: document.getElementById('btn-add-despesa'),
                despesaModal: document.getElementById('despesaModal'),
                despesaForm: document.getElementById('despesa-form'),
                btnClearData: document.getElementById('btn-clear-data'),
                configForm: document.getElementById('config-form'),
                logoUpload: document.getElementById('logoUpload'),
                logoPreview: document.getElementById('logo-preview'),
                btnRemoveLogo: document.getElementById('btn-remove-logo'),
                btnExportData: document.getElementById('btn-export-data'),
                btnImportData: document.getElementById('btn-import-data'),
                importFile: document.getElementById('import-file'),
                btnDownloadPdf: document.getElementById('btn-download-pdf'),
                btnSendWhatsapp: document.getElementById('btn-send-whatsapp'),
                birthdayAlerts: document.getElementById('birthday-alerts'),
                birthdayList: document.getElementById('birthday-list'),
                pagamentoModal: document.getElementById('pagamentoModal'),
                pagamentoForm: document.getElementById('pagamento-form'),
                financeFilterButtons: document.querySelectorAll('.finance-filter-btn'),
                financeStartDate: document.getElementById('finance-start-date'),
                financeEndDate: document.getElementById('finance-end-date'),
                btnFilterDate: document.getElementById('btn-filter-date'),
                btnClearDateFilter: document.getElementById('btn-clear-date-filter'),

                btnReportPedidos: document.getElementById('btn-report-pedidos'),
                btnReportAgenda: document.getElementById('btn-report-agenda'),
                btnReportFinanceiro: document.getElementById('btn-report-financeiro'),
                btnReportClientes: document.getElementById('btn-report-clientes'),
                btnReportMateriais: document.getElementById('btn-report-materiais'),
                btnReportServicos: document.getElementById('btn-report-servicos'),
                btnReportSinalPendente: document.getElementById('btn-report-sinal-pendente'), // Novo seletor

                agendaDetailsModal: document.getElementById('agendaDetailsModal'),
                agendaDetailsForm: document.getElementById('agenda-details-form'),
                btnCompleteAgenda: document.getElementById('btn-complete-agenda'),
                btnCancelAgenda: document.getElementById('btn-cancel-agenda'),
                btnSaveAgendaDetails: document.getElementById('btn-save-agenda-details'),
                statusAgendaSelect: document.getElementById('statusAgendaSelect'),
                btnViewRelatedPedido: document.getElementById('btn-view-related-pedido'),

                previstoAReceber: document.getElementById('previsto-a-receber'),
                previstoAPagar: document.getElementById('previsto-a-pagar'),
                saldoProjetado: document.getElementById('saldo-projetado'),
                monthlyBalanceBody: document.getElementById('monthly-balance-body'),
                annualBalanceBody: document.getElementById('annual-balance-body'),
                annualBalanceFooter: document.getElementById('annual-balance-footer'),

                mainSystem: document.getElementById('mainSystem'),
                btnLogout: document.getElementById('btn-logout'),

                userForm: document.getElementById('user-form'),
                usersTableBody: document.getElementById('users-table-body'),
                btnSaveUser: document.getElementById('btn-save-user'),
                btnCancelUserEdit: document.getElementById('btn-cancel-user-edit'),

                btnViewList: document.getElementById('btn-view-list'),
                btnViewCalendar: document.getElementById('btn-view-calendar'),
                agendaListView: document.getElementById('agenda-list-view'),
                agendaCalendarView: document.getElementById('agenda-calendar-view'),
                searchAgendaContainerList: document.getElementById('search-agenda-container-list'),
                currentMonthYear: document.getElementById('currentMonthYear'),
                prevMonthBtn: document.getElementById('prevMonth'),
                nextMonthBtn: document.getElementById('nextMonth'),
                calendarGrid: document.getElementById('calendar-grid'),

                dailyEventsModal: document.getElementById('dailyEventsModal'),
                dailyEventsModalTitle: document.getElementById('daily-events-modal-title'),
                dailyEventsList: document.getElementById('daily-events-list'),

                searchPedidos: document.getElementById('search-pedidos'),
                searchAgenda: document.getElementById('search-agenda'),
                searchClientes: document.getElementById('search-clientes'),
                searchMateriais: document.getElementById('search-materiais'),
                searchServicos: document.getElementById('search-servicos'),
                searchFinanceiro: document.getElementById('search-financeiro'),

                pendingOrdersAlerts: document.getElementById('pending-orders-alerts'),
                pendingOrdersList: document.getElementById('pending-orders-list'),

                monthlyRevenueChartCanvas: document.getElementById('monthlyRevenueChart'),
                revenueExpenseChartCanvas: document.getElementById('revenueExpenseChart'),

                totalNaoPagosDisplay: document.getElementById('total-nao-pagos-display'), // NOVO SELETOR
                totalFinanceiroFiltradoDisplay: document.getElementById('total-financeiro-filtrado'), // NOVO SELETOR
                valorTotalFinanceiroFiltrado: document.getElementById('valor-total-filtrado') // NOVO SELETOR
            };

            // Variáveis para as instâncias dos gráficos Chart.js
            let monthlyRevenueChartInstance = null;
            let revenueExpenseChartInstance = null;

            // ==================================================================
            // 2. ESTADO DA APLICAÇÃO (Com IndexedDB)
            // ==================================================================

            const DB_NAME = 'djProSystemDB';
            const DB_VERSION = 2;
            let db;

            const openDb = () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);

                    request.onupgradeneeded = (event) => {
                        db = event.target.result;
                        if (!db.objectStoreNames.contains('pedidos')) {
                            db.createObjectStore('pedidos', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('clientes')) {
                            db.createObjectStore('clientes', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('agenda')) {
                            db.createObjectStore('agenda', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('materiais')) {
                            db.createObjectStore('materiais', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('servicos')) {
                            db.createObjectStore('servicos', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('financeiro')) {
                            db.createObjectStore('financeiro', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('configuracoes')) {
                            db.createObjectStore('configuracoes', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('users')) {
                            db.createObjectStore('users', { keyPath: 'id' });
                        }
                        console.log('IndexedDB: Database upgrade/creation complete.');
                    };

                    request.onsuccess = (event) => {
                        db = event.target.result;
                        console.log('IndexedDB: Database opened successfully.');
                        resolve(db);
                    };

                    request.onerror = (event) => {
                        console.error('IndexedDB: Error opening database:', event.target.error);
                        reject(event.target.error);
                    };
                });
            };

            const loadDataFromIndexedDB = async (storeName, defaultValue = []) => {
                try {
                    if (!db) await openDb();
                    return new Promise((resolve, reject) => {
                        const transaction = db.transaction([storeName], 'readonly');
                        const store = transaction.objectStore(storeName);
                        const request = store.getAll();

                        request.onsuccess = () => {
                            if (storeName === 'configuracoes') {
                                resolve(request.result[0] || defaultValue);
                            } else {
                                resolve(request.result.length > 0 ? request.result : defaultValue);
                            }
                        };

                        request.onerror = (event) => {
                            console.error(`IndexedDB: Error loading data from ${storeName}:`, event.target.error);
                            resolve(defaultValue);
                        };
                    });
                } catch (e) {
                    console.error(`IndexedDB: Failed to open DB or load data for ${storeName}.`, e);
                    return defaultValue;
                }
            };
            const saveDataToIndexedDB = async (storeName, data) => {
                try {
                    if (!db) await openDb();
                    return new Promise((resolve, reject) => {
                        const transaction = db.transaction([storeName], 'readwrite');
                        const store = transaction.objectStore(storeName);

                        if (storeName === 'users') {
                            const newUsers = data;
                            const deleteRequest = store.clear();
                            deleteRequest.onsuccess = () => {
                                newUsers.forEach(item => {
                                    if (!item.id) item.id = generateId(storeName.slice(0,3));
                                    store.put(item);
                                });
                            };
                            deleteRequest.onerror = (event) => {
                                console.error(`IndexedDB: Error clearing store ${storeName}:`, event.target.error);
                                reject(event.target.error);
                                return;
                            };
                        } else {
                            const clearRequest = store.clear();
                            clearRequest.onsuccess = () => {
                                if (storeName === 'configuracoes') {
                                    store.put({ ...data, id: 'config_main' });
                                } else if (Array.isArray(data)) {
                                    data.forEach(item => {
                                         if (!item.id) {
                                            item.id = generateId(storeName.slice(0,3));
                                        }
                                        store.put(item);
                                    });
                                } else {
                                    store.put(data);
                                }
                            };
                            clearRequest.onerror = (event) => {
                                console.error(`IndexedDB: Error clearing store ${storeName}:`, event.target.error);
                                reject(event.target.error);
                                return;
                            };
                        }


                        transaction.oncomplete = () => {
                            console.log(`IndexedDB: Data for ${storeName} saved successfully.`);
                            resolve();
                        };

                        transaction.onerror = (event) => {
                            console.error(`IndexedDB: Error saving data to ${storeName}:`, event.target.error);
                            reject(event.target.error);
                        };
                    });
                } catch (e) {
                    console.error(`IndexedDB: Failed to open DB or save data for ${storeName}.`, e);
                    alert(`Atenção: Não foi possível salvar os dados no IndexedDB para ${storeName}.`);
                }
            };
            const loadData = async (key, defaultValue = []) => {
                const storeName = key.replace('_v4', '');
                if (storeName === 'configuracoes') {
                    const data = await loadDataFromIndexedDB(storeName, defaultValue);
                    if (!data.empresa) data.empresa = {};
                    return data;
                }
                 if (storeName === 'users') {
                    const data = await loadDataFromIndexedDB(storeName, []);
                    if (data.length === 0) {
                        await saveDataToIndexedDB(storeName, defaultValue);
                        return defaultValue;
                    }
                    return data;
                }
                return await loadDataFromIndexedDB(storeName, defaultValue);
            };

            const saveData = async (key, data) => {
                const storeName = key.replace('_v4', '');
                await saveDataToIndexedDB(storeName, data);
            };


            let state = {
                pedidos: [], clientes: [], agenda: [], materiais: [],
                servicos: [], financeiro: [], configuracoes: { logo: null, empresa: {} },
                users: [{id: 'user_default', username: 'admin', password: '123'}],
                currentFilter: 'todos',
                financeFilter: 'todos',
                agendaView: 'calendar',
                currentCalendarDate: new Date(),
            };
            // ==================================================================
            // 3. FUNÇÕES UTILITÁRIAS
            // ==================================================================
            const formatCurrency = (value) => (parseFloat(value) || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const formatDate = (dateStr) => {
                if (!dateStr || dateStr.trim() === "") return 'N/A';
                const date = new Date(dateStr + "T00:00:00");
                if (isNaN(date.getTime())) return 'N/A';
                return date.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
            };
            const formatMonthYear = (dateStr) => {
                if (!dateStr) return 'N/A';
                const date = new Date(`${dateStr}T00:00:00`);
                return date.toLocaleDateString('pt-BR', { month: '2-digit', year: 'numeric', timeZone: 'UTC' });
            };
            const formatDateToISO = (dateStr) => {
                if (!dateStr) return null;
                try {
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) return new Date().toISOString().split('T')[0];
                    return date.toISOString().split('T')[0];
                } catch (e) {
                    return new Date().toISOString().split('T')[0];
                }
            };
            const generateId = (prefix) => `${prefix}_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`;
            const closeModal = (modal) => { if(modal) modal.style.display = 'none'; };
            const openModal = (modal, formElement, title = 'Adicionar', itemData = null) => {
                if (!modal) { console.error("Modal element not found."); return; }
                const titleElement = modal.querySelector('h2');
                if (formElement) formElement.reset();

                if(titleElement) titleElement.textContent = title;
                const idInput = formElement ? formElement.querySelector('[name="id"]') : null;
                if (idInput) idInput.value = '';
                if (itemData && formElement) {
                    if(titleElement) titleElement.textContent = title.replace('Adicionar', 'Editar').replace('Novo', 'Editar');
                    Object.keys(itemData).forEach(key => {
                        const input = formElement.querySelector(`[name="${key}"]`);
                        if (input) {
                            if (input.type === 'date') {
                                input.value = formatDateToISO(itemData[key]);
                            } else {
                                input.value = itemData[key];
                            }
                        }
                    });
                }
                modal.style.display = 'flex';
            };
            const getClientById = (clientId) => state.clientes.find(c => c.id === clientId) || {};
            const getClientNameById = (clientId) => getClientById(clientId).nome || 'Cliente Desconhecido';
            const getPedidoById = (pedidoId) => state.pedidos.find(p => p.id === pedidoId) || {};
            const getAgendaById = (agendaId) => state.agenda.find(a => a.id === agendaId) || {};
            const getCidadeFromConfig = () => {
                const endereco = state.configuracoes.empresa?.empresaEndereco;
                if (endereco) {
                    const parts = endereco.split(/,\s*|\s+-\s+/);
                    for (let i = parts.length - 1; i >= 0; i--) {
                        if (i > 0 && (parts[i].match(/^\d{5}-\d{3}$/) || parts[i].match(/^[A-Z]{2}$/i))) {
                            if (parts[i-1].length > 2 && isNaN(parseInt(parts[i-1]))) return parts[i-1].trim();
                        }
                        if (parts[i].length > 2 && isNaN(parseInt(parts[i]))) {
                            return parts[i].trim();
                        }
                    }
                }
                return "Sua Cidade";
            };
            const getCidadeFromCliente = (cliente) => {
                if (cliente && cliente.enderecoCliente) {
                    const parts = cliente.enderecoCliente.split(/,\s*|\s+-\s+/);
                    for (let i = parts.length - 1; i >= 0; i--) {
                        if (i > 0 && (parts[i].match(/^\d{5}-\d{3}$/) || parts[i].match(/^[A-Z]{2}$/i))) {
                             if (parts[i-1].length > 2 && isNaN(parseInt(parts[i-1]))) return parts[i-1].trim();
                        }
                        if (parts[i].length > 2 && isNaN(parseInt(parts[i]))) {
                            return parts[i].trim();
                        }
                    }
                }
                return "";
            };
            // ==================================================================
            // 4. LÓGICA DE CRUD E INTEGRAÇÃO
            // ==================================================================
             const savePedido = async () => {
                const form = selectors.pedidoForm;
                if (!form) { console.error("Pedido form not found."); return null; }
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return null;
                }

                const formData = new FormData(form);
                const data = {};
                formData.forEach((v, k) => data[k] = v);
                const isNew = !data.id;
                if (parseFloat(data.valorTotal) <= 0) {
                    alert("O Valor Total deve ser maior que zero.");
                    return null;
                }

                if (isNew) {
                    data.id = generateId('ped');
                    state.pedidos.push(data);
                } else {
                    const index = state.pedidos.findIndex(item => item.id === data.id);
                    if (index !== -1) { state.pedidos[index] = { ...state.pedidos[index], ...data };
                    }
                }

                await saveData('pedidos_v4', state.pedidos);
                await handlePedidoIntegrations(data, isNew);
                displayPedidos();
                return data;
            };
            const handleFormSubmit = async (e, type, formElement, modal, displayFn) => {
                 e.preventDefault();
                if (!formElement) { console.error(`Form element not found for type: ${type}`); return; }
                if (!formElement.checkValidity()) {
                    formElement.reportValidity();
                    return;
                }
                 const formData = new FormData(formElement);
                 const data = {};
                 formData.forEach((v, k) => data[k] = v);
                 const isNew = !data.id;
                if (isNew) {
                    data.id = generateId(type.slice(0, 3));
                    if (type === 'agenda') {
                        data.status = 'pendente';
                        data.obsAgenda = '';
                    }
                    state[type].push(data);
                } else {
                     const index = state[type].findIndex(item => item.id === data.id);
                    if (index !== -1) state[type][index] = { ...state[type][index], ...data };
                }

                 await saveData(`${type}_v4`, state[type]);
                alert(`${type.charAt(0).toUpperCase() + type.slice(1, -1).replace('materiai', 'material')} salvo!`);
                 closeModal(modal);
                 if (displayFn) displayFn();

                 if (type === 'pedidos') await handlePedidoIntegrations(data, isNew);
                 if (type === 'clientes') { populateClientSelect(); checkBirthdays(); }
            };
            const handlePedidoIntegrations = async (pedido, isNew) => {
                const clienteNome = getClientNameById(pedido.clienteId);
                const hoje = new Date().toISOString().split('T')[0];
                const descEvento = `Evento: ${pedido.tipoEvento || 'N/A'} - ${clienteNome}`;
                let agendaEntry = state.agenda.find(a => a.pedidoId === pedido.id);

                if (agendaEntry) {
                    agendaEntry.data = pedido.dataEvento;
                    agendaEntry.horario = pedido.horaInicio;
                    agendaEntry.descricao = descEvento;
                    agendaEntry.cliente = clienteNome;
                    if (pedido.status === 'cancelado' && agendaEntry.status === 'pendente') {
                        agendaEntry.status = 'cancelado';
                    }
                } else if (isNew && pedido.dataEvento && pedido.horaInicio && pedido.status !== 'cancelado') {
                    state.agenda.push({
                        id: generateId('age'),
                        data: pedido.dataEvento,
                        horario: pedido.horaInicio,
                        descricao: descEvento,
                        cliente: clienteNome,
                        pedidoId: pedido.id,
                        status: 'pendente',
                        obsAgenda: ''
                    });
                }
                await saveData('agenda_v4', state.agenda);
                displayAgenda();

                state.financeiro = state.financeiro.filter(f => !(f.pedidoId === pedido.id && f.tipo === 'a_receber'));
                if (pedido.status !== 'cancelado' && parseFloat(pedido.valorTotal) > 0) {
                    const totalPagoExistente = state.financeiro
                        .filter(f => f.pedidoId === pedido.id && f.tipo === 'receita')
                        .reduce((sum, f) => sum + parseFloat(f.valor), 0);

                    const valorPendente = parseFloat(pedido.valorTotal) - totalPagoExistente;
                    if (valorPendente > 0.01) {
                        state.financeiro.push({
                            id: generateId('fin'),
                            data: pedido.dataEvento || hoje,
                            tipo: 'a_receber',
                            descricao: `Pagamento pendente Pedido: ${clienteNome} (#${pedido.id.substring(4, 10)})`,
                            valor: valorPendente,
                            status: 'pendente',
                            pedidoId: pedido.id
                        });
                    }
                }
                await saveData('financeiro_v4', state.financeiro);
                displayFinanceiro();
                checkPendingOrders();
            };


            window.handleDelete = async (type, id) => {
                if (!confirm(`Tem certeza que deseja excluir este item? A ação não poderá ser desfeita.`)) return;
                const itemOriginal = state[type].find(item => item.id === id);

                state[type] = state[type].filter(item => item.id !== id);
                await saveData(`${type}_v4`, state[type]);

                if (type === 'pedidos') {
                    state.agenda = state.agenda.filter(a => a.pedidoId !== id);
                    state.financeiro = state.financeiro.filter(f => f.pedidoId !== id);
                    await saveData('agenda_v4', state.agenda);
                    await saveData('financeiro_v4', state.financeiro);
                    displayAgenda();
                    displayFinanceiro();
                    checkPendingOrders();
                } else if (type === 'clientes') {
                    const pedidosDoCliente = state.pedidos.filter(p => p.clienteId === id);
                    if (pedidosDoCliente.length > 0) {
                        if(!confirm(`Este cliente possui ${pedidosDoCliente.length} pedido(s) associado(s). Esses pedidos ficarão sem cliente vinculado. Deseja continuar?`)){
                            if (itemOriginal) state[type].push(itemOriginal);
                            await saveData('clientes_v4', state[type]);
                            return;
                        }
                        state.pedidos.forEach(p => {
                            if (p.clienteId === id) p.clienteId = null;
                        });
                        await saveData('pedidos_v4', state.pedidos);
                        displayPedidos();
                    }
                    populateClientSelect();
                    checkBirthdays();
                } else if (type === 'financeiro') {
                    if (itemOriginal && itemOriginal.pedidoId && itemOriginal.tipo === 'receita') {
                         const relatedPedido = getPedidoById(itemOriginal.pedidoId);
                        if (relatedPedido && relatedPedido.id) {
                            await handlePedidoIntegrations(relatedPedido, false);
                        }
                    }
                    displayFinanceiro();
                    displayPedidos();
                } else if (type === 'users') {
                    if (state.users.length > 1) {
                        if(state.users.filter(u => u.id !== id).length === 0) {
                            alert("Não é possível excluir o último usuário. Crie outro usuário administrador primeiro.");
                            if (itemOriginal) state[type].push(itemOriginal);
                            await saveData('users_v4', state[type]);
                            displayUsers();
                            return;
                        }
                    } else {
                        alert("Não é possível excluir o único usuário do sistema.");
                        return;
                    }
                }


                const displayFnName = `display${type.charAt(0).toUpperCase() + type.slice(1).replace('materiaisEstoque', 'MateriaisEstoque')}`;
                if (typeof window[displayFnName] === 'function') window[displayFnName]();
                else if (type === 'pedidos') displayPedidos();
                else if (type === 'clientes') displayClientes();
                else if (type === 'agenda') displayAgenda();
                else if (type === 'materiais') displayMateriaisEstoque();
                else if (type === 'servicos') displayServicos();
                else if (type === 'financeiro') displayFinanceiro();
                else if (type === 'users') displayUsers();
            };
            window.openPagamentoModal = (pedidoId, financeiroIdAReceber = null) => {
                const form = selectors.pagamentoForm;
                if (!form || !selectors.pagamentoModal) { console.error("Pagamento form or modal not found."); return; }
                form.reset();
                if (form.querySelector('[name="pedidoId"]')) form.querySelector('[name="pedidoId"]').value = pedidoId;
                if (form.querySelector('[name="financeiroId"]')) form.querySelector('[name="financeiroId"]').value = financeiroIdAReceber || '';
                if (form.querySelector('[name="data"]')) form.querySelector('[name="data"]').value = new Date().toISOString().split('T')[0];

                const pedido = getPedidoById(pedidoId);
                if (pedido && pedido.id) {
                    const clienteNome = getClientNameById(pedido.clienteId);
                    if (form.querySelector('[name="descricao"]')) form.querySelector('[name="descricao"]').value = `Pagamento ref. Pedido #${pedido.id.substring(4,10)} (${pedido.tipoEvento || 'Evento'}) - ${clienteNome}`;
                    const totalPagoExistente = state.financeiro
                        .filter(f => f.pedidoId === pedido.id && f.tipo === 'receita')
                        .reduce((sum, f) => sum + parseFloat(f.valor), 0);
                    const valorPendente = parseFloat(pedido.valorTotal) - totalPagoExistente;
                    const valorInput = form.querySelector('[name="valor"]');
                    if (valorInput) {
                        valorInput.value = valorPendente > 0.01 ? valorPendente.toFixed(2) : '';
                        valorInput.max = valorPendente > 0.01 ? valorPendente.toFixed(2) : null;
                    }
                } else {
                    if (form.querySelector('[name="descricao"]')) form.querySelector('[name="descricao"]').value = `Pagamento Recebido Avulso`;
                    const valorInput = form.querySelector('[name="valor"]');
                    if (valorInput) {
                        valorInput.value = '';
                        valorInput.removeAttribute('max');
                    }
                }
                selectors.pagamentoModal.style.display = 'flex';
            };

            // ==================================================================
            // 5. FUNÇÕES DE DISPLAY
            // ==================================================================
            const createButton = (className, icon, title, onclickFn, extraClass = '') => {
                const button = document.createElement('button');
                button.className = `btn btn-small ${className} ${extraClass}`;
                button.title = title;
                button.innerHTML = `<i class="fas ${icon}"></i>`;
                button.onclick = onclickFn;
                return button;
            };
            const filterAndDisplay = (dataArray, tableBodyId, searchInputId, columnsToSearch, displayFunction, currentFilter = null) => {
                const searchTerm = selectors[searchInputId] ? selectors[searchInputId].value.toLowerCase() : "";
                const body = document.getElementById(tableBodyId);
                if (!body) {
                    console.error(`Elemento com ID ${tableBodyId} não encontrado para display.`);
                    return;
                }
                body.innerHTML = '';
                // >>> MODIFICAÇÃO INÍCIO - Variáveis de total <<<
                let totalValorFiltradoPedidos = 0; // Para a aba de Pedidos (já existente)
                let totalValorFinanceiroFiltrado = 0; // NOVO: Para a aba Financeiro
                // >>> MODIFICAÇÃO FIM <<<

                const filteredData = dataArray.filter(item => {
                    let matchesSearch = true;
                    if (searchTerm) {
                        matchesSearch = columnsToSearch.some(col => {
                            if (col === 'clienteNome') {
                                const clientName = getClientNameById(item.clienteId).toLowerCase();
                                return clientName.includes(searchTerm);
                            }
                            if ((col === 'dataEvento' || col === 'data' || col === 'aniversario') && item[col]) {
                                return formatDate(item[col]).toLowerCase().includes(searchTerm);
                            }
                            return item[col] && String(item[col]).toLowerCase().includes(searchTerm);
                        });
                    }

                    let matchesFilter = true;
                    if (currentFilter && currentFilter !== 'todos') {
                        if (tableBodyId === 'pedidos-table-body') {
                            if (currentFilter === 'sinal_pendente') { // Lógica para o novo filtro "Sinal Pendente"
                                const today = new Date();
                                today.setHours(0, 0, 0, 0);

                                const eventDate = new Date(`${item.dataEvento}T00:00:00`);
                                eventDate.setHours(0, 0, 0, 0);

                                const valorTotal = parseFloat(item.valorTotal) || 0;
                                const totalPagoNoPedido = state.financeiro
                                    .filter(f => f.pedidoId === item.id && f.tipo === 'receita')
                                    .reduce((sum, f) => sum + parseFloat(f.valor), 0);

                                matchesFilter = item.status === 'pendente' &&
                                                eventDate <= today &&
                                                totalPagoNoPedido < (valorTotal * 0.5);
                            } else if (currentFilter === 'nao_pagos') { // NOVO FILTRO: Pedidos Não Pagos
                                // >>> MODIFICAÇÃO INÍCIO <<<
                                const valorTotalPedido = parseFloat(item.valorTotal) || 0;
                                const totalPagoNoPedido = state.financeiro
                                    .filter(f => f.pedidoId === item.id && f.tipo === 'receita')
                                    .reduce((sum, f) => sum + parseFloat(f.valor), 0);

                                // Pedido é 'não pago' se não for cancelado E valor total > 0 e nada foi pago (ou valor muito pequeno)
                                matchesFilter = item.status !== 'cancelado' && valorTotalPedido > 0.01 && totalPagoNoPedido <= 0.01;
                                // >>> MODIFICAÇÃO FIM <<<

                            } else {
                                matchesFilter = item.status === currentFilter;
                            }
                        } else if (tableBodyId === 'financeiro-table-body') {
                            if (currentFilter === 'a_receber') {
                                if (item.tipo !== 'a_receber') return false;
                                const pedido = getPedidoById(item.pedidoId);
                                if (pedido && pedido.id) {
                                    const totalRecebidoParaEstePedido = state.financeiro
                                        .filter(i => i.pedidoId === pedido.id && i.tipo === 'receita')
                                        .reduce((sum, i) => sum + parseFloat(i.valor), 0);
                                    if (parseFloat(pedido.valorTotal) - totalRecebidoParaEstePedido <= 0.01) {
                                        return false;
                                    }
                                }
                                matchesFilter = true;
                            } else {
                                matchesFilter = item.tipo === currentFilter;
                            }
                        }
                    }
                    // >>> MODIFICAÇÃO INÍCIO - Cálculo dos totais <<<
                    // Lógica para somar o valor dos pedidos exibidos no filtro atual
                    if (matchesSearch && matchesFilter) {
                         if (tableBodyId === 'pedidos-table-body' && item.status !== 'cancelado') {
                            const valorDoPedido = parseFloat(item.valorTotal) || 0;

                            // Se o filtro é "Não Pagos", somamos apenas os que realmente estão não pagos.
                            // Para outros filtros, somamos o valor total do pedido.
                            if (currentFilter === 'nao_pagos') {
                                const totalPagoNoPedido = state.financeiro
                                    .filter(f => f.pedidoId === item.id && f.tipo === 'receita')
                                    .reduce((sum, f) => sum + parseFloat(f.valor), 0);
                                if (valorDoPedido > 0.01 && totalPagoNoPedido <= 0.01) {
                                    totalValorFiltradoPedidos += valorDoPedido;
                                }
                            } else {
                                totalValorFiltradoPedidos += valorDoPedido;
                            }
                        } else if (tableBodyId === 'financeiro-table-body') {
                            totalValorFinanceiroFiltrado += parseFloat(item.valor) || 0;
                        }
                    }
                    // >>> MODIFICAÇÃO FIM <<<
                    return matchesSearch && matchesFilter;
                }).sort((a,b) => {
                    if (a.dataEvento && b.dataEvento) return new Date(b.dataEvento) - new Date(a.dataEvento);
                    if (a.data && b.data) return new Date(b.data) - new Date(a.data);
                    if (a.nome && b.nome) return a.nome.localeCompare(b.nome);
                    return 0;
                });
                if (filteredData.length === 0) {
                    const colspan = body.closest('table')?.querySelector('thead tr')?.children.length || 5;
                    body.innerHTML = `<tr><td colspan="${colspan}" style="text-align: center;">Nenhum item encontrado.</td></tr>`;
                    // >>> MODIFICAÇÃO INÍCIO - Oculta os totais se não houver dados <<<
                    if (selectors.totalNaoPagosDisplay) {
                        selectors.totalNaoPagosDisplay.style.display = 'none';
                    }
                    if (selectors.totalFinanceiroFiltradoDisplay) {
                        selectors.totalFinanceiroFiltradoDisplay.style.display = 'none';
                    }
                    // >>> MODIFICAÇÃO FIM <<<
                    return;
                }

                // >>> MODIFICAÇÃO INÍCIO - Exibe os totais filtrados <<<
                // Exibe o total dos pedidos filtrados
                if (selectors.totalNaoPagosDisplay && tableBodyId === 'pedidos-table-body') {
                    let displayText = '';
                    if (currentFilter === 'nao_pagos') {
                        displayText = `Total de Pedidos Não Pagos: ${formatCurrency(totalValorFiltradoPedidos)}`;
                    } else if (currentFilter === 'pendente') {
                         displayText = `Total de Pedidos Pendentes (Valor Total): ${formatCurrency(totalValorFiltradoPedidos)}`;
                    } else if (currentFilter === 'concluido') {
                         displayText = `Total de Pedidos Concluídos (Valor Total): ${formatCurrency(totalValorFiltradoPedidos)}`;
                    } else if (currentFilter === 'cancelado') {
                         // Para pedidos cancelados, podemos manter a soma se desejado,
                         // mas é importante notar que a soma total filtrada já excluiu cancelados por design na minha lógica anterior.
                         // Se quiser incluir os valores de cancelados nesta soma, a lógica de `totalValorFiltrado` precisaria ser ajustada.
                         // Por enquanto, ele exibirá a soma dos 'não cancelados' que passam pelo filtro 'cancelado' (o que será 0, pois eles não passariam)
                         // Para mostrar o total de TODOS os pedidos CANCELADOS, independentemente de estarem pagos ou não,
                         // você pode recalcular aqui ou ajustar a `totalValorFiltrado` para não excluir os cancelados na etapa de filtragem.
                         // Para manter a coerência com "desconsiderar pedidos cancelados" na soma geral, vamos apenas mostrar o texto "Total de Pedidos Cancelados".
                         displayText = `Total de Pedidos Cancelados: ${formatCurrency(totalValorFiltradoPedidos)}`; // totalValorFiltrado para este filtro será 0
                    } else if (currentFilter === 'todos') {
                        displayText = `Total Geral de Pedidos: ${formatCurrency(totalValorFiltradoPedidos)}`;
                    } else if (currentFilter === 'sinal_pendente') {
                        displayText = `Total de Sinal Pendente: ${formatCurrency(totalValorFiltradoPedidos)}`;
                    }

                    if (displayText) {
                         selectors.totalNaoPagosDisplay.textContent = displayText;
                         selectors.totalNaoPagosDisplay.style.display = 'block';
                         // Ajusta a cor de fundo para ser mais informativa
                         if (currentFilter === 'nao_pagos' || currentFilter === 'sinal_pendente' || currentFilter === 'cancelado') {
                            selectors.totalNaoPagosDisplay.style.backgroundColor = 'var(--danger-color)'; // Vermelho para alerta/cancelado
                         } else {
                            selectors.totalNaoPagosDisplay.style.backgroundColor = 'var(--primary-color)'; // Cor padrão do sistema
                         }
                    } else {
                         selectors.totalNaoPagosDisplay.style.display = 'none';
                    }
                } else if (selectors.totalNaoPagosDisplay) { // Garante que esteja oculto se não for a aba de pedidos
                    selectors.totalNaoPagosDisplay.style.display = 'none';
                }

                // NOVO: Exibe o total financeiro filtrado
                if (selectors.totalFinanceiroFiltradoDisplay && selectors.valorTotalFinanceiroFiltrado && tableBodyId === 'financeiro-table-body') {
                    selectors.valorTotalFinanceiroFiltrado.textContent = formatCurrency(totalValorFinanceiroFiltrado);
                    selectors.totalFinanceiroFiltradoDisplay.style.display = 'block';
                } else if (selectors.totalFinanceiroFiltradoDisplay) {
                    selectors.totalFinanceiroFiltradoDisplay.style.display = 'none';
                }
                // >>> MODIFICAÇÃO FIM <<<

                if (typeof window[displayFunction] === 'function' && displayFunction.startsWith('render')) {
                     window[displayFunction](filteredData, body);
                } else {
                    console.warn(`Função de renderização ${displayFunction} não encontrada ou não segue o padrão 'renderXYZ'.`);
                }
            };
            window.renderPedidosRows = (pedidos, tbody) => {
                pedidos.forEach(p => {
                    const row = tbody.insertRow(); row.dataset.id = p.id;
                    const status = p.status || 'pendente';
                    const clienteNome = getClientNameById(p.clienteId);

                    const totalRecebidoParaEstePedido = state.financeiro
                        .filter(f => f.pedidoId === p.id && f.tipo === 'receita')
                        .reduce((sum, f) => sum + parseFloat(f.valor), 0);

                    const valorTotalPedido = parseFloat(p.valorTotal) || 0;
                    const pendente = valorTotalPedido - totalRecebidoParaEstePedido;
                    const hoje = new Date();
                    hoje.setHours(0,0,0,0);
                    const dataEventoObj = new Date(`${p.dataEvento}T00:00:00`);
                    dataEventoObj.setHours(0,0,0,0);


                    let statusDisplay = status.charAt(0).toUpperCase() + status.slice(1);
                    let statusClass = status;

                    if (status === 'pendente') {
                        if (pendente <= 0.01) { // Pedido pendente, mas tudo pago (talvez esqueceram de mudar status)
                            statusDisplay = `Quase Concluído/Pago`;
                            statusClass = 'concluido';
                        } else if (dataEventoObj <= hoje && totalRecebidoParaEstePedido < (valorTotalPedido * 0.5)) {
                            statusDisplay = `Sinal Pendente`;
                            statusClass = 'danger-color'; /* Usa a cor de perigo para destacar */
                        } else if (pendente > 0.01) {
                            statusDisplay = `A Receber`;
                            statusClass = 'a_receber';
                        }
                    } else if (status === 'concluido') {
                        statusDisplay = `Concluído`;
                        statusClass = 'concluido';
                    } else if (status === 'cancelado') {
                        statusDisplay = 'Cancelado';
                        statusClass = 'cancelado';
                    }

                    row.insertCell().textContent = p.id ? p.id.substring(4, 10) : 'ERRO';
                    row.insertCell().textContent = clienteNome;
                    row.insertCell().textContent = p.tipoEvento || 'N/A';
                    row.insertCell().textContent = formatDate(p.dataEvento);
                    const statusCell = row.insertCell();
                    statusCell.textContent = statusDisplay;
                    statusCell.className = statusClass; // Aplica a classe diretamente
                    row.insertCell().textContent = formatCurrency(p.valorTotal);
                    row.insertCell().textContent = `${formatCurrency(totalRecebidoParaEstePedido)} (${pendente > 0.01 && status !== 'cancelado' ? `Falta ${formatCurrency(pendente)}` : (status !== 'cancelado' ? 'OK' : '-')})`;
                    const actionsCell = row.insertCell();
                    actionsCell.appendChild(createButton('btn-edit', 'fa-edit', 'Editar Pedido', () => openPedidoModal(p.id)));
                    actionsCell.appendChild(createButton('btn-contract', 'fa-file-signature', 'Gerar Contrato', () => generateContract(p.id)));
                    if (pendente > 0.01 && status !== 'cancelado') {
                         actionsCell.appendChild(createButton('btn-receipt', 'fa-hand-holding-usd', 'Lançar Pagamento', () => openPagamentoModal(p.id)));
                    }
                    actionsCell.appendChild(createButton('btn-danger', 'fa-trash', 'Excluir Pedido', () => handleDelete('pedidos', p.id)));
                });
            };
            window.displayPedidos = () => {
                filterAndDisplay(state.pedidos, 'pedidos-table-body', 'searchPedidos', ['id', 'tipoEvento', 'clienteNome', 'status', 'valorTotal', 'dataEvento'], 'renderPedidosRows', state.currentFilter);
            };

            window.renderClientesRows = (clientes, tbody) => {
                clientes.forEach(c => {
                    const row = tbody.insertRow(); row.dataset.id = c.id;
                    row.insertCell().textContent = c.nome || 'N/A';
                    row.insertCell().textContent = c.contato || 'N/A';
                    row.insertCell().textContent = formatDate(c.aniversario);
                    row.insertCell().textContent = c.obs || '';
                    const actionsCell = row.insertCell();
                    actionsCell.appendChild(createButton('btn-edit', 'fa-edit', 'Editar Cliente', () => openClientModal(c.id)));
                    actionsCell.appendChild(createButton('btn-danger', 'fa-trash', 'Excluir Cliente', () => handleDelete('clientes', c.id)));
                });
            };
            window.displayClientes = () => {
                filterAndDisplay(state.clientes, 'clientes-table-body', 'searchClientes', ['nome', 'contato', 'emailCliente', 'aniversario', 'enderecoCliente', 'obs'], 'renderClientesRows');
            };

            window.renderAgendaListRows = (agendaItems, tbody) => {
                agendaItems.forEach(a => {
                    const row = tbody.insertRow(); row.dataset.id = a.id;
                    const statusClass = a.status || 'pendente';
                    row.insertCell().textContent = formatDate(a.data);
                    row.insertCell().textContent = a.horario || 'N/A';
                    row.insertCell().textContent = a.descricao || 'N/A';
                    row.insertCell().textContent = a.cliente || (a.pedidoId ? getClientNameById(getPedidoById(a.pedidoId)?.clienteId) : 'N/A');
                    const statusCell = row.insertCell();
                    statusCell.textContent = statusClass.charAt(0).toUpperCase() + statusClass.slice(1);
                    statusCell.className = statusClass;
                    const actionsCell = row.insertCell();
                    actionsCell.appendChild(createButton('btn-info', 'fa-eye', 'Visualizar Detalhes', () => openAgendaDetailsModal(a.id)));
                    actionsCell.appendChild(createButton('btn-edit', 'fa-edit', 'Editar Compromisso', () => openAddAgendaModal(a.id)));
                    actionsCell.appendChild(createButton('btn-danger', 'fa-trash', 'Excluir Compromisso', () => handleDelete('agenda', a.id)));
                });
            };
            window.displayAgenda = () => {
                if (selectors.agendaListView && selectors.agendaCalendarView && selectors.searchAgendaContainerList && selectors.btnViewList && selectors.btnViewCalendar) {
                    if (state.agendaView === 'list') {
                        selectors.agendaListView.style.display = 'block';
                        selectors.agendaCalendarView.style.display = 'none';
                        selectors.searchAgendaContainerList.style.display = 'flex';
                        selectors.btnViewList.classList.add('active');
                        selectors.btnViewCalendar.classList.remove('active');
                        filterAndDisplay(state.agenda, 'agenda-table-body', 'searchAgenda', ['data', 'horario', 'descricao', 'cliente', 'status', 'obsAgenda'], 'renderAgendaListRows');
                    } else {
                        selectors.agendaListView.style.display = 'none';
                        selectors.searchAgendaContainerList.style.display = 'none';
                        selectors.agendaCalendarView.style.display = 'block';
                        selectors.btnViewList.classList.remove('active');
                        selectors.btnViewCalendar.classList.add('active');
                        renderCalendar();
                    }
                } else {
                    console.error("Elementos da view da agenda (list/calendar/search/toggle buttons) não encontrados.");
                }
            };
            window.renderMateriaisEstoqueRows = (materiais, tbody) => {
                 materiais.forEach(m => {
                    const row = tbody.insertRow(); row.dataset.id = m.id;
                    row.insertCell().textContent = m.item || 'N/A';
                    row.insertCell().textContent = m.quantidade || '0';
                    row.insertCell().textContent = m.obs || '';
                    const actionsCell = row.insertCell();
                    actionsCell.appendChild(createButton('btn-edit', 'fa-edit', 'Editar Material', () => openMaterialModal(m.id)));
                    actionsCell.appendChild(createButton('btn-danger', 'fa-trash', 'Excluir Material', () => handleDelete('materiais', m.id)));
                });
            };
            window.displayMateriaisEstoque = () => {
                 filterAndDisplay(state.materiais, 'materiais-table-body', 'searchMateriais', ['item', 'quantidade', 'obs'], 'renderMateriaisEstoqueRows');
            };

            window.renderServicosRows = (servicos, tbody) => {
                servicos.forEach(s => {
                    const row = tbody.insertRow(); row.dataset.id = s.id;
                    row.insertCell().textContent = s.nome || 'N/A';
                    row.insertCell().textContent = s.descricao || '';
                    row.insertCell().textContent = formatCurrency(s.valor);
                    const actionsCell = row.insertCell();
                    actionsCell.appendChild(createButton('btn-edit', 'fa-edit', 'Editar Serviço', () => openServicoModal(s.id)));
                    actionsCell.appendChild(createButton('btn-danger', 'fa-trash', 'Excluir Serviço', () => handleDelete('servicos', s.id)));
                });
            };
            window.displayServicos = () => {
                filterAndDisplay(state.servicos, 'servicos-table-body', 'searchServicos', ['nome', 'descricao', 'valor'], 'renderServicosRows');
            };

            window.renderFinanceiroTableRows = (financeiroItens, tbody) => {
                financeiroItens.sort((a, b) => {
                    const dateA = new Date(a.data);
                    const dateB = new Date(b.data);
                    if (dateA.getTime() === dateB.getTime()) {
                        if (a.tipo === 'a_receber' && b.tipo !== 'a_receber') return -1;
                        if (a.tipo !== 'a_receber' && b.tipo === 'a_receber') return 1;
                        return 0;
                    }
                    return dateB - dateA;
                }).forEach(f => {
                    const row = tbody.insertRow(); row.dataset.id = f.id;
                    const valor = parseFloat(f.valor) || 0;
                    const tipo = f.tipo || 'N/A';
                    let statusText = f.status || (tipo === 'despesa' ? 'Pago' : 'Pendente');
                    let actionsCell = row.insertCell();
                    let displayClass = tipo;

                    if (tipo === 'a_receber') {
                        const pedido = getPedidoById(f.pedidoId);
                        if (pedido && pedido.id) {
                             const totalRecebidoParaEstePedido = state.financeiro
                                .filter(item => item.pedidoId === pedido.id && item.tipo === 'receita')
                                .reduce((sum, item) => sum + parseFloat(item.valor), 0);
                            const valorPendenteReal = parseFloat(pedido.valorTotal) - totalRecebidoParaEstePedido;

                            if (valorPendenteReal <= 0.01 || pedido.status === 'cancelado' || pedido.status === 'concluido') {
                                if (state.financeFilter === 'a_receber') {
                                    row.style.display = 'none';
                                    return;
                                }
                                statusText = (pedido.status === 'cancelado') ? 'Cancelado' : 'Pago (Pedido)';
                                displayClass = (pedido.status === 'cancelado') ? 'cancelado' : 'concluido';
                            } else {
                                statusText = 'Pendente';
                                displayClass = 'a_receber';
                                actionsCell.appendChild(createButton('btn-success', 'fa-hand-holding-usd', 'Lançar Pagamento', () => openPagamentoModal(f.pedidoId, f.id)));
                            }
                        } else {
                             statusText = 'Pendente (Avulso)';
                            displayClass = 'a_receber';
                        }
                    } else if (tipo === 'receita') {
                        statusText = 'Receita Efetuada';
                        displayClass = 'receita';
                        actionsCell.appendChild(createButton('btn-receipt', 'fa-file-invoice', 'Gerar Recibo', () => generateReceiptPDF(f)));
                    } else if (tipo === 'despesa') {
                        statusText = 'Despesa Efetuada';
                        displayClass = 'despesa';
                    }

                    actionsCell.appendChild(createButton('btn-danger', 'fa-trash', 'Excluir Lançamento', () => handleDelete('financeiro', f.id)));
                    row.insertCell().textContent = formatDate(f.data);
                    const tipoCell = row.insertCell();
                    tipoCell.textContent = tipo.replace('_',' ').charAt(0).toUpperCase() + tipo.replace('_',' ').slice(1);
                    tipoCell.className = displayClass;
                    row.insertCell().textContent = f.descricao || 'N/A';
                    row.insertCell().textContent = formatCurrency(valor);
                    row.insertCell().textContent = f.pedidoId ? `Ref. Pedido #${f.pedidoId.substring(4,10)}` : statusText;
                    row.appendChild(actionsCell);
                });
            };
            window.displayFinanceiro = () => {
                let totalAReceberCalculado = 0, totalRecebido = 0, totalDespesas = 0;
                const hoje = new Date().toISOString().split('T')[0];

                state.pedidos.forEach(pedido => {
                    if (pedido.status === 'pendente') {
                        const valorTotalPedido = parseFloat(pedido.valorTotal) || 0;
                        const pagoNestePedido = state.financeiro
                            .filter(f => f.pedidoId === pedido.id && f.tipo === 'receita')
                            .reduce((sum, f) => sum + parseFloat(f.valor), 0);
                        const pendenteNestePedido = valorTotalPedido - pagoNestePedido;
                        if (pendenteNestePedido > 0.01) {
                            totalAReceberCalculado += pendenteNestePedido;
                        }
                    }
                });
                state.financeiro.forEach(f => {
                    const valor = parseFloat(f.valor) || 0;
                    if (f.tipo === 'receita') totalRecebido += valor;
                    else if (f.tipo === 'despesa') totalDespesas += valor;
                });

                if (selectors.totalAReceber) selectors.totalAReceber.textContent = formatCurrency(totalAReceberCalculado);
                if (selectors.totalRecebido) selectors.totalRecebido.textContent = formatCurrency(totalRecebido);
                if (selectors.totalDespesasFin) selectors.totalDespesasFin.textContent = formatCurrency(totalDespesas);
                if (selectors.saldoAtual) selectors.saldoAtual.textContent = formatCurrency(totalRecebido - totalDespesas);

                calculateFinancialForecast();
                calculateMonthlyBalance();
                calculateAnnualBalance();

                renderMonthlyRevenueChart();
                renderRevenueExpenseChart();

                const preFilteredFinanceiro = state.financeiro.filter(f => {
                    const typeMatch = state.financeFilter === 'todos' || f.tipo === state.financeFilter || (state.financeFilter === 'a_receber' && f.tipo === 'a_receber');
                    const startDate = selectors.financeStartDate ? selectors.financeStartDate.value : null;
                    const endDate = selectors.financeEndDate ? selectors.financeEndDate.value : null;
                    let dateMatch = true;
                    if (startDate && endDate) {
                        dateMatch = f.data >= startDate && f.data <= endDate;
                    } else if (startDate) {
                        dateMatch = f.data >= startDate;
                    } else if (endDate) {
                        dateMatch = f.data <= endDate;
                    }

                    if (f.tipo === 'a_receber' && state.financeFilter !== 'todos') {
                        const pedido = getPedidoById(f.pedidoId);
                        if (pedido && pedido.id) {
                            const totalPagoParaEstePedido = state.financeiro
                                .filter(item => item.pedidoId === pedido.id && item.tipo === 'receita')
                                .reduce((sum, item) => sum + parseFloat(item.valor), 0);
                            if (parseFloat(pedido.valorTotal) - totalPagoParaEstePedido <= 0.01) {
                                return false;
                            }
                        }
                    }
                    return typeMatch && dateMatch;
                });
                filterAndDisplay(preFilteredFinanceiro, 'financeiro-table-body', 'searchFinanceiro', ['data', 'tipo', 'descricao', 'status', 'pedidoId', 'valor'], 'renderFinanceiroTableRows', state.financeFilter);
            };
            const calculateFinancialForecast = () => {
                const hoje = new Date().toISOString().split('T')[0];
                let previstoAReceber = 0;
                let previstoAPagarDespesasFuturas = 0;

                state.pedidos.forEach(pedido => {
                    if (pedido.status === 'pendente' && pedido.dataEvento >= hoje) {
                        const valorTotalPedido = parseFloat(pedido.valorTotal) || 0;
                        const totalPagoParaEstePedido = state.financeiro
                            .filter(f => f.pedidoId === pedido.id && f.tipo === 'receita')
                            .reduce((sum, f) => sum + parseFloat(f.valor), 0);
                        const pendenteReal = valorTotalPedido - totalPagoParaEstePedido;
                        if (pendenteReal > 0.01) {
                            previstoAReceber += pendenteReal;
                        }
                    }
                });
                state.financeiro.filter(f => f.tipo === 'despesa' && f.data >= hoje)
                    .forEach(f => {
                        previstoAPagarDespesasFuturas += parseFloat(f.valor) || 0;
                    });
                if (selectors.previstoAReceber) selectors.previstoAReceber.textContent = formatCurrency(previstoAReceber);
                if (selectors.previstoAPagar) selectors.previstoAPagar.textContent = formatCurrency(previstoAPagarDespesasFuturas);
                const saldoProjetadoValor = previstoAReceber - previstoAPagarDespesasFuturas;
                if (selectors.saldoProjetado) {
                    selectors.saldoProjetado.textContent = formatCurrency(saldoProjetadoValor);
                    selectors.saldoProjetado.classList.remove('positive', 'negative', 'neutral');
                    if (saldoProjetadoValor > 0) selectors.saldoProjetado.classList.add('positive');
                    else if (saldoProjetadoValor < 0) selectors.saldoProjetado.classList.add('negative');
                    else selectors.saldoProjetado.classList.add('neutral');
                }
            };
            const calculateMonthlyBalance = () => {
                const monthlyData = {};
                const body = selectors.monthlyBalanceBody;
                if (!body) return;
                body.innerHTML = '';
                state.financeiro.forEach(f => {
                    if (!f.data) return;
                    const monthYear = f.data.substring(0, 7);
                    if (!monthlyData[monthYear]) {
                        monthlyData[monthYear] = { receitas: 0, despesas: 0 };
                    }
                    if (f.tipo === 'receita') {
                        monthlyData[monthYear].receitas += parseFloat(f.valor) || 0;
                    } else if (f.tipo === 'despesa') {
                        monthlyData[monthYear].despesas += parseFloat(f.valor) || 0;
                    }
                });
                const sortedMonths = Object.keys(monthlyData).sort((a,b) => b.localeCompare(a));


                if (sortedMonths.length === 0) {
                    body.innerHTML = `<tr><td colspan="4" style="text-align: center;">Nenhum dado para o balanço mensal.</td></tr>`;
                    return;
                }

                sortedMonths.forEach(monthYear => {
                    const data = monthlyData[monthYear];
                    const saldo = data.receitas - data.despesas;

                    const row = body.insertRow();
                    row.innerHTML = `
                        <td>${formatMonthYear(`${monthYear}-01`)}</td>
                        <td class="positive">${formatCurrency(data.receitas)}</td>
                        <td class="negative">${formatCurrency(data.despesas)}</td>
                        <td class="${saldo >= 0 ? 'positive' : 'negative'}">${formatCurrency(saldo)}</td>
                    `;
                });
            };
            const calculateAnnualBalance = () => {
                const annualData = {};
                const body = selectors.annualBalanceBody;
                const footer = selectors.annualBalanceFooter;
                if (!body || !footer) return;
                body.innerHTML = '';
                footer.innerHTML = '';
                state.financeiro.forEach(f => {
                    if (!f.data) return;
                    const year = f.data.substring(0, 4);
                    if (!annualData[year]) {
                        annualData[year] = { receitas: 0, despesas: 0 };
                    }
                    if (f.tipo === 'receita') {
                        annualData[year].receitas += parseFloat(f.valor) || 0;
                    } else if (f.tipo === 'despesa') {
                        annualData[year].despesas += parseFloat(f.valor) || 0;
                    }
                });
                const sortedYears = Object.keys(annualData).sort((a,b) => b.localeCompare(a));

                let totalReceitasGeralAnual = 0;
                let totalDespesasGeralAnual = 0;
                if (sortedYears.length === 0) {
                    body.innerHTML = `<tr><td colspan="4" style="text-align: center;">Nenhum dado para o balanço anual.</td></tr>`;
                    return;
                }

                sortedYears.forEach(year => {
                    const data = annualData[year];
                    const saldo = data.receitas - data.despesas;
                    totalReceitasGeralAnual += data.receitas;
                    totalDespesasGeralAnual += data.despesas;

                    const row = body.insertRow();
                    row.innerHTML = `
                        <td>${year}</td>
                        <td class="positive">${formatCurrency(data.receitas)}</td>
                        <td class="negative">${formatCurrency(data.despesas)}</td>
                        <td class="${saldo >= 0 ? 'positive' : 'negative'}">${formatCurrency(saldo)}</td>
                    `;
                });
                const totalRowAnual = footer.insertRow();
                const saldoFinalGeralAnual = totalReceitasGeralAnual - totalDespesasGeralAnual;
                totalRowAnual.innerHTML = `
                    <td><strong>Total Geral:</strong></td>
                    <td class="positive"><strong>${formatCurrency(totalReceitasGeralAnual)}</strong></td>
                    <td class="negative"><strong>${formatCurrency(totalDespesasGeralAnual)}</strong></td>
                    <td class="${saldoFinalGeralAnual >= 0 ? 'positive' : 'negative'}"><strong>${formatCurrency(saldoFinalGeralAnual)}</strong></td>
                `;
            };
            const populateClientSelect = () => {
                const select = selectors.pedidoClienteSelect;
                if (!select) { console.warn("Pedido client select element not found."); return; }
                const currentVal = select.value;
                select.innerHTML = '<option value="">Selecione um cliente...</option>';
                state.clientes.sort((a,b) => (a.nome || '').localeCompare(b.nome || '')).forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.nome;
                    select.appendChild(option);
                });
                if (state.clientes.find(c => c.id === currentVal)) {
                    select.value = currentVal;
                }
            };
            const displayConfig = () => {
                const config = state.configuracoes;
                const form = selectors.configForm;
                if (!form) { console.error("Config form not found."); return; }
                if (config.empresa) {
                    Object.keys(config.empresa).forEach(key => {
                        const input = form.querySelector(`[name="${key}"]`);
                        if (input) input.value = config.empresa[key];
                    });
                }
                if (selectors.logoPreview && selectors.btnRemoveLogo) {
                    if (config.logo) {
                        selectors.logoPreview.src = config.logo;
                        selectors.logoPreview.style.display = 'block';
                        selectors.btnRemoveLogo.style.display = 'inline-block';
                    } else {
                        selectors.logoPreview.src = '#';
                        selectors.logoPreview.style.display = 'none';
                        selectors.btnRemoveLogo.style.display = 'none';
                    }
                }
                displayUsers();
            };
            const handleDismissBirthdayAlert = (clientId, anniversaryDateISO, listItemElement) => {
                let dismissedAlerts = JSON.parse(localStorage.getItem('dismissedBirthdayAlerts')) || {};
                const dismissKey = `client_${clientId}_anniversary_${anniversaryDateISO}`;

                dismissedAlerts[dismissKey] = true;
                localStorage.setItem('dismissedBirthdayAlerts', JSON.stringify(dismissedAlerts));

                if (listItemElement) {
                    listItemElement.remove();
                }

                const birthdayListElement = selectors.birthdayList;
                if (birthdayListElement && birthdayListElement.children.length === 0) {
                    const birthdayAlertsSection = selectors.birthdayAlerts;
                    if (birthdayAlertsSection) {
                        birthdayAlertsSection.style.display = 'none';
                    }
                }
            };
            const checkBirthdays = () => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const upcoming = [];
                const checkDays = 90;

                let dismissedAlerts = JSON.parse(localStorage.getItem('dismissedBirthdayAlerts')) || {};

                state.clientes.forEach(client => {
                    if (!client.aniversario || client.aniversario.trim() === "") return;

                    const birthDateParts = client.aniversario.split('-');
                    let currentYearBirthDate = new Date(today.getFullYear(), parseInt(birthDateParts[1]) - 1, parseInt(birthDateParts[2]));
                    currentYearBirthDate.setHours(0, 0, 0, 0);

                    if (currentYearBirthDate.getTime() < today.getTime()) {
                        currentYearBirthDate.setFullYear(today.getFullYear() + 1);
                    }

                    const diffTime = currentYearBirthDate.getTime() - today.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    const currentAnniversaryISO = currentYearBirthDate.toISOString().split('T')[0];
                    const dismissKey = `client_${client.id}_anniversary_${currentAnniversaryISO}`;

                    if (dismissedAlerts[dismissKey] && diffDays < 0) {
                        delete dismissedAlerts[dismissKey];
                        localStorage.setItem('dismissedBirthdayAlerts', JSON.stringify(dismissedAlerts));
                    }

                    if (dismissedAlerts[dismissKey]) {
                        return;
                    }

                    if (diffDays >= 0 && diffDays <= checkDays) {
                        const lastEvent = state.pedidos
                            .filter(p => p.clienteId === client.id && p.status === 'concluido' && p.dataEvento)
                            .sort((a, b) => new Date(b.dataEvento) - new Date(a.dataEvento))
                            .shift();
                        let eventInfo = '';
                        if (lastEvent) {
                            eventInfo = ` (último evento: ${formatDate(lastEvent.dataEvento)})`;
                        }
                        upcoming.push({
                            id: client.id,
                            name: client.nome,
                            date: formatDate(client.aniversario),
                            daysLeft: diffDays,
                            eventInfo: eventInfo,
                            anniversaryDateISO: currentAnniversaryISO
                        });
                    }
                });

                if (selectors.birthdayList && selectors.birthdayAlerts) {
                    if (upcoming.length > 0) {
                        upcoming.sort((a,b) => a.daysLeft - b.daysLeft);
                        selectors.birthdayList.innerHTML = upcoming
                            .map(b => `<li data-client-id="${b.id}" data-anniversary-date="${b.anniversaryDateISO}">
                                        ${b.name} - ${b.date.substring(0,5)}
                                        (${b.daysLeft === 0 ? 'Hoje!' : `em ${b.daysLeft} dias`})
                                        ${b.eventInfo}
                                        <button class="btn btn-small btn-success btn-ok-birthday"
                                                title="Dispensar este alerta até o dia do aniversário">OK</button>
                                    </li>`)
                            .join('');
                        selectors.birthdayAlerts.style.display = 'block';

                        document.querySelectorAll('.btn-ok-birthday').forEach(button => {
                            button.addEventListener('click', function(event) {
                                event.stopPropagation();
                                const listItem = this.closest('li');
                                const clientId = listItem.dataset.clientId;
                                const anniversaryDateISO = listItem.dataset.anniversaryDate;
                                handleDismissBirthdayAlert(clientId, anniversaryDateISO, listItem);
                            });
                        });
                    } else {
                        selectors.birthdayList.innerHTML = '';
                        selectors.birthdayAlerts.style.display = 'none';
                    }
                }
            };
            const checkPendingOrders = () => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const pending = [];
                state.pedidos.forEach(p => {
                    if (p.status === 'pendente' && p.dataEvento) {
                        const eventDate = new Date(`${p.dataEvento}T00:00:00`);
                        eventDate.setHours(0, 0, 0, 0);

                        if (eventDate < today) {
                            const clienteNome = getClientNameById(p.clienteId);
                            pending.push({
                                id: p.id,
                                cliente: clienteNome,
                                tipo: p.tipoEvento,
                                data: formatDate(p.dataEvento)
                            });
                        }
                    }
                });
                if (selectors.pendingOrdersList && selectors.pendingOrdersAlerts) {
                    if (pending.length > 0) {
                        selectors.pendingOrdersList.innerHTML = pending
                            .map(p => `<li style="cursor:pointer;" title="Clique para ver o pedido" onclick="showTab('pedidos'); openPedidoModal('${p.id}');">Pedido ID: ${p.id.substring(4,10)} - Cliente: ${p.cliente} - Data: ${p.data}</li>`)
                            .join('');
                        selectors.pendingOrdersAlerts.style.display = 'block';
                    } else {
                        selectors.pendingOrdersAlerts.style.display = 'none';
                    }
                }
            };
            window.renderUsersRows = (users, tbody) => {
                if (!tbody) { console.error("Users table body not found."); return; }
                tbody.innerHTML = '';
                if (!users || users.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="2" style="text-align: center;">Nenhum usuário cadastrado.</td></tr>`;
                    return;
                }
                users.forEach(user => {
                    const row = tbody.insertRow();
                    row.dataset.id = user.id;
                    row.insertCell().textContent = user.username;
                    const actionsCell = row.insertCell();
                    actionsCell.appendChild(createButton('btn-edit', 'fa-edit', 'Editar Usuário', () => editUser(user.id)));
                    if (state.users.length > 1) {
                        actionsCell.appendChild(createButton('btn-danger', 'fa-trash', 'Excluir Usuário', () => handleDelete('users', user.id)));
                    }
                });
            };
            window.displayUsers = () => {
                renderUsersRows(state.users, selectors.usersTableBody);
            };


            const renderCalendar = () => {
                if (!selectors.currentMonthYear || !selectors.calendarGrid || !selectors.prevMonthBtn || !selectors.nextMonthBtn) {
                    console.error("Calendar elements not found.");
                    return;
                }
                const today = new Date();
                today.setHours(0,0,0,0);
                const currentMonth = state.currentCalendarDate.getMonth();
                const currentYear = state.currentCalendarDate.getFullYear();

                selectors.currentMonthYear.textContent = `${new Date(currentYear, currentMonth).toLocaleString('pt-BR', { month: 'long', year: 'numeric' })}`;
                selectors.calendarGrid.innerHTML = `
                    <div class="calendar-day-header">Dom</div><div class="calendar-day-header">Seg</div>
                    <div class="calendar-day-header">Ter</div><div class="calendar-day-header">Qua</div>
                    <div class="calendar-day-header">Qui</div><div class="calendar-day-header">Sex</div>
                    <div class="calendar-day-header">Sáb</div>`;
                const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
                const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);
                const daysInMonth = lastDayOfMonth.getDate();
                const firstDayOfWeek = firstDayOfMonth.getDay();

                for (let i = 0; i < firstDayOfWeek; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.classList.add('calendar-day', 'empty');
                    selectors.calendarGrid.appendChild(emptyDay);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayElement = document.createElement('div');
                    dayElement.classList.add('calendar-day');
                    const fullDate = new Date(currentYear, currentMonth, day);
                    const fullDateISO = fullDate.toISOString().split('T')[0];
                    dayElement.dataset.date = fullDateISO;

                    const dayNumberSpan = document.createElement('span');
                    dayNumberSpan.classList.add('day-number');
                    dayNumberSpan.textContent = day;
                    dayElement.appendChild(dayNumberSpan);

                    dayElement.classList.add('current-month');
                    if (fullDate.getTime() === today.getTime()) {
                        dayElement.classList.add('today');
                    }

                    const eventsOnDay = state.agenda.filter(item => item.data === fullDateISO && item.status !== 'cancelado');
                    if (eventsOnDay.length > 0) {
                        dayElement.classList.add('has-events');
                        const eventCount = document.createElement('span');
                        eventCount.classList.add('calendar-event-count');
                        eventCount.textContent = eventsOnDay.length;
                        dayElement.appendChild(eventCount);
                    }

                    dayElement.addEventListener('click', () => {
                        if (!dayElement.classList.contains('empty')) {
                            openDailyEventsModal(fullDateISO);
                        }
                    });
                    selectors.calendarGrid.appendChild(dayElement);
                }
                const totalCellsRendered = firstDayOfWeek + daysInMonth;
                let remainingCells = (totalCellsRendered % 7 === 0) ? 0 : 7 - (totalCellsRendered % 7);
                if (totalCellsRendered + remainingCells < 35) remainingCells += 7;
                for (let i = 0; i < remainingCells; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.classList.add('calendar-day', 'empty');
                    selectors.calendarGrid.appendChild(emptyDay);
                }
            };
            const changeMonth = (direction) => {
                state.currentCalendarDate.setDate(1);
                state.currentCalendarDate.setMonth(state.currentCalendarDate.getMonth() + direction);
                renderCalendar();
            };

            if (selectors.prevMonthBtn) selectors.prevMonthBtn.onclick = () => changeMonth(-1);
            if (selectors.nextMonthBtn) selectors.nextMonthBtn.onclick = () => changeMonth(1);

            window.openDailyEventsModal = (dateISO) => {
                if (!selectors.dailyEventsModal || !selectors.dailyEventsModalTitle || !selectors.dailyEventsList) {
                    console.error("Daily events modal elements not found.");
                    return;
                }
                const events = state.agenda.filter(item => item.data === dateISO && item.status !== 'cancelado');
                selectors.dailyEventsModalTitle.textContent = `Compromissos para ${formatDate(dateISO)}`;
                selectors.dailyEventsList.innerHTML = '';

                if (events.length === 0) {
                    selectors.dailyEventsList.innerHTML = '<p style="text-align: center;">Nenhum compromisso para este dia.</p>';
                } else {
                    events.sort((a,b) => (a.horario || '00:00').localeCompare(b.horario || '00:00')).forEach(event => {
                        const eventItem = document.createElement('div');
                        eventItem.classList.add('event-item');
                        const clienteNomeAgenda = event.cliente || (event.pedidoId ? getClientNameById(getPedidoById(event.pedidoId)?.clienteId) : 'N/A');

                        let servicesHtml = '';
                        if (event.pedidoId) {
                            const relatedPedido = getPedidoById(event.pedidoId);
                            if (relatedPedido && relatedPedido.servicos) {
                                const servicesList = relatedPedido.servicos.split('\n').map(s => s.trim()).filter(s => s !== '');
                                if (servicesList.length > 0) {
                                    servicesHtml = `<p style="font-size:0.8em; color:#555;">Serviços: <ul>${servicesList.map(s => `<li>${s}</li>`).join('')}</ul></p>`;
                                }
                            }
                        }

                        eventItem.innerHTML = `
                            <p><strong>${event.horario || 'Dia todo'}</strong> - ${event.descricao}</p>
                            <p>Cliente: ${clienteNomeAgenda}</p>
                            ${servicesHtml}
                            <p>Status: <span class="${event.status || 'pendente'}">${(event.status || 'pendente').charAt(0).toUpperCase() + (event.status || 'pendente').slice(1)}</span></p>
                            <div class="event-actions">
                                <button class="btn btn-info btn-small" onclick="openAgendaDetailsModal('${event.id}'); closeModal(selectors.dailyEventsModal);">Detalhes</button>
                                ${event.pedidoId ? `<button class="btn btn-primary btn-small" onclick="showTab('pedidos'); openPedidoModal('${event.pedidoId}'); closeModal(selectors.dailyEventsModal);">Ver Pedido</button>` : ''}
                            </div>
                        `;
                        selectors.dailyEventsList.appendChild(eventItem);
                    });
                }
                selectors.dailyEventsModal.style.display = 'flex';
            };

            const getMonthlyRevenueData = () => {
                const monthly = {};
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();

                for (let i = 0; i < 12; i++) {
                    const date = new Date(currentYear, currentMonth - i, 1);
                    const key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    monthly[key] = { receitas: 0, despesas: 0 };
                }

                state.financeiro.forEach(f => {
                    if (f.data) {
                        const yearMonth = f.data.substring(0, 7);
                        if (monthly[yearMonth]) {
                            const value = parseFloat(f.valor) || 0;
                            if (f.tipo === 'receita') {
                                monthly[yearMonth].receitas += value;
                            } else if (f.tipo === 'despesa') {
                                monthly[yearMonth].despesas += value;
                            }
                        }
                    }
                });

                const sortedMonths = Object.keys(monthly).sort();
                const labels = sortedMonths.map(ym => {
                    const [year, month] = ym.split('-');
                    const monthName = new Date(year, month - 1, 1).toLocaleString('pt-BR', { month: 'short' });
                    return `${monthName}/${year.substring(2)}`;
                });
                const revenues = sortedMonths.map(ym => monthly[ym].receitas);
                const expenses = sortedMonths.map(ym => monthly[ym].despesas);

                return { labels, revenues, expenses };
            };

            const renderMonthlyRevenueChart = () => {
                if (!selectors.monthlyRevenueChartCanvas) return;

                const data = getMonthlyRevenueData();

                if (monthlyRevenueChartInstance) {
                    monthlyRevenueChartInstance.data.labels = data.labels;
                    monthlyRevenueChartInstance.data.datasets[0].data = data.revenues;
                    monthlyRevenueChartInstance.data.datasets[1].data = data.expenses;
                    monthlyRevenueChartInstance.update();
                } else {
                    const ctx = selectors.monthlyRevenueChartCanvas.getContext('2d');
                    monthlyRevenueChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.labels,
                            datasets: [
                                {
                                    label: 'Receitas',
                                    data: data.revenues,
                                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'Despesas',
                                    data: data.expenses,
                                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Valor (R$)'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Mês/Ano'
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += formatCurrency(context.parsed.y);
                                            }
                                            return label;
                                        }
                                    }
                                },
                                legend: {
                                    display: true,
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            };

            const getRevenueExpenseSummaryData = () => {
                let totalReceitas = 0;
                let totalDespesas = 0;

                const startDate = selectors.financeStartDate ? selectors.financeStartDate.value : null;
                const endDate = selectors.financeEndDate ? selectors.financeEndDate.value : null;

                state.financeiro.forEach(f => {
                    const isWithinDateRange = (!startDate || f.data >= startDate) && (!endDate || f.data <= endDate);

                    if (isWithinDateRange) {
                        const value = parseFloat(f.valor) || 0;
                        if (f.tipo === 'receita') {
                            totalReceitas += value;
                        } else if (f.tipo === 'despesa') {
                            totalDespesas += value;
                        }
                    }
                });

                return { totalReceitas, totalDespesas };
            };

            const renderRevenueExpenseChart = () => {
                if (!selectors.revenueExpenseChartCanvas) return;

                const { totalReceitas, totalDespesas } = getRevenueExpenseSummaryData();
                const total = totalReceitas + totalDespesas;

                if (revenueExpenseChartInstance) {
                    revenueExpenseChartInstance.data.datasets[0].data = [totalReceitas, totalDespesas];
                    revenueExpenseChartInstance.update();
                } else {
                    const ctx = selectors.revenueExpenseChartCanvas.getContext('2d');
                    revenueExpenseChartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Receitas', 'Despesas'],
                            datasets: [{
                                data: [totalReceitas, totalDespesas],
                                backgroundColor: [
                                    'rgba(75, 192, 192, 0.8)',
                                    'rgba(255, 99, 132, 0.8)'
                                ],
                                borderColor: [
                                    'rgba(75, 192, 192, 1)',
                                    'rgba(255, 99, 132, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed !== null) {
                                                label += formatCurrency(context.parsed) + ` (${((context.parsed / total) * 100).toFixed(2)}%)`;
                                            }
                                            return label;
                                        }
                                    }
                                },
                                legend: {
                                    display: true,
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            };
            // ==================================================================
            // 6. NAVEGAÇÃO e ABERTURA MODAIS
            // ==================================================================
            window.showTab = (tabId) => {
                // Remove 'active' de todos os painéis
                selectors.tabPanes.forEach(p => p.classList.remove('active'));

                // Adiciona 'active' ao painel correto
                const activeTabElement = document.getElementById(`${tabId}-tab`);
                if (activeTabElement) {
                    activeTabElement.classList.add('active');
                    // Certifica-se de que o contêiner principal de abas esteja ativo
                    if (selectors.tabContent) selectors.tabContent.classList.add('active');

                    // Chama a função de exibição específica para a aba
                    let displayFnName = `display${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`;
                    if (tabId === 'materiaisEstoque') displayFnName = 'displayMateriaisEstoque';
                    if (tabId === 'configuracoes') displayFnName = 'displayConfig';

                    // Verifica se a função existe antes de chamar
                    if (typeof window[displayFnName] === 'function') {
                         window[displayFnName]();
                    } else {
                        console.warn(`Função de display '${displayFnName}' para a aba '${tabId}' não encontrada.`);
                    }
                    // Tratamento especial para a agenda que tem duas views
                    if (tabId === 'agenda') displayAgenda();

                } else {
                    console.warn(`Aba '${tabId}-tab' não encontrada no DOM.`);
                }
            };
            window.openPedidoModal = (id = null) => {
                populateClientSelect();
                const pedido = id ? state.pedidos.find(i=>i.id===id) : null;
                openModal(selectors.pedidoModal, selectors.pedidoForm, pedido ? 'Editar Pedido' : 'Novo Pedido', pedido);
            };
            window.openClientModal = (id = null) => {
                const cliente = id ? state.clientes.find(i=>i.id===id) : null;
                openModal(selectors.clientModal, selectors.clientForm, cliente ? 'Editar Cliente' : 'Adicionar Cliente', cliente);
            };
            window.openAddAgendaModal = (id = null) => {
                const agendaItem = id ? state.agenda.find(i=>i.id===id) : null;
                openModal(selectors.addAgendaModal, selectors.addAgendaForm, agendaItem ? 'Editar Compromisso' : 'Adicionar Compromisso', agendaItem);
                if (!agendaItem || !agendaItem.id) {
                    if (selectors.addAgendaForm && selectors.addAgendaForm.querySelector('[name="data"]')) {
                        selectors.addAgendaForm.querySelector('[name="data"]').value = state.currentCalendarDate.toISOString().split('T')[0];
                    }
                }
            };
            window.openMaterialModal = (id = null) => {
                const material = id ? state.materiais.find(i=>i.id===id) : null;
                openModal(selectors.materialModal, selectors.materialForm, material ? 'Editar Material' : 'Adicionar Material', material);
            };
            window.openServicoModal = (id = null) => {
                const servico = id ? state.servicos.find(i=>i.id===id) : null;
                openModal(selectors.servicoModal, selectors.servicoForm, servico ? 'Editar Serviço' : 'Adicionar Serviço', servico);
            };
            window.openDespesaModal = () => {
                openModal(selectors.despesaModal, selectors.despesaForm, 'Adicionar Despesa');
                if (selectors.despesaForm && selectors.despesaForm.querySelector('[name="data"]')) {
                    selectors.despesaForm.querySelector('[name="data"]').value = new Date().toISOString().split('T')[0];
                }
            };
            window.openAgendaDetailsModal = (id) => {
                const agendaItem = getAgendaById(id);
                if (!agendaItem) {
                    alert("Compromisso não encontrado.");
                    return;
                }
                const form = selectors.agendaDetailsForm;
                if (!form || !selectors.statusAgendaSelect || !selectors.btnViewRelatedPedido) {
                    console.error("Agenda details form or its critical elements not found.");
                    return;
                }
                form.reset();
                if (form.querySelector('[name="id"]')) form.querySelector('[name="id"]').value = agendaItem.id;
                if (form.querySelector('[name="cliente"]')) form.querySelector('[name="cliente"]').value = agendaItem.cliente || (agendaItem.pedidoId ? getClientNameById(getPedidoById(agendaItem.pedidoId)?.clienteId) : 'N/A');
                if (form.querySelector('[name="data"]')) form.querySelector('[name="data"]').value = formatDateToISO(agendaItem.data);
                if (form.querySelector('[name="horario"]')) form.querySelector('[name="horario"]').value = agendaItem.horario || '';
                if (form.querySelector('[name="descricao"]')) form.querySelector('[name="descricao"]').value = agendaItem.descricao || 'N/A';
                if (form.querySelector('[name="obsAgenda"]')) form.querySelector('[name="obsAgenda"]').value = agendaItem.obsAgenda || '';
                selectors.statusAgendaSelect.value = agendaItem.status || 'pendente';

                const localEventoInput = form.querySelector('[name="localEventoAgenda"]');
                const pedidoRelacionadoInput = form.querySelector('[name="pedidoRelacionado"]');


                if (agendaItem.pedidoId) {
                    const pedido = getPedidoById(agendaItem.pedidoId);
                    if (pedido && pedido.id) {
                         if (pedidoRelacionadoInput) pedidoRelacionadoInput.value = `Pedido #${agendaItem.pedidoId.substring(4, 10)} (${pedido.tipoEvento || 'Evento'})`;
                        if (localEventoInput) localEventoInput.value = pedido.localEvento || 'Local não informado no pedido';
                        selectors.btnViewRelatedPedido.style.display = 'inline-block';
                        selectors.btnViewRelatedPedido.onclick = () => {
                            closeModal(selectors.agendaDetailsModal);
                            showTab('pedidos');
                            openPedidoModal(agendaItem.pedidoId);
                        };
                    } else {
                        if (pedidoRelacionadoInput) pedidoRelacionadoInput.value = `Pedido #${agendaItem.pedidoId.substring(4, 10)} (Não encontrado)`;
                        if (localEventoInput) localEventoInput.value = 'Informação do pedido não encontrada';
                        selectors.btnViewRelatedPedido.style.display = 'none';
                    }
                } else {
                    if (pedidoRelacionadoInput) pedidoRelacionadoInput.value = 'Nenhum pedido vinculado';
                    if (localEventoInput) localEventoInput.value = 'Sem pedido vinculado';
                    selectors.btnViewRelatedPedido.style.display = 'none';
                }
                if (selectors.agendaDetailsModal) selectors.agendaDetailsModal.style.display = 'flex';
            };

            // ==================================================================
            // 7. FUNÇÕES DE PDF, WHATSAPP, EXPORT/IMPORT
            // ==================================================================
            const addHeader = (doc, config, yPosRef) => {
                if (config.logo) {
                    try {
                        const imgWidth = 25;
                        const aspectRatio = doc.getImageProperties(config.logo).height / doc.getImageProperties(config.logo).width;
                        const imgHeight = imgWidth * aspectRatio;
                        doc.addImage(config.logo, 'PNG', 15, yPosRef.y - 5, imgWidth, imgHeight);
                    } catch (e) { console.warn("Erro ao adicionar logo no header:", e);
                    }
                }
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(config.empresa?.empresaNome || 'Nome da Empresa/DJ', config.logo ? 45 : 15, yPosRef.y + 2);
                doc.setFontSize(8); doc.setFont('helvetica', 'normal');
                const headerLineHeight = 3.5;
                let currentY = yPosRef.y + 2 + headerLineHeight;
                if (config.empresa?.empresaDoc) { doc.text(`CNPJ/CPF: ${config.empresa.empresaDoc}`, config.logo ? 45 : 15, currentY); currentY += headerLineHeight;
                }
                if (config.empresa?.empresaEndereco) { doc.text(config.empresa.empresaEndereco, config.logo ? 45 : 15, currentY);
                currentY += headerLineHeight; }
                if (config.empresa?.empresaContato) { doc.text(`Contato: ${config.empresa.empresaContato}`, config.logo ? 45 : 15, currentY);
                currentY += headerLineHeight; }
                if (config.empresa?.empresaEmail) { doc.text(`Email: ${config.empresa.empresaEmail}`, config.logo ? 45 : 15, currentY);
                currentY += headerLineHeight; }
                if (config.empresa?.empresaSite) { doc.text(config.empresa.empresaSite, config.logo ? 45 : 15, currentY);
                currentY += headerLineHeight; }
                yPosRef.y = Math.max(yPosRef.y, currentY) + 5;
                doc.setLineWidth(0.5);
                doc.line(15, yPosRef.y - 3, doc.internal.pageSize.getWidth() - 15, yPosRef.y - 3);
            };
            const addFooter = (doc, pageNum, totalPages, message = '') => {
                const pageHeight = doc.internal.pageSize.getHeight();
                doc.setFontSize(8); doc.setFont('helvetica', 'italic');
                if (message) {
                    doc.text(message, 15, pageHeight - 15);
                }
                doc.text(`Página ${pageNum} de ${totalPages}`, doc.internal.pageSize.getWidth() - 30, pageHeight - 10, { align: 'right' });
                doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}`, 15, pageHeight - 10);
            };
            const addConditionalTextLine = (doc, yPosRef, label, value, size, style, spaceAfter, options = {}) => {
                const { margin = 15, align = 'left', footerMessage = '', boldLabel = true } = options;
                if (value && value.toString().trim() !== '') {
                    yPosRef.y = addPageIfNeeded(doc, yPosRef, size / 2 + spaceAfter, state.configuracoes, footerMessage);
                    doc.setFontSize(size); doc.setFont('helvetica', style);
                    let textX = margin;
                    let fullText = value;
                    if (label) {
                        fullText = `${label}: ${value}`;
                        if (boldLabel) {
                            doc.setFont('helvetica', 'bold');
                            doc.text(`${label}:`, textX, yPosRef.y, {align: align});
                            doc.setFont('helvetica', style);
                            textX += doc.getTextWidth(`${label}: `) + (align === 'center' ? doc.getTextWidth(value) / 2 : 0) ;
                            doc.text(value.toString(), textX, yPosRef.y, {align: align});
                        } else {
                             doc.text(fullText, margin, yPosRef.y, {align: align});
                        }
                    } else {
                         doc.text(fullText, margin, yPosRef.y, {align: align});
                    }


                    yPosRef.y += spaceAfter;
                    return true;
                }
                return false;
            };

            const addSignatureLines = (doc, yPosRef, config, cliente) => {
                const pageWidth = doc.internal.pageSize.getWidth();
                const signatureWidth = 70;
                const spaceBetween = 10;
                const startX1 = (pageWidth / 2) - signatureWidth - (spaceBetween / 2);
                const startX2 = (pageWidth / 2) + (spaceBetween / 2);

                yPosRef.y = addPageIfNeeded(doc, yPosRef, 30, config);
                doc.setLineWidth(0.2);
                doc.line(startX1, yPosRef.y, startX1 + signatureWidth, yPosRef.y);
                doc.setFontSize(9); doc.setFont('helvetica', 'normal');
                doc.text(cliente?.nome || 'Contratante', startX1 + signatureWidth / 2, yPosRef.y + 4, { align: 'center' });
                doc.text('Contratante', startX1 + signatureWidth / 2, yPosRef.y + 8, { align: 'center' });
                doc.line(startX2, yPosRef.y, startX2 + signatureWidth, yPosRef.y);
                doc.text(config.empresa?.empresaNome || 'Contratada', startX2 + signatureWidth / 2, yPosRef.y + 4, { align: 'center' });
                doc.text('Contratada', startX2 + signatureWidth / 2, yPosRef.y + 8, { align: 'center' });

                yPosRef.y += 15;
            };
            const addPageIfNeeded = (doc, yPosRef, requiredHeight, config, footerMessage = '') => {
                const pageHeight = doc.internal.pageSize.getHeight();
                const footerHeight = 20;
                if (yPosRef.y + requiredHeight > pageHeight - footerHeight) {
                    addFooter(doc, doc.internal.getNumberOfPages(), doc.internal.getNumberOfPages() +1, footerMessage);
                    doc.addPage();
                    yPosRef.pageNumber++;
                    yPosRef.y = 15;
                    addHeader(doc, config, yPosRef);
                }
                return yPosRef.y;
            };

            const validateCompanyConfig = () => {
                const config = state.configuracoes.empresa;
                if (!config || !config.empresaNome || !config.empresaDoc || !config.empresaEndereco || !config.empresaContato) {
                    alert("Por favor, preencha todos os Dados da Empresa na aba Configurações antes de gerar documentos (Nome, CNPJ/CPF, Endereço, Contato).");
                    showTab('configuracoes');
                    return false;
                }
                return true;
            };

            const generateOrderPDF = (pedido) => {
                 if (!validateCompanyConfig()) return;
                try {
                    const doc = new jsPDF();
                    const config = state.configuracoes;
                    const cliente = getClientById(pedido.clienteId);
                    let yPosRef = { y: 15, pageNumber: 1, totalPages: 1 };
                    const primaryColor = [106, 90, 205];

                    addHeader(doc, config, yPosRef);

                    doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.rect(15, yPosRef.y, doc.internal.pageSize.getWidth() - 30, 12, 'F');
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold'); doc.setTextColor(255, 255, 255);
                    doc.text(`PEDIDO #${pedido.id.substring(4,10)}`, doc.internal.pageSize.getWidth() / 2, yPosRef.y + 8, { align: 'center' });
                    yPosRef.y += 20;
                    doc.setTextColor(0,0,0);

                    yPosRef.y = addPageIfNeeded(doc, yPosRef, 10, config);
                    doc.setFontSize(13); doc.setFont('helvetica', 'bold');
                    doc.text('DADOS DO CLIENTE:', 15, yPosRef.y); yPosRef.y += 7;
                    addConditionalTextLine(doc, yPosRef, 'Nome', cliente.nome, 10, 'normal', 5);
                    addConditionalTextLine(doc, yPosRef, 'CPF/CNPJ', cliente.docCliente, 10, 'normal', 5);
                    addConditionalTextLine(doc, yPosRef, 'Contato', cliente.contato, 10, 'normal', 5);
                    addConditionalTextLine(doc, yPosRef, 'Email', cliente.emailCliente, 10, 'normal', 5);
                    addConditionalTextLine(doc, yPosRef, 'Endereço do Cliente', cliente.enderecoCliente, 10, 'normal', 8);
                    yPosRef.y = addPageIfNeeded(doc, yPosRef, 10, config);
                    doc.setFontSize(13); doc.setFont('helvetica', 'bold');
                    doc.text('DETALHES DO EVENTO:', 15, yPosRef.y); yPosRef.y += 7;
                    addConditionalTextLine(doc, yPosRef, 'Data', formatDate(pedido.dataEvento), 10, 'normal', 5);
                    addConditionalTextLine(doc, yPosRef, 'Horário', `${pedido.horaInicio || ''} às ${pedido.horaFinal || ''}`, 10, 'normal', 5);
                    addConditionalTextLine(doc, yPosRef, 'Tipo do Evento', pedido.tipoEvento, 10, 'normal', 5);
                    addConditionalTextLine(doc, yPosRef, 'Tema', pedido.temaEvento, 10, 'normal', 5);
                    addConditionalTextLine(doc, yPosRef, 'Nº de Pessoas', pedido.numeroPessoas, 10, 'normal', 5);
                    addConditionalTextLine(doc, yPosRef, 'Local do Evento', pedido.localEvento, 10, 'normal', 8);
                    if (pedido.servicos && pedido.servicos.trim() !== '') {
                        yPosRef.y = addPageIfNeeded(doc, yPosRef, 10, config);
                        doc.setFontSize(13); doc.setFont('helvetica', 'bold');
                        doc.text('SERVIÇOS CONTRATADOS:', 15, yPosRef.y); yPosRef.y += 7;
                        doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                        const servicosArray = pedido.servicos.split('\n').map(s => s.trim()).filter(s => s);
                        servicosArray.forEach(servico => {
                            yPosRef.y = addPageIfNeeded(doc, yPosRef, 5, config);
                            const splitServico = doc.splitTextToSize(`- ${servico}`, doc.internal.pageSize.getWidth() - 35);
                            splitServico.forEach(line => {
                                 yPosRef.y = addPageIfNeeded(doc, yPosRef, 5, config);
                                 doc.text(line, 20, yPosRef.y); yPosRef.y += 5;
                            });
                        });
                        yPosRef.y += 3;
                    }

                    if (pedido.observacoes && pedido.observacoes.trim() !== '') {
                        yPosRef.y = addPageIfNeeded(doc, yPosRef, 10, config);
                        doc.setFontSize(13); doc.setFont('helvetica', 'bold');
                        doc.text('OBSERVAÇÕES:', 15, yPosRef.y); yPosRef.y += 7;
                        doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                        const splitObs = doc.splitTextToSize(pedido.observacoes, doc.internal.pageSize.getWidth() - 30);
                        splitObs.forEach(line => {
                             yPosRef.y = addPageIfNeeded(doc, yPosRef, 5, config);
                             doc.text(line, 15, yPosRef.y); yPosRef.y += 5;
                        });
                        yPosRef.y += 3;
                    }


                    yPosRef.y = addPageIfNeeded(doc, yPosRef, 15, config);
                    doc.setFontSize(13); doc.setFont('helvetica', 'bold');
                    doc.text('VALORES:', 15, yPosRef.y); yPosRef.y += 7;
                    addConditionalTextLine(doc, yPosRef, 'Valor Total', formatCurrency(pedido.valorTotal), 12, 'bold', 8, {boldLabel: false});
                    const pagamentosRealizados = state.financeiro.filter(f => f.pedidoId === pedido.id && f.tipo === 'receita');
                    let totalPago = 0;
                    if (pagamentosRealizados.length > 0) {
                        yPosRef.y = addPageIfNeeded(doc, yPosRef, 10, config);
                        doc.setFontSize(11); doc.setFont('helvetica', 'bold');
                        doc.text('Pagamentos Realizados:', 15, yPosRef.y); yPosRef.y += 6;
                        doc.setFontSize(9); doc.setFont('helvetica', 'normal');
                        pagamentosRealizados.forEach(pag => {
                            totalPago += parseFloat(pag.valor) || 0;
                            addConditionalTextLine(doc, yPosRef, `${formatDate(pag.data)} (${pag.formaPagamento || 'N/A'})`, formatCurrency(pag.valor), 9, 'normal', 4, {margin: 20, boldLabel: false});
                        });
                        yPosRef.y += 2;
                    }
                    addConditionalTextLine(doc, yPosRef, 'Total Pago', formatCurrency(totalPago), 10, 'bold', 5);
                    const valorRestante = parseFloat(pedido.valorTotal) - totalPago;
                    addConditionalTextLine(doc, yPosRef, 'Valor Restante', formatCurrency(valorRestante), 10, 'bold', 10, {style: (valorRestante > 0 ? 'bold' : 'normal')});
                    const cidadePedido = getCidadeFromConfig() || getCidadeFromCliente(cliente) || "Local não definido";
                    addConditionalTextLine(doc, yPosRef, null, `${cidadePedido}, ${new Date().toLocaleDateString('pt-BR', {day: '2-digit', month: 'long', year: 'numeric'})}.`, 9, 'normal', 15, {align: 'center'});
                    yPosRef.y = addPageIfNeeded(doc, yPosRef, 30, config);
                    addSignatureLines(doc, yPosRef, config, cliente);

                    const totalPagesFinal = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPagesFinal; i++) {
                        doc.setPage(i);
                        addFooter(doc, i, totalPagesFinal, 'Este documento é um resumo do pedido e não substitui o contrato.');
                    }

                    doc.save(`Pedido_${pedido.id.substring(4,10)}_${(cliente?.nome || 'Cliente').replace(/\s+/g, '_')}.pdf`);
                } catch (error) {
                    console.error("Erro detalhado ao gerar PDF do Pedido:", error);
                    alert(`Ocorreu um erro ao gerar o PDF do Pedido: ${error.message}\n\nStack: ${error.stack}`);
                }
            };
            const generateContractPDF = (pedidoId) => {
                const pedido = getPedidoById(pedidoId);
                if (!pedido || !pedido.id) { alert("Pedido não encontrado para gerar contrato."); return; }
                if (!validateCompanyConfig()) return;

                try {
                    const doc = new jsPDF();
                    const config = state.configuracoes;
                    const cliente = getClientById(pedido.clienteId);
                    let yPosRef = { y: 15, pageNumber: 1 };
                    const primaryColor = [106, 90, 205]; // Roxo
                    const textColor = [51, 51, 51]; // Cinza escuro para o texto
                    const lightGray = [240, 240, 240]; // Fundo para parágrafos
                    const lineHeightNormal = 5;
                    const headerHeight = 12;

                    // Header
                    addHeader(doc, config, yPosRef);

                    // Título do Documento
                    doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.rect(15, yPosRef.y, doc.internal.pageSize.getWidth() - 30, headerHeight, 'F');
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('CONTRATO DE PRESTAÇÃO DE SERVIÇOS', doc.internal.pageSize.getWidth() / 2, yPosRef.y + (headerHeight / 2) + 2, { align: 'center' });
                    doc.setTextColor(textColor[0], textColor[1], textColor[2]); // Reset para cor do texto padrão
                    yPosRef.y += headerHeight + 10; // Espaço após o título

                    // 1. IDENTIFICAÇÃO DAS PARTES
                    yPosRef.y = addPageIfNeeded(doc, yPosRef, 30, config);
                    doc.setFontSize(14); doc.setFont('helvetica', 'bold');
                    doc.text('1. IDENTIFICAÇÃO DAS PARTES', 15, yPosRef.y);
                    yPosRef.y += 8;

                    // CONTRATANTE
                    doc.setFontSize(11); doc.setFont('helvetica', 'bold');
                    doc.text('CONTRATANTE:', 20, yPosRef.y);
                    yPosRef.y += 5;
                    const contratanteData = [
                        ['Nome Completo', cliente.nome || ''],
                        ['CPF/CNPJ', cliente.docCliente || ''],
                        ['Endereço', cliente.enderecoCliente || ''],
                        ['Contato', cliente.contato || ''],
                        ['Email', cliente.emailCliente || '']
                    ].filter(row => row[1] && row[1].toString().trim() !== '');

                    doc.autoTable({
                        startY: yPosRef.y,
                        body: contratanteData,
                        theme: 'plain',
                        styles: { fontSize: 10, cellPadding: 2, textColor: textColor, lineHeight: 1.2 },
                        columnStyles: { 0: { fontStyle: 'bold', cellWidth: 40 } },
                        margin: { left: 25, right: 15 },
                        didDrawPage: (data) => {
                            if (data.pageNumber > yPosRef.pageNumber) {
                                yPosRef.pageNumber = data.pageNumber;
                                yPosRef.y = 15;
                                addHeader(doc, config, yPosRef);
                                data.settings.startY = yPosRef.y + 5; // Ajusta o startY para a nova página
                            }
                        }
                    });
                    yPosRef.y = doc.autoTable.previous.finalY + 8;

                    // CONTRATADA
                    yPosRef.y = addPageIfNeeded(doc, yPosRef, 30, config);
                    doc.setFontSize(11); doc.setFont('helvetica', 'bold');
                    doc.text('CONTRATADA:', 20, yPosRef.y);
                    yPosRef.y += 5;
                    const contratadaData = [
                        ['Nome/Empresa', config.empresa?.empresaNome || ''],
                        ['CNPJ/CPF', config.empresa?.empresaDoc || ''],
                        ['Endereço', config.empresa?.empresaEndereco || ''],
                        ['Contato', config.empresa?.empresaContato || ''],
                        ['Email', config.empresa?.empresaEmail || '']
                    ].filter(row => row[1] && row[1].toString().trim() !== '');

                    doc.autoTable({
                        startY: yPosRef.y,
                        body: contratadaData,
                        theme: 'plain',
                        styles: { fontSize: 10, cellPadding: 2, textColor: textColor, lineHeight: 1.2 },
                        columnStyles: { 0: { fontStyle: 'bold', cellWidth: 40 } },
                        margin: { left: 25, right: 15 },
                        didDrawPage: (data) => {
                            if (data.pageNumber > yPosRef.pageNumber) {
                                yPosRef.pageNumber = data.pageNumber;
                                yPosRef.y = 15;
                                addHeader(doc, config, yPosRef);
                                data.settings.startY = yPosRef.y + 5; // Ajusta o startY para a nova página
                            }
                        }
                    });
                    yPosRef.y = doc.autoTable.previous.finalY + 12;

                    const cidadeForoContrato = getCidadeFromConfig() || getCidadeFromCliente(cliente) || "Local não definido";
                    const servicosList = pedido.servicos ? pedido.servicos.split('\n').map(s => `• ${s.trim()}`).filter(s => s) : [];

                    const clauses = [
                        {
                            title: '2. DO OBJETO DO CONTRATO',
                            content: `O presente contrato tem por objeto a prestação de serviços de Disc Jockey (DJ) para o evento "${pedido.tipoEvento || 'Tipo de Evento não informado'}", a ser realizado em **${formatDate(pedido.dataEvento)}**, das **${pedido.horaInicio || 'HH:MM'}** às **${pedido.horaFinal || 'HH:MM'}**, no seguinte local: **${pedido.localEvento || 'Local não informado'}**.
                            ${pedido.temaEvento ? `Tema do evento: *${pedido.temaEvento}*.` : ''}
                            ${pedido.numeroPessoas ? `Número aproximado de pessoas: *${pedido.numeroPessoas}*.` : ''}
                            ${servicosList.length > 0 ? `\n\n**Serviços Adicionais Contratados:**\n${servicosList.join('\n')}` : ''}`
                        },
                        {
                            title: '3. DAS OBRIGAÇÕES DA CONTRATADA',
                            content: `I - Comparecer ao local do evento com antecedência mínima de 60 (sessenta) minutos para montagem e testes dos equipamentos, salvo acordo diverso.\nII - Fornecer todo o equipamento de som e iluminação (se contratado) necessário para a prestação dos serviços descritos na Cláusula 2ª, em perfeito estado de funcionamento.\nIII - Executar os serviços com zelo, profissionalismo e, se aplicável, de acordo com o perfil musical previamente alinhado com a CONTRATANTE.\nIV - Manter-se disponível e atuante durante todo o período contratado para o evento.`
                        },
                        {
                            title: '4. DAS OBRIGAÇÕES DA CONTRATANTE',
                            content: `I - Fornecer à CONTRATADA um local seguro, coberto e adequado para a instalação dos equipamentos, com ponto de energia elétrica (110V ou 220V, conforme especificado pela CONTRATADA) estável e compatível com os equipamentos.\nII - Garantir o acesso da CONTRATADA e sua equipe (se houver) ao local do evento para montagem e desmontagem dos equipamentos nos horários acordados.\nIII - Efetuar o pagamento do valor acordado na forma e prazo estipulados na Cláusula 5ª.\nIV - Responsabilizar-se por eventuais danos causados aos equipamentos da CONTRATADA por seus convidados ou por falhas na infraestrutura do local, exceto por desgaste natural ou falha técnica do equipamento da CONTRATADA.`
                        },
                        {
                            title: '5. DO VALOR E FORMA DE PAGAMENTO',
                            content: `Pelos serviços prestados, a CONTRATANTE pagará à CONTRATADA o valor total de **${formatCurrency(pedido.valorTotal)}**.
                            O pagamento será realizado da seguinte forma: Sinal de **${formatCurrency(parseFloat(pedido.valorTotal) * 0.5)}** (cinquenta por cento) no ato da assinatura/confirmação deste contrato para reserva da data, e o valor restante de **${formatCurrency(parseFloat(pedido.valorTotal) * 0.5)}** deverá ser pago até o dia do evento, antes do início da prestação dos serviços. Formas de pagamento a combinar.`
                        },
                        {
                            title: '6. DA RESCISÃO E CANCELAMENTO',
                            content: `Em caso de cancelamento por parte da CONTRATANTE com menos de 15 (quinze) dias de antecedência da data do evento, o valor do sinal pago não será reembolsado, a título de compensação por reserva de data e despesas administrativas. Cancelamentos com antecedência superior a 15 dias implicarão na devolução de 50% do sinal. Em caso de cancelamento pela CONTRATADA, exceto por motivo de força maior devidamente comprovado (como doença grave ou acidente), esta devolverá integralmente todos os valores já pagos pela CONTRATANTE no prazo de 5 (cinco) dias úteis e, se possível, envidará esforços para indicar outro profissional qualificado.`
                        },
                        {
                            title: '7. DAS DISPOSIÇÕES GERAIS',
                            content: `Este contrato não estabelece vínculo empregatício entre as partes, tratando-se de prestação de serviços autônomos. Eventuais alterações neste contrato deverão ser feitas por escrito e assinadas por ambas as partes. Fica eleito o foro da comarca de **${cidadeForoContrato}** para dirimir quaisquer dúvidas ou litígios oriundos deste contrato, com renúncia expressa a qualquer outro, por mais privilegiado que seja.`
                        }
                    ];

                    clauses.forEach((clause, index) => {
                        yPosRef.y = addPageIfNeeded(doc, yPosRef, 20, config); // Espaço mínimo para título e um pouco de texto
                        doc.setFontSize(14); doc.setFont('helvetica', 'bold');
                        doc.text(clause.title, 15, yPosRef.y);
                        yPosRef.y += 8;

                        doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                        const contentLines = doc.splitTextToSize(clause.content, doc.internal.pageSize.getWidth() - 30);
                        contentLines.forEach(line => {
                            yPosRef.y = addPageIfNeeded(doc, yPosRef, lineHeightNormal, config);
                            // Detecta e formata negritos e itálicos
                            const segments = line.split(/(\*\*.*?\*\*|\*.*?\*)/g).filter(s => s);
                            let currentX = 15;
                            segments.forEach(segment => {
                                if (segment.startsWith('**') && segment.endsWith('**')) {
                                    doc.setFont('helvetica', 'bold');
                                    doc.text(segment.substring(2, segment.length - 2), currentX, yPosRef.y);
                                    currentX += doc.getTextWidth(segment.substring(2, segment.length - 2));
                                } else if (segment.startsWith('*') && segment.endsWith('*')) {
                                    doc.setFont('helvetica', 'italic');
                                    doc.text(segment.substring(1, segment.length - 1), currentX, yPosRef.y);
                                    currentX += doc.getTextWidth(segment.substring(1, segment.length - 1));
                                } else {
                                    doc.setFont('helvetica', 'normal');
                                    doc.text(segment, currentX, yPosRef.y);
                                    currentX += doc.getTextWidth(segment);
                                }
                            });
                            yPosRef.y += lineHeightNormal;
                        });
                        yPosRef.y += 6; // Espaço após o parágrafo
                    });

                    // Cláusula final e data
                    yPosRef.y = addPageIfNeeded(doc, yPosRef, 15, config);
                    doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                    const finalClauseText = `E, por estarem justas e contratadas, as partes assinam o presente contrato em 2 (duas) vias de igual teor e forma, na presença das testemunhas abaixo (se houver).`;
                    const splitFinalClause = doc.splitTextToSize(finalClauseText, doc.internal.pageSize.getWidth() - 30);
                    splitFinalClause.forEach(line => {
                        yPosRef.y = addPageIfNeeded(doc, yPosRef, lineHeightNormal, config);
                        doc.text(line, 15, yPosRef.y);
                        yPosRef.y += lineHeightNormal;
                    });
                    yPosRef.y += 8;

                    doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                    doc.text(`${cidadeForoContrato}, ${new Date().toLocaleDateString('pt-BR', {day: '2-digit', month: 'long', year: 'numeric'})}.`, doc.internal.pageSize.getWidth() / 2, yPosRef.y, { align: 'center' });
                    yPosRef.y += 20;

                    // Linhas de Assinatura
                    addSignatureLines(doc, yPosRef, config, cliente);

                    // Testemunhas (Opcional, pode ser adicionado manualmente ao template se necessário)
                    yPosRef.y = addPageIfNeeded(doc, yPosRef, 30, config);
                    doc.setFontSize(10); doc.setFont('helvetica', 'bold');
                    doc.text('TESTEMUNHAS:', 15, yPosRef.y);
                    yPosRef.y += 10;
                    doc.setLineWidth(0.2);
                    const witnessLineY = yPosRef.y;
                    doc.line(20, witnessLineY, 90, witnessLineY);
                    doc.text('Nome Completo:', 20, witnessLineY + 5);
                    doc.text('CPF:', 20, witnessLineY + 10);

                    doc.line(doc.internal.pageSize.getWidth() - 90, witnessLineY, doc.internal.pageSize.getWidth() - 20, witnessLineY);
                    doc.text('Nome Completo:', doc.internal.pageSize.getWidth() - 90, witnessLineY + 5);
                    doc.text('CPF:', doc.internal.pageSize.getWidth() - 90, witnessLineY + 10);
                    yPosRef.y += 20;


                    // Footer para todas as páginas
                    const totalPagesFinal = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPagesFinal; i++) {
                        doc.setPage(i);
                        addFooter(doc, i, totalPagesFinal, 'Documento gerado automaticamente pelo Sistema de Gerenciamento de DJs.');
                    }
                    doc.save(`Contrato_${pedido.id.substring(4, 10)}_${(cliente?.nome || 'Cliente').replace(/\s+/g, '_')}.pdf`);

                } catch (error) {
                    console.error("Erro detalhado ao gerar PDF do Contrato:", error);
                    alert(`Ocorreu um erro ao gerar o PDF do Contrato: ${error.message}\n\nStack: ${error.stack}`);
                }
            };
            const generateReceiptPDF = (financeEntry) => {
                if (!validateCompanyConfig()) return;
                if (!financeEntry || financeEntry.tipo !== 'receita') {
                    alert("Lançamento inválido para gerar recibo.");
                    return;
                }
                try {
                    const doc = new jsPDF();
                    const config = state.configuracoes;
                    let cliente = {};
                    let pedido = {};
                    let textoDescricaoPagamento = `Pagamento referente a: ${financeEntry.descricao}`;
                    if (financeEntry.pedidoId) {
                        pedido = getPedidoById(financeEntry.pedidoId) || {};
                        cliente = getClientById(pedido.clienteId) || {};
                        if(pedido.id){
                             textoDescricaoPagamento = `Pagamento referente ao Pedido #${pedido.id.substring(4,10)} (${pedido.tipoEvento || 'Evento'}) - Cliente: ${cliente.nome || 'Não informado'}.`;
                        }
                    } else {
                        const matchCliente = financeEntry.descricao.match(/Cliente:\s*(.+)/i);
                        if(matchCliente && matchCliente[1]) cliente.nome = matchCliente[1].trim();
                        else cliente.nome = "Cliente não especificado";
                    }


                    let yPosRef = { y: 15, pageNumber: 1, totalPages: 1 };
                    const receiptColor = [0, 123, 255];

                    addHeader(doc, config, yPosRef);
                    doc.setFillColor(receiptColor[0], receiptColor[1], receiptColor[2]);
                    doc.rect(15, yPosRef.y, doc.internal.pageSize.getWidth() - 30, 12, 'F');
                    doc.setFontSize(20);
                    doc.setFont('helvetica', 'bold'); doc.setTextColor(255, 255, 255);
                    doc.text('RECIBO DE PAGAMENTO', doc.internal.pageSize.getWidth() / 2, yPosRef.y + 8.5, { align: 'center' });
                    yPosRef.y += 22;
                    doc.setTextColor(0,0,0);

                    const receiptDetails = [
                        ['Valor Recebido', formatCurrency(financeEntry.valor)],
                        ['Data do Pagamento', formatDate(financeEntry.data)],
                        ['Forma de Pagamento', financeEntry.formaPagamento || 'Não especificada'],
                        ['Referente a', textoDescricaoPagamento]
                    ];
                    const pagadorInfo = [
                        ['Nome do Pagador', cliente.nome || 'N/A'],
                        ['CPF/CNPJ do Pagador', cliente.docCliente || 'N/A'],
                        ['Contato do Pagador', cliente.contato || 'N/A']
                    ].filter(row => row[1] !== 'N/A');
                    yPosRef.y = addPageIfNeeded(doc, yPosRef, 10, config);
                    doc.setFontSize(13); doc.setFont('helvetica', 'bold');
                    doc.text('Detalhes do Recibo:', 15, yPosRef.y);
                    doc.autoTable({
                        startY: yPosRef.y + 5,
                        body: receiptDetails,
                        theme: 'grid',
                        styles: { fontSize: 10, cellPadding: 2, textColor: [51, 51, 51], lineHeight: 1.2 },
                        headStyles: { fillColor: receiptColor, textColor: 255, fontStyle: 'bold' },
                        columnStyles: { 0: { fontStyle: 'bold', cellWidth: 40 } },
                        margin: { left: 15, right: 15 },
                        didDrawPage: (data) => {
                            if (data.pageNumber > yPosRef.pageNumber) {
                                yPosRef.pageNumber = data.pageNumber;
                                yPosRef.y = 15;
                                addHeader(doc, config, yPosRef);
                                yPosRef.y = data.cursor.y;
                            } else {
                                yPosRef.y = data.cursor.y;
                            }
                        }
                    });
                    yPosRef.y = doc.autoTable.previous.finalY + 10;

                    if (pagadorInfo.length > 0) {
                        yPosRef.y = addPageIfNeeded(doc, yPosRef, 10, config);
                        doc.setFontSize(13); doc.setFont('helvetica', 'bold');
                        doc.text('Informações do Pagador:', 15, yPosRef.y);
                        doc.autoTable({
                            startY: yPosRef.y + 5,
                            body: pagadorInfo,
                            theme: 'grid',
                            styles: { fontSize: 10, cellPadding: 2, textColor: [51, 51, 51], lineHeight: 1.2 },
                            headStyles: { fillColor: receiptColor, textColor: 255, fontStyle: 'bold' },
                            columnStyles: { 0: { fontStyle: 'bold', cellWidth: 40 } },
                            margin: { left: 15, right: 15 },
                            didDrawPage: (data) => {
                                if (data.pageNumber > yPosRef.pageNumber) {
                                    yPosRef.pageNumber = data.pageNumber;
                                    yPosRef.y = 15;
                                    addHeader(doc, config, yPosRef);
                                    yPosRef.y = data.cursor.y;
                                } else {
                                    yPosRef.y = data.cursor.y;
                                }
                            }
                        });
                        yPosRef.y = doc.autoTable.previous.finalY + 15;
                    }


                    const cidadeRecibo = getCidadeFromConfig() || "Local não especificado";
                    doc.text(`${cidadeRecibo}, ${new Date(financeEntry.data + "T00:00:00").toLocaleDateString('pt-BR', {day: '2-digit', month: 'long', year: 'numeric', timeZone: 'UTC'})}.`,
                        doc.internal.pageSize.getWidth() / 2, yPosRef.y, { align: 'center' });
                    yPosRef.y += 20;

                    yPosRef.y = addPageIfNeeded(doc, yPosRef, 30, config);
                    doc.setLineWidth(0.2);
                    const signatureX = (doc.internal.pageSize.getWidth() / 2) - 35;
                    doc.line(signatureX, yPosRef.y, signatureX + 70, yPosRef.y);
                    doc.setFontSize(9);
                    doc.text(config.empresa?.empresaNome || 'Assinatura do Emissor', signatureX + 35, yPosRef.y + 5, { align: 'center' });
                    yPosRef.y += 15;
                    addFooter(doc, doc.internal.getNumberOfPages(), doc.internal.getNumberOfPages(), 'Este recibo é válido mediante confirmação do pagamento.');
                    doc.save(`Recibo_${financeEntry.id.substring(4,10)}_${(cliente?.nome || 'Cliente').replace(/\s+/g, '_')}.pdf`);
                } catch (error) {
                    console.error("Erro detalhado ao gerar PDF do Recibo:", error);
                    alert(`Ocorreu um erro ao gerar o PDF do Recibo: ${error.message}\n\nStack: ${error.stack}`);
                }
            };
            const generateReportPDF = (type, title, headers, dataMapper, filterFn = null, customData = null) => {
                if (!validateCompanyConfig() && type !== 'financeiro_completo' && type !== 'sinal_pendente') return;
                let dataToReport = customData || state[type.startsWith('financeiro') || type === 'sinal_pendente' ? 'pedidos' : type] || [];

                if (type === 'financeiro_completo') {
                    dataToReport = [...state.financeiro];
                } else if (type === 'sinal_pendente') {
                    const hoje = new Date().toISOString().split('T')[0];
                    dataToReport = state.pedidos.filter(p => {
                        const valorTotal = parseFloat(p.valorTotal) || 0;
                        const valorMinimoPago = valorTotal * 0.5;
                        const totalPagoNoPedido = state.financeiro
                            .filter(f => f.pedidoId === p.id && f.tipo === 'receita')
                            .reduce((sum, f) => sum + parseFloat(f.valor), 0);

                        return p.status === 'pendente' &&
                                new Date(p.dataEvento + "T00:00:00") <= new Date(hoje + "T00:00:00") &&
                                totalPagoNoPedido < valorMinimoPago;
                    });
                }


                if (filterFn) {
                    dataToReport = dataToReport.filter(filterFn);
                }


                if (dataToReport.length === 0) {
                    alert(`Nenhum dado para gerar o relatório de ${title}.`);
                    return;
                }

                try {
                    const doc = new jsPDF({ orientation: headers.length > 6 ? 'landscape' : 'portrait' });
                    const config = state.configuracoes;
                    let yPosRef = { y: 15, pageNumber: 1 };
                    const tableBody = dataToReport.map(dataMapper);

                    addHeader(doc, config, yPosRef);
                    doc.setFontSize(16); doc.setFont('helvetica', 'bold');
                    doc.text(title, doc.internal.pageSize.getWidth() / 2, yPosRef.y, { align: 'center' });
                    yPosRef.y += 10;
                    doc.autoTable({
                        head: [headers],
                        body: tableBody,
                        startY: yPosRef.y,
                        theme: 'striped',
                        styles: { fontSize: headers.length > 6 ? 7 : 8, cellPadding: 1.5, overflow: 'linebreak' },
                        headStyles: { fillColor: [106, 90, 205], textColor: 255, fontStyle: 'bold' },
                        margin: { top: yPosRef.y + 5, bottom: 20 },
                        didDrawPage: (data) => {
                            if (data.pageNumber > 1) {
                                yPosRef.pageNumber = data.pageNumber;
                                yPosRef.y = 15;
                                addHeader(doc, config, yPosRef);
                                data.settings.margin.top = yPosRef.y + 5;
                            }
                            addFooter(doc, data.pageNumber, doc.internal.getNumberOfPages(), `Relatório de ${title}`);
                        }
                    });
                    if (type === 'financeiro_completo') {
                        let finalY = doc.autoTable.previous.finalY || yPosRef.y;
                        finalY += 10;

                        finalY = addPageIfNeeded(doc, {y: finalY, pageNumber: doc.internal.getNumberOfPages()}, 40, config);
                        doc.setFontSize(12); doc.setFont('helvetica', 'bold');
                        doc.text("Resumo Financeiro (Geral):", 15, finalY); finalY += 6;
                        doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                        if (selectors.totalAReceber) doc.text(`Total a Receber (Pedidos Pendentes): ${selectors.totalAReceber.textContent}`, 20, finalY);
                        finalY += 5;
                        if (selectors.totalRecebido) doc.text(`Total Recebido (Lançado): ${selectors.totalRecebido.textContent}`, 20, finalY); finalY += 5;
                        if (selectors.totalDespesasFin) doc.text(`Total Despesas (Lançado): ${selectors.totalDespesasFin.textContent}`, 20, finalY);
                        finalY += 5;
                        if (selectors.saldoAtual) doc.text(`Saldo Atual (Recebido - Despesas): ${selectors.saldoAtual.textContent}`, 20, finalY); finalY += 8;
                        finalY = addPageIfNeeded(doc, {y: finalY, pageNumber: doc.internal.getNumberOfPages()}, 30, config);
                        doc.setFontSize(12); doc.setFont('helvetica', 'bold');
                        doc.text("Previsão Financeira:", 15, finalY); finalY += 6;
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        if (selectors.previstoAReceber) doc.text(`Total Previsto a Receber (Pedidos Futuros): ${selectors.previstoAReceber.textContent}`, 20, finalY); finalY += 5;
                        if (selectors.previstoAPagar) doc.text(`Total Previsto a Pagar (Despesas Futuras): ${selectors.previstoAPagar.textContent}`, 20, finalY); finalY += 5;
                        if (selectors.saldoProjetado) doc.text(`Saldo Projetado: ${selectors.saldoProjetado.textContent}`, 20, finalY);
                        if (doc.internal.getNumberOfPages() > (doc.autoTable.previous.pageCount || 1) ) {
                             addFooter(doc, doc.internal.getNumberOfPages(), doc.internal.getNumberOfPages(), `Relatório de ${title}`);
                        }
                    }


                    doc.save(`Relatorio_${title.replace(/\s+/g, '_')}.pdf`);
                } catch (error) {
                    console.error(`Erro ao gerar relatório de ${title}:`, error);
                    alert(`Ocorreu um erro ao gerar o relatório de ${title}: ${error.message}`);
                }
            };
            const sendWhatsApp = (pedido) => {
                if (!pedido || !pedido.clienteId) {
                    alert("Dados do pedido ou cliente incompletos para enviar WhatsApp.");
                    return;
                }
                const cliente = getClientById(pedido.clienteId);
                let telefoneCliente = cliente.contato || state.configuracoes.empresa?.empresaContato;
                if (!telefoneCliente) {
                    alert("Número de telefone do cliente não encontrado. Verifique o cadastro do cliente ou as configurações da empresa.");
                    return;
                }
                telefoneCliente = telefoneCliente.replace(/\D/g, '');
                if (telefoneCliente.length < 10) {
                    alert("Número de telefone inválido. Verifique o cadastro.");
                    return;
                }
                if (!telefoneCliente.startsWith('55') && (telefoneCliente.length === 10 || telefoneCliente.length === 11)) {
                    telefoneCliente = '55' + telefoneCliente;
                }


                const servicosList = pedido.servicos ? pedido.servicos.split('\n').map(s => `- ${s.trim()}`).join('%0A') : 'Não especificados';
                const mensagem = `Olá ${cliente.nome || 'Cliente'},%0A%0AConfirmamos os detalhes do seu pedido para o evento *${pedido.tipoEvento || 'Evento'}*:%0A
Data: *${formatDate(pedido.dataEvento)}*%0A
Horário: *${pedido.horaInicio || ''} às ${pedido.horaFinal || ''}*%0A
Local: *${pedido.localEvento || 'A confirmar'}*%0A
${pedido.temaEvento ? `Tema: *${pedido.temaEvento}*%0A` : ''}
${pedido.numeroPessoas ? `Nº de Pessoas: *${pedido.numeroPessoas}*%0A` : ''}
Serviços Inclusos:%0A${servicosList}%0A
Valor Total: *${formatCurrency(pedido.valorTotal)}*%0A
${pedido.observacoes ? `%0AObservações: ${pedido.observacoes}%0A` : '%0A'}
Agradecemos a preferência!%0A
Atenciosamente,%0A
${state.configuracoes.empresa?.empresaNome || 'DJ Profissional'}`;
                const linkWhatsApp = `https://wa.me/${telefoneCliente}?text=${mensagem}`;
                window.open(linkWhatsApp, '_blank');
            };

            const exportData = () => {
                try {
                    const dataToExport = {
                        version: "5.4",
                        timestamp: new Date().toISOString(),
                        pedidos: state.pedidos,
                        clientes: state.clientes,
                        agenda: state.agenda,
                        materiais: state.materiais,
                        servicos: state.servicos,
                        financeiro: state.financeiro,
                        configuracoes: state.configuracoes,
                        users: state.users,
                        dismissedBirthdayAlerts: JSON.parse(localStorage.getItem('dismissedBirthdayAlerts')) || {}
                    };
                    const jsonString = JSON.stringify(dataToExport, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_dj_pro_system_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert("Backup exportado com sucesso! Guarde o arquivo em local seguro.");
                } catch (e) {
                    console.error("Erro ao exportar dados:", e);
                    alert("Erro ao exportar dados. Verifique o console para mais detalhes.");
                }
            };
            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedState = JSON.parse(e.target.result);
                        if (!importedState || (importedState.version && importedState.version !== "5.4" && !confirm(`Este backup parece ser de uma versão diferente (${importedState.version || 'desconhecida'}). Continuar a importação pode causar problemas. Deseja continuar mesmo assim?`))) {
                           if (importedState.version && importedState.version !== "5.4") {
                                alert("Importação cancelada devido à versão incompatível.");
                                if (selectors.importFile) selectors.importFile.value = '';
                                return;
                           }
                           if(!importedState) {
                                alert("Arquivo de backup inválido ou corrompido.");
                                if (selectors.importFile) selectors.importFile.value = '';
                                return;
                           }
                        }

                        if (confirm("ATENÇÃO: Importar este backup substituirá TODOS os dados atuais do sistema. Esta ação é irreversível. Deseja continuar?")) {
                            state.pedidos = importedState.pedidos || [];
                            state.clientes = importedState.clientes || [];
                            state.agenda = importedState.agenda || [];
                            state.materiais = importedState.materiais || [];
                            state.servicos = importedState.servicos || [];
                            state.financeiro = importedState.financeiro || [];
                            state.configuracoes = importedState.configuracoes || { logo: null, empresa: {} };
                            state.users = importedState.users || [{id: 'user_default', username: 'admin', password: '123'}];
                            if (!state.users || state.users.length === 0) {
                                state.users = [{id: 'user_default', username: 'admin', password: '123'}];
                                await saveData('users_v4', state.users);
                            }
                            localStorage.setItem('dismissedBirthdayAlerts', JSON.stringify(importedState.dismissedBirthdayAlerts || {}));


                            await saveData('pedidos_v4', state.pedidos);
                            await saveData('clientes_v4', state.clientes);
                            await saveData('agenda_v4', state.agenda);
                            await saveData('materiais_v4', state.materiais);
                            await saveData('servicos_v4', state.servicos);
                            await saveData('financeiro_v4', state.financeiro);
                            await saveData('configuracoes_v4', state.configuracoes);
                            await saveData('users_v4', state.users);


                            alert("Dados importados com sucesso! A página será recarregada.");
                            location.reload();
                        }
                    } catch (err) {
                        console.error("Erro ao importar dados:", err);
                        alert("Erro ao importar dados. O arquivo pode estar corrompido ou em formato inválido.");
                    } finally {
                        if (selectors.importFile) selectors.importFile.value = '';
                    }
                };
                reader.readAsText(file);
            };
            // ==================================================================
            // 8. FUNÇÕES GLOBAIS (chamadas por botões) e LISTENERS PRINCIPAIS
            // ==================================================================
            window.generateContract = generateContractPDF;
            window.generateReceipt = (financeId) => {
                const financeEntry = state.financeiro.find(f => f.id === financeId);
                if (!financeEntry) { alert("Lançamento financeiro não encontrado para gerar recibo."); return;
                }
                generateReceiptPDF(financeEntry);
            };
            // Event Listeners for main cards
            selectors.cards.forEach(c => {
                if (c) c.onclick = () => {
                    console.log(`Card clicked: ${c.dataset.tab}`); // Debugging
                    showTab(c.dataset.tab);
                };
            });
            if (selectors.settingsButton) selectors.settingsButton.onclick = () => showTab('configuracoes');
            if (selectors.btnAddPedido) selectors.btnAddPedido.onclick = () => openPedidoModal();
            if (selectors.btnAddCliente) selectors.btnAddCliente.onclick = () => openClientModal();
            if (selectors.btnAddAgenda) selectors.btnAddAgenda.onclick = () => openAddAgendaModal();
            if (selectors.btnAddMaterial) selectors.btnAddMaterial.onclick = () => openMaterialModal();
            if (selectors.btnAddServico) selectors.btnAddServico.onclick = () => openServicoModal();
            if (selectors.btnAddDespesa) selectors.btnAddDespesa.onclick = () => openDespesaModal();

            if (selectors.pedidoForm) {
                selectors.pedidoForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const pedidoSalvo = await savePedido();
                    if (pedidoSalvo) {
                        closeModal(selectors.pedidoModal);
                    }
                };
            }
            if (selectors.btnDownloadPdf) {
                selectors.btnDownloadPdf.onclick = async () => {
                    const pedidoId = selectors.pedidoForm ? selectors.pedidoForm.querySelector('[name="id"]').value : null;
                    let pedidoParaGerar = null;

                    if (pedidoId) {
                        pedidoParaGerar = getPedidoById(pedidoId);
                        const formData = new FormData(selectors.pedidoForm);
                        const dataFromForm = {};
                        formData.forEach((v, k) => dataFromForm[k] = v);
                        if (pedidoParaGerar && pedidoParaGerar.id) {
                            pedidoParaGerar = {...pedidoParaGerar, ...dataFromForm};
                        } else {
                             pedidoParaGerar = await savePedido();
                        }
                    } else {
                        pedidoParaGerar = await savePedido();
                    }

                    if (pedidoParaGerar && pedidoParaGerar.id) {
                        generateOrderPDF(pedidoParaGerar);
                    } else {
                        alert("Por favor, preencha todos os campos obrigatórios do pedido antes de gerar o PDF. Se for um novo pedido, clique em 'Salvar Pedido' primeiro.");
                    }
                };
            }
            if (selectors.btnSendWhatsapp) {
                selectors.btnSendWhatsapp.onclick = async () => {
                    const pedidoId = selectors.pedidoForm ? selectors.pedidoForm.querySelector('[name="id"]').value : null;
                    let pedidoParaEnviar = null;

                    if (pedidoId) {
                        pedidoParaEnviar = getPedidoById(pedidoId);
                        const formData = new FormData(selectors.pedidoForm);
                        const dataFromForm = {};
                        formData.forEach((v, k) => dataFromForm[k] = v);
                        if (pedidoParaEnviar && pedidoParaEnviar.id) {
                            pedidoParaEnviar = {...pedidoParaEnviar, ...dataFromForm};
                        } else {
                            pedidoParaEnviar = await savePedido();
                        }
                    } else {
                        pedidoParaEnviar = await savePedido();
                    }

                    if (pedidoParaEnviar && pedidoParaEnviar.id) {
                        sendWhatsApp(pedidoParaEnviar);
                    } else {
                         alert("Por favor, preencha e salve o pedido antes de enviar por WhatsApp.");
                    }
                };
            }
            if (selectors.clientForm) selectors.clientForm.onsubmit = (e) => handleFormSubmit(e, 'clientes', selectors.clientForm, selectors.clientModal, displayClientes);
            if (selectors.addAgendaForm) selectors.addAgendaForm.onsubmit = (e) => handleFormSubmit(e, 'agenda', selectors.addAgendaForm, selectors.addAgendaModal, displayAgenda);
            if (selectors.materialForm) selectors.materialForm.onsubmit = (e) => handleFormSubmit(e, 'materiais', selectors.materialForm, selectors.materialModal, displayMateriaisEstoque);
            if (selectors.servicoForm) selectors.servicoForm.onsubmit = (e) => handleFormSubmit(e, 'servicos', selectors.servicoForm, selectors.servicoModal, displayServicos);
            if (selectors.despesaForm) {
                selectors.despesaForm.onsubmit = async (e) => {
                     e.preventDefault();
                     if (!selectors.despesaForm.checkValidity()) { selectors.despesaForm.reportValidity(); return; }
                     const formData = new FormData(selectors.despesaForm);
                     const valorDespesa = parseFloat(formData.get('valor')) || 0;
                     if (valorDespesa <= 0) { alert("O valor da despesa deve ser positivo."); return;
                     }

                     const despesaData = {
                        id: formData.get('id') || generateId('des'),
                        tipo: 'despesa',
                        status: 'pago',
                        descricao: formData.get('descricao'),
                        data: formData.get('data'),
                        valor: valorDespesa
                    };
                     if (formData.get('id')) {
                        const index = state.financeiro.findIndex(f => f.id === formData.get('id'));
                        if (index !== -1) state.financeiro[index] = despesaData;
                    } else {
                        state.financeiro.push(despesaData);
                    }
                     await saveData('financeiro_v4', state.financeiro);
                    alert('Despesa salva!'); closeModal(selectors.despesaModal); displayFinanceiro();
                };
            }

            if (selectors.pagamentoForm) {
                selectors.pagamentoForm.onsubmit = async (e) => {
                    e.preventDefault();
                    if (!selectors.pagamentoForm.checkValidity()) { selectors.pagamentoForm.reportValidity(); return; }

                    const formData = new FormData(selectors.pagamentoForm);
                    const valorPago = parseFloat(formData.get('valor')) || 0;
                    const formaPagamento = formData.get('formaPagamento');
                    const pedidoId = formData.get('pedidoId');
                    if (valorPago <= 0) { alert("O valor recebido deve ser positivo."); return;
                    }

                    const newReceipt = {
                        id: generateId('rec'),
                        tipo: 'receita',
                        status: 'pago',
                        descricao: formData.get('descricao'),
                        data: formData.get('data'),
                        valor: valorPago,
                        pedidoId: pedidoId || null,
                        formaPagamento: formaPagamento
                    };
                    state.financeiro.push(newReceipt);
                    await saveData('financeiro_v4', state.financeiro);
                    alert('Pagamento lançado com sucesso!');
                    closeModal(selectors.pagamentoModal);

                    if (pedidoId) {
                        const relatedPedido = getPedidoById(pedidoId);
                        if (relatedPedido && relatedPedido.id) {
                            await handlePedidoIntegrations(relatedPedido, false);
                        }
                    }
                    displayFinanceiro();
                    displayPedidos();

                    if(confirm("Deseja gerar o recibo para este pagamento agora?")) {
                        generateReceiptPDF(newReceipt);
                    }
                };
            }
            if (selectors.configForm) {
                selectors.configForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const formData = new FormData(selectors.configForm);
                    if (!state.configuracoes.empresa) state.configuracoes.empresa = {};
                    formData.forEach((v, k) => state.configuracoes.empresa[k] = v);
                    await saveData('configuracoes_v4', state.configuracoes);
                    alert('Dados da empresa salvos!');
                };
            }
            if (selectors.logoUpload) {
                selectors.logoUpload.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    if (file.size > 500000) {
                        alert("A imagem da logomarca é muito grande (máx 500KB). Por favor, escolha uma menor.");
                        selectors.logoUpload.value = '';
                        return;
                    }
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        state.configuracoes.logo = reader.result;
                        await saveData('configuracoes_v4', state.configuracoes);
                        displayConfig();
                    };
                    reader.readAsDataURL(file);
                };
            }
            if (selectors.btnRemoveLogo) {
                selectors.btnRemoveLogo.onclick = async () => {
                    if (confirm("Tem certeza que deseja remover a logomarca?")) {
                        state.configuracoes.logo = null;
                        await saveData('configuracoes_v4', state.configuracoes);
                        if (selectors.logoUpload) selectors.logoUpload.value = '';
                        displayConfig();
                    }
                };
            }
            if (selectors.btnExportData) selectors.btnExportData.onclick = exportData;
            if (selectors.btnImportData) selectors.btnImportData.onclick = () => { if (selectors.importFile) selectors.importFile.click(); };
            if (selectors.importFile) selectors.importFile.onchange = importData;

            document.querySelectorAll('.close-button, .close-btn').forEach(btn => {
                if (btn) btn.onclick = (e) => {
                    e.preventDefault();
                    const modalToClose = btn.closest('.modal');
                    if (modalToClose) closeModal(modalToClose);
                };
            });
            window.onclick = (e) => { if (e.target.classList.contains('modal')) closeModal(e.target); };

            selectors.filterButtons.forEach(b => {
                if (b) b.onclick = (e) => {
                    selectors.filterButtons.forEach(btn => btn.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    state.currentFilter = e.currentTarget.dataset.filter;
                    displayPedidos();
                };
            });
            selectors.financeFilterButtons.forEach(b => {
                if (b) b.onclick = (e) => {
                    selectors.financeFilterButtons.forEach(btn => btn.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    state.financeFilter = e.currentTarget.dataset.filter;
                    displayFinanceiro();
                };
            });
            if (selectors.btnFilterDate) selectors.btnFilterDate.onclick = () => displayFinanceiro();
            if (selectors.btnClearDateFilter) {
                selectors.btnClearDateFilter.onclick = () => {
                    if (selectors.financeStartDate) selectors.financeStartDate.value = '';
                    if (selectors.financeEndDate) selectors.financeEndDate.value = '';
                    displayFinanceiro();
                };
            }

            if (selectors.linkAddClienteModal) selectors.linkAddClienteModal.onclick = (e) => { e.preventDefault(); closeModal(selectors.pedidoModal); openClientModal(); };
            if (selectors.btnClearData) {
                selectors.btnClearData.onclick = async () => {
                    if (confirm("TEM CERTEZA ABSOLUTA?\n\nTodos os dados do sistema (pedidos, clientes, financeiros, etc.) serão PERMANENTEMENTE APAGADOS.\n\nEsta ação NÃO PODE ser desfeita! Deseja continuar?")) {
                        if(confirm("ÚLTIMO AVISO!\n\nCONFIRMA A EXCLUSÃO DE TODOS OS DADOS DO SISTEMA?")){
                            try {
                                const storesToClear = ['pedidos', 'clientes', 'agenda', 'materiais', 'servicos', 'financeiro', 'configuracoes', 'users'];
                                if (!db) await openDb();

                                const transaction = db.transaction(storesToClear, 'readwrite');
                                await Promise.all(storesToClear.map(storeName => {
                                    return new Promise((resolve, reject) => {
                                        const request = transaction.objectStore(storeName).clear();
                                        request.onsuccess = resolve;
                                        request.onerror = reject;
                                    });
                                }));
                                localStorage.removeItem('dismissedBirthdayAlerts');

                                alert("Todos os dados foram apagados. A página será recarregada.");
                                location.reload();
                            } catch (e) {
                                console.error("Erro ao tentar apagar dados:", e);
                                alert("Ocorreu um erro ao apagar os dados. Tente limpar o cache do navegador e os dados do site manualmente, ou contate o suporte.");
                            }
                        }
                    }
                };
            }
            if (selectors.btnCompleteAgenda) {
                selectors.btnCompleteAgenda.onclick = async () => {
                    const agendaId = selectors.agendaDetailsForm ? selectors.agendaDetailsForm.querySelector('[name="id"]').value : null;
                    const agendaItem = getAgendaById(agendaId);
                    if (agendaItem) {
                        agendaItem.status = 'concluido';
                        if (selectors.agendaDetailsForm) agendaItem.obsAgenda = selectors.agendaDetailsForm.querySelector('[name="obsAgenda"]').value;
                        await saveData('agenda_v4', state.agenda);

                        if (agendaItem.pedidoId) {
                            const pedido = getPedidoById(agendaItem.pedidoId);
                            if (pedido && pedido.status !== 'cancelado') {
                                pedido.status = 'concluido';
                                await saveData('pedidos_v4', state.pedidos);
                                await handlePedidoIntegrations(pedido, false);
                            }
                        }
                        alert('Compromisso marcado como Concluído!');
                        closeModal(selectors.agendaDetailsModal);
                        displayAgenda(); displayPedidos(); checkPendingOrders();
                    }
                };
            }
            if (selectors.btnCancelAgenda) {
                selectors.btnCancelAgenda.onclick = async () => {
                    const agendaId = selectors.agendaDetailsForm ? selectors.agendaDetailsForm.querySelector('[name="id"]').value : null;
                    const agendaItem = getAgendaById(agendaId);
                    if (agendaItem) {
                        agendaItem.status = 'cancelado';
                        if (selectors.agendaDetailsForm) agendaItem.obsAgenda = selectors.agendaDetailsForm.querySelector('[name="obsAgenda"]').value;
                        await saveData('agenda_v4', state.agenda);

                        if (agendaItem.pedidoId) {
                            const pedido = getPedidoById(agendaItem.pedidoId);
                            if (pedido && pedido.status !== 'concluido') {
                                pedido.status = 'cancelado';
                                await saveData('pedidos_v4', state.pedidos);
                                await handlePedidoIntegrations(pedido, false);
                            }
                        }
                        alert('Compromisso marcado como Cancelado!');
                        closeModal(selectors.agendaDetailsModal);
                        displayAgenda(); displayPedidos(); checkPendingOrders();
                    }
                };
            }
            if (selectors.btnSaveAgendaDetails) {
                selectors.btnSaveAgendaDetails.onclick = async () => {
                    const agendaId = selectors.agendaDetailsForm ? selectors.agendaDetailsForm.querySelector('[name="id"]').value : null;
                    const agendaItem = getAgendaById(agendaId);
                    if (agendaItem) {
                        if (selectors.agendaDetailsForm) agendaItem.obsAgenda = selectors.agendaDetailsForm.querySelector('[name="obsAgenda"]').value;
                        const newStatus = selectors.statusAgendaSelect ? selectors.statusAgendaSelect.value : agendaItem.status;

                        if (agendaItem.status !== newStatus) {
                            agendaItem.status = newStatus;
                            if (agendaItem.pedidoId) {
                                const pedido = getPedidoById(agendaItem.pedidoId);
                                if (pedido) {
                                    if (newStatus === 'cancelado' && pedido.status !== 'concluido') pedido.status = 'cancelado';
                                    else if (newStatus === 'concluido' && pedido.status !== 'cancelado') pedido.status = 'concluido';
                                    await saveData('pedidos_v4', state.pedidos);
                                    await handlePedidoIntegrations(pedido, false);
                                    displayPedidos();
                                }
                            }
                        }
                        await saveData('agenda_v4', state.agenda);
                        alert('Detalhes do compromisso salvos!');
                        closeModal(selectors.agendaDetailsModal);
                        displayAgenda();
                        checkPendingOrders();
                    }
                };
            }
            if (selectors.btnViewList) selectors.btnViewList.onclick = () => { state.agendaView = 'list'; displayAgenda(); };
            if (selectors.btnViewCalendar) selectors.btnViewCalendar.onclick = () => { state.agendaView = 'calendar'; displayAgenda(); };

            const addSearchListener = (inputId, displayFn) => {
                const inputElement = selectors[inputId];
                if (inputElement) {
                    inputElement.addEventListener('input', displayFn);
                } else {
                    console.warn(`Elemento de pesquisa ${inputId} não encontrado nos seletores.`);
                }
            };
            addSearchListener('searchPedidos', displayPedidos);
            addSearchListener('searchAgenda', displayAgenda);
            addSearchListener('searchClientes', displayClientes);
            addSearchListener('searchMateriais', displayMateriaisEstoque);
            addSearchListener('searchServicos', displayServicos);
            addSearchListener('searchFinanceiro', displayFinanceiro);

            // ==================================================================
            // 9. LISTENERS DOS BOTÕES DE RELATÓRIO
            // ==================================================================
            if (selectors.btnReportPedidos) {
                selectors.btnReportPedidos.onclick = () => {
                    const headers = ["ID", "Cliente", "Tipo", "Data", "Status", "Valor Total", "Valor Pago"];
                    const dataMapper = p => {
                        const totalPago = state.financeiro.filter(f => f.pedidoId === p.id && f.tipo === 'receita').reduce((sum, f) => sum + parseFloat(f.valor), 0);
                        return [
                            p.id.substring(4,10), getClientNameById(p.clienteId), p.tipoEvento, formatDate(p.dataEvento),
                            p.status, formatCurrency(p.valorTotal), formatCurrency(totalPago)
                        ];
                    };
                    generateReportPDF('pedidos', 'Relatório de Pedidos', headers, dataMapper, p => state.currentFilter === 'todos' || p.status === state.currentFilter || (state.currentFilter === 'sinal_pendente' && p.status === 'pendente' && new Date(`${p.dataEvento}T00:00:00`) <= new Date().setHours(0,0,0,0) && state.financeiro.filter(f => f.pedidoId === p.id && f.tipo === 'receita').reduce((sum, f) => sum + parseFloat(f.valor), 0) < (parseFloat(p.valorTotal) * 0.5)) || (state.currentFilter === 'nao_pagos' && parseFloat(p.valorTotal) > 0.01 && state.financeiro.filter(f => f.pedidoId === p.id && f.tipo === 'receita').reduce((sum, f) => sum + parseFloat(f.valor), 0) <= 0.01));
                };
            }
            if (selectors.btnReportAgenda) {
                selectors.btnReportAgenda.onclick = () => {
                    const headers = ["Data", "Horário", "Descrição", "Cliente", "Status", "Obs."];
                    const dataMapper = a => [
                        formatDate(a.data), a.horario, a.descricao,
                        a.cliente || (a.pedidoId ? getClientNameById(getPedidoById(a.pedidoId)?.clienteId) : 'N/A'),
                        a.status, a.obsAgenda || ''
                    ];
                    const sortedAgenda = [...state.agenda].sort((a,b) => new Date(a.data) - new Date(b.data));
                    generateReportPDF('agenda', 'Relatório de Agenda', headers, dataMapper, null, sortedAgenda);
                };
            }
            if (selectors.btnReportFinanceiro) {
                selectors.btnReportFinanceiro.onclick = () => {
                    const headers = ["Data", "Tipo", "Descrição", "Valor", "Status/Pedido"];
                    const dataMapper = f => [
                        formatDate(f.data), f.tipo, f.descricao, formatCurrency(f.valor),
                        f.pedidoId ? `Ref. Pedido #${f.pedidoId.substring(4,10)}` : (f.status || (f.tipo === 'despesa' ? 'Pago' : 'Pendente'))
                    ];
                    const startDate = selectors.financeStartDate ? selectors.financeStartDate.value : null;
                    const endDate = selectors.financeEndDate ? selectors.financeEndDate.value : null;
                    const currentFinFilter = state.financeFilter;
                    const filteredFinanceData = state.financeiro.filter(f => {
                        const typeMatch = currentFinFilter === 'todos' || f.tipo === currentFinFilter || (currentFinFilter === 'a_receber' && f.tipo === 'a_receber');
                        let dateMatch = true;
                        if (startDate && endDate) dateMatch = f.data >= startDate && f.data <= endDate;
                        else if (startDate) dateMatch = f.data >= startDate;
                        else if (endDate) dateMatch = f.data <= endDate;
                        return typeMatch && dateMatch;
                    }).sort((a,b) => new Date(a.data) - new Date(b.data));
                    generateReportPDF('financeiro_completo', 'Relatório Financeiro Completo', headers, dataMapper, null, filteredFinanceData);
                };
            }
            if (selectors.btnReportClientes) {
                selectors.btnReportClientes.onclick = () => {
                    const headers = ["Nome", "Contato", "Email", "Aniversário", "Endereço", "Observações"];
                    const dataMapper = c => [c.nome, c.contato, c.emailCliente, formatDate(c.aniversario), c.enderecoCliente, c.obs];
                    generateReportPDF('clientes', 'Relatório de Clientes', headers, dataMapper);
                };
            }
            if (selectors.btnReportMateriais) {
                selectors.btnReportMateriais.onclick = () => {
                    const headers = ["Item", "Quantidade", "Observações"];
                    const dataMapper = m => [m.item, m.quantidade, m.obs];
                    generateReportPDF('materiais', 'Relatório de Materiais', headers, dataMapper);
                };
            }
            if (selectors.btnReportServicos) {
                selectors.btnReportServicos.onclick = () => {
                    const headers = ["Serviço", "Descrição", "Valor Base"];
                    const dataMapper = s => [s.nome, s.descricao, formatCurrency(s.valor)];
                    generateReportPDF('servicos', 'Relatório de Serviços', headers, dataMapper);
                };
            }

            // Novo botão para o relatório de Sinal Pendente
            if (selectors.btnReportSinalPendente) {
                selectors.btnReportSinalPendente.onclick = () => {
                    const headers = ["ID Pedido", "Cliente", "Tipo Evento", "Data Evento", "Valor Total", "Valor Pago", "Falta Pagar"];
                    const dataMapper = p => {
                        const totalPago = state.financeiro
                            .filter(f => f.pedidoId === p.id && f.tipo === 'receita')
                            .reduce((sum, f) => sum + parseFloat(f.valor), 0);
                        const valorTotal = parseFloat(p.valorTotal) || 0;
                        const faltaPagar = valorTotal - totalPago;
                        return [
                            p.id.substring(4, 10),
                            getClientNameById(p.clienteId),
                            p.tipoEvento,
                            formatDate(p.dataEvento),
                            formatCurrency(valorTotal),
                            formatCurrency(totalPago),
                            formatCurrency(faltaPagar)
                        ];
                    };
                    generateReportPDF('sinal_pendente', 'Relatório de Sinal Pendente (50%)', headers, dataMapper);
                };
            }

            // ==================================================================
            // 10. Lógica de Autenticação e Gerenciamento de Usuários
            // ==================================================================
            if (selectors.btnLogout) {
                selectors.btnLogout.addEventListener('click', () => {
                    const confirmBackup = confirm("Deseja fazer um backup dos dados do sistema antes de sair?");
                    if (confirmBackup) {
                        exportData();
                    }
                    state = {
                        pedidos: [], clientes: [], agenda: [], materiais: [],
                        servicos: [], financeiro: [], configuracoes: { logo: null, empresa: {} },
                        users: [{id: 'user_default', username: 'admin', password: '123'}],
                        currentFilter: 'todos',
                        financeFilter: 'todos',
                        agendaView: 'calendar',
                        currentCalendarDate: new Date(),
                    };
                    indexedDB.deleteDatabase(DB_NAME);
                    localStorage.clear();
                    alert("Logout realizado. Todos os dados locais foram apagados. Recarregando a página.");
                    location.reload();
                });
            }
            if (selectors.userForm) {
                selectors.userForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const userIdInput = selectors.userForm.querySelector('[name="id"]');
                    const usernameInput = selectors.userForm.querySelector('[name="username"]');
                    const passwordInput = selectors.userForm.querySelector('[name="password"]');

                    if (!usernameInput || !passwordInput || !usernameInput.value.trim() || !passwordInput.value.trim()) {
                        alert("Usuário e senha são obrigatórios.");
                        return;
                    }

                    if (userIdInput.value) {
                        const index = state.users.findIndex(u => u.id === userIdInput.value);
                        if (index !== -1) {
                            if (state.users.some(u => u.username === usernameInput.value.trim() && u.id !== userIdInput.value)) {
                                alert('Este nome de usuário já está em uso por outro usuário. Escolha um diferente.');
                                return;
                            }
                            state.users[index].username = usernameInput.value.trim();
                            state.users[index].password = passwordInput.value;
                            alert('Usuário atualizado com sucesso!');
                        }
                    } else {
                        if (state.users.some(u => u.username === usernameInput.value.trim())) {
                            alert('Nome de usuário já existe. Escolha outro.');
                            return;
                        }
                        state.users.push({
                            id: generateId('user'),
                            username: usernameInput.value.trim(),
                            password: passwordInput.value
                        });
                        alert('Usuário adicionado com sucesso!');
                    }
                    await saveData('users_v4', state.users);
                    selectors.userForm.reset();
                    if (userIdInput) userIdInput.value = '';
                    if (selectors.btnSaveUser) selectors.btnSaveUser.textContent = 'Salvar Usuário';
                    if (selectors.btnCancelUserEdit) selectors.btnCancelUserEdit.style.display = 'none';
                    displayUsers();
                });
            }
            window.editUser = (userId) => {
                const user = state.users.find(u => u.id === userId);
                if (user && selectors.userForm) {
                    const userIdInput = selectors.userForm.querySelector('[name="id"]');
                    const usernameInput = selectors.userForm.querySelector('[name="username"]');
                    const passwordInput = selectors.userForm.querySelector('[name="password"]');

                    if (userIdInput) userIdInput.value = user.id;
                    if (usernameInput) usernameInput.value = user.username;
                    if (passwordInput) {
                        passwordInput.value = '';
                        passwordInput.placeholder = 'Digite nova senha para alterar';
                    }
                    if (selectors.btnSaveUser) selectors.btnSaveUser.textContent = 'Atualizar Usuário';
                    if (selectors.btnCancelUserEdit) selectors.btnCancelUserEdit.style.display = 'inline-block';
                }
            };
            if (selectors.btnCancelUserEdit) {
                selectors.btnCancelUserEdit.onclick = () => {
                    if (selectors.userForm) {
                        const userIdInput = selectors.userForm.querySelector('[name="id"]');
                        const passwordInput = selectors.userForm.querySelector('[name="password"]');
                        selectors.userForm.reset();
                        if (userIdInput) userIdInput.value = '';
                        if (passwordInput) passwordInput.placeholder = '';
                    }
                    if (selectors.btnSaveUser) selectors.btnSaveUser.textContent = 'Salvar Usuário';
                    if (selectors.btnCancelUserEdit) selectors.btnCancelUserEdit.style.display = 'none';
                };
            }
            // ==================================================================
            // 11. INICIALIZAÇÃO DA APLICAÇÃO
            // ==================================================================
            const loadAllData = async () => {
                state.pedidos = await loadData('pedidos_v4', []);
                state.clientes = await loadData('clientes_v4', []);
                state.agenda = await loadData('agenda_v4', []);
                state.materiais = await loadData('materiais_v4', []);
                state.servicos = await loadData('servicos_v4', []);
                state.financeiro = await loadData('financeiro_v4', []);
                state.configuracoes = await loadData('configuracoes_v4', { logo: null, empresa: {} });
                state.users = await loadData('users_v4', [{id: 'user_default', username: 'admin', password: '123'}]);
                if (!state.users || state.users.length === 0) {
                    state.users = [{id: 'user_default', username: 'admin', password: '123'}];
                    await saveData('users_v4', state.users);
                }
            };
            const initApp = async () => {
                console.log("Iniciando initApp...");

                if (navigator.storage && navigator.storage.persist) {
                    try {
                        const isPersistent = await navigator.storage.persist();
                        console.log(isPersistent ? "Armazenamento persistente concedido." : "Armazenamento persistente NÃO concedido.");
                    } catch (error) { console.error("Erro ao solicitar armazenamento persistente:", error);
                    }
                }

                await openDb();
                await loadAllData();

                // Garante que o sistema principal seja exibido
                if (selectors.mainSystem) {
                    selectors.mainSystem.style.display = 'block';
                } else {
                    console.error("Elemento #mainSystem não encontrado. O sistema principal pode não estar visível.");
                    return; // Interrompe a inicialização se o elemento principal não for encontrado
                }

                displayConfig();
                populateClientSelect();
                checkBirthdays();
                checkPendingOrders();

                // Tenta exibir a aba "pedidos" por padrão
                showTab('pedidos');

                // Lógica de visualização da agenda (lista/calendário)
                if (selectors.agendaListView && selectors.searchAgendaContainerList && selectors.agendaCalendarView && selectors.btnViewList && selectors.btnViewCalendar) {
                    if (state.agendaView === 'calendar') {
                        selectors.agendaListView.style.display = 'none';
                        selectors.searchAgendaContainerList.style.display = 'none';
                        selectors.agendaCalendarView.style.display = 'block';
                        selectors.btnViewList.classList.remove('active');
                        selectors.btnViewCalendar.classList.add('active');
                    } else {
                        selectors.agendaListView.style.display = 'block';
                        selectors.searchAgendaContainerList.style.display = 'flex';
                        selectors.agendaCalendarView.style.display = 'none';
                        selectors.btnViewList.classList.add('active');
                        selectors.btnViewCalendar.classList.remove('active');
                    }
                } else {
                    console.warn("Alguns elementos da interface da Agenda (visão lista/calendário/botões) não foram encontrados. A funcionalidade pode estar limitada.");
                }

                renderCalendar();

                // Renderização inicial dos gráficos no financeiro
                renderMonthlyRevenueChart();
                renderRevenueExpenseChart();

                console.log("CRM DJ V5.4 - Inicialização Concluída. Sistema pronto.");
            };

            initApp();
        });
    </script>
</body>
</html>
