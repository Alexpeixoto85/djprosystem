<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema para DJs - V5.4 Completo e Otimizado</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #6a5acd; /* Roxo */
            --primary-hover: #5340b8;
            --background-soft: #f0f2f5;
            --background-card: #f9f9f9;
            --background-white: #ffffff;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #eee;
            --danger-color: #d9534f;
            --danger-hover: #c9302c;
            --success-color: #5cb85c;
            --warning-color: #f0ad4e;
            --info-color: #5bc0de;
            --contract-color: #4CAF50;
            --contract-hover: #45a049;
            --receipt-color: #007bff;
            --receipt-hover: #0056b3;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--background-soft); 
            margin: 0; 
            padding: 10px; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            min-height: 100vh; 
            font-size: 16px; 
            line-height: 1.4; /* Otimização: Diminui o espaçamento padrão */
        }
        .container { 
            background-color: var(--background-white); 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
            width: 100%; 
            max-width: 1200px; 
            box-sizing: border-box; 
            line-height: 1.3; /* Otimização: Diminui o espaçamento em todo o container */
        }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { background-color: var(--background-card); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; align-items: center; text-align: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; cursor: pointer; border-left: 5px solid var(--primary-color);}
        .card:hover { transform: translateY(-5px); box-shadow: 0 6px 10px rgba(0,0,0,0.1); }
        .icon-card { font-size: 2em; margin-bottom: 10px; color: var(--primary-color); }
        .card span { font-weight: bold; color: var(--text-primary); font-size: 1em; }
        .atalhos-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .settings-button { background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-secondary); transition: color 0.2s; }
        .settings-button:hover { color: var(--primary-color); }
        .btn-add { font-size: 1em; padding: 10px 15px; margin-bottom: 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: background-color 0.2s; float: right; }
        .btn-add:hover { background-color: var(--primary-hover); }
        .btn-add .fas { font-size: 0.9em; }
        .btn-add-full { width: 100%; margin-bottom: 20px; font-size: 1.1em; padding: 12px; }
        .tab-content { margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px; display: none; clear: both; }
        .tab-content.active { display: block; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .form-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; } /* Otimização: Reduz gap e margin-bottom */
        .form-group { flex: 1 1 48%; min-width: 200px; margin-bottom: 0; } /* Otimização: Remove margin-bottom individual */
        .form-group.full-width { flex: 1 1 100%; }
        .form-group label { display: block; margin-bottom: 3px; font-weight: bold; color: #555; font-size: 0.9em; } /* Otimização: Reduz margin-bottom e font-size */
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9em; box-sizing: border-box; } /* Otimização: Reduz padding e font-size */
        .form-actions { margin-top: 15px; text-align: right; display: flex; justify-content: flex-end; gap: 10px; flex-wrap: wrap;} /* Otimização: Reduz margin-top */
        .btn { background-color: var(--primary-color); color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s; } /* Otimização: Reduz padding e font-size */
        .btn:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: #ccc; color: var(--text-primary); }
        .btn-secondary:hover { background-color: #bbb; }
        .btn-small { padding: 5px 8px; font-size: 0.8em; margin: 0 2px; } /* Otimização: Ajuste para small buttons */
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: var(--danger-hover); }
        .btn-success { background-color: var(--success-color); }
        .btn-whatsapp { background-color: #25D366; } .btn-whatsapp:hover { background-color: #1EAE51; }
        .btn-pdf { background-color: #E63946; } .btn-pdf:hover { background-color: #c02d38; }
        .btn-info { background-color: var(--info-color); }
        .btn-contract { background-color: var(--contract-color); } .btn-contract:hover { background-color: var(--contract-hover); }
        .btn-receipt { background-color: var(--receipt-color); } .btn-receipt:hover { background-color: #0056b3; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; padding: 5px; box-sizing: border-box;} /* Otimização: Ajusta padding modal */
        .modal-content { background-color: var(--background-white); margin: 1% auto; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 98%; max-width: 700px; position: relative; max-height: 98vh; overflow-y: auto; } /* Otimização: Ajusta margin, padding, max-width/height */
        .close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 30px; font-weight: bold; cursor: pointer; }
        .close-button:hover { color: black; }
        .generic-table-container { width: 100%; overflow-x: auto; border: 1px solid #ddd; border-radius: 5px; margin-top: 15px; clear: both; } /* Otimização: Reduz margin-top */
        .generic-table { width: 100%; border-collapse: collapse; font-size: 0.85em; min-width: 600px; } /* Otimização: Reduz font-size */
        .generic-table th, .generic-table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; line-height: 1.2; } /* Otimização: Reduz padding e line-height */
        .generic-table th { background-color: var(--background-card); color: #555; font-weight: bold; position: sticky; top: 0; z-index: 1; }
        .generic-table tr:hover { background-color: #f0f0f0; }
        .generic-table td { white-space: normal; }
        .generic-table td:last-child { white-space: nowrap; width: auto;}
        .finance-table td.pendente { color: var(--warning-color); font-weight: bold; }
        .finance-table td.concluido, .finance-table td.pago, .finance-table td.receita { color: var(--success-color); font-weight: bold; }
        .finance-table td.cancelado, .finance-table td.despesa { color: var(--danger-color); font-weight: bold; }
        .finance-table td.a_receber { color: var(--warning-color); }
        .financial-summary { margin-top: 15px; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--background-card); } /* Otimização: Reduz margin-top e padding */
        .financial-summary h4 { margin-top: 0; font-size: 1.1em; } /* Otimização: Reduz font-size */
        .financial-summary p { font-size: 1em; margin: 5px 0; } /* Otimização: Reduz margin e font-size */
        .filters-container { margin-bottom: 15px; padding: 8px; background-color: var(--background-card); border-radius: 5px; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px;} /* Otimização: Reduz margin-bottom, padding e gap */
        .filters-container .btn { background-color: #eee; color: #333; margin: 3px; padding: 6px 10px; font-size: 0.85em; } /* Otimização: Reduz padding, margin e font-size */
        .filters-container .btn.active { background-color: var(--primary-color); color: #fff; }
        .filters-container .date-filter { display: flex; align-items: center; gap: 5px; }
        .filters-container .date-filter input { padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85em; } /* Otimização: Reduz padding e font-size */
        #logo-preview { max-width: 120px; max-height: 80px; display: block; margin: 8px 0; border: 1px solid #ddd; padding: 3px; } /* Otimização: Reduz max-width/height, margin e padding */
        #config-section { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; } /* Otimização: Reduz gap */
        #config-section .form-group { min-width: 100%; }
        #birthday-alerts { background-color: var(--info-color); color: white; padding: 12px; border-radius: 5px; margin-bottom: 15px; } /* Otimização: Reduz padding e margin-bottom */
        #birthday-alerts h4 { margin-top: 0; font-size: 1.1em; } /* Otimização: Reduces font-size */
        #birthday-alerts ul { padding-left: 15px; margin-top: 5px; font-size: 0.9em; } /* Otimização: Reduces padding-left, margin-top and font-size */
        #birthday-alerts ul li { margin-bottom: 3px; } /* Otimização: Reduces margin-bottom */

        /* Estilos para as novas seções financeiras */
        .finance-section-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .finance-card {
            background-color: var(--background-card);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--primary-color);
        }

        .finance-card h4 {
            margin-top: 0;
            color: var(--text-primary);
            font-size: 1.1em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .finance-card p {
            margin: 5px 0;
            font-size: 0.95em;
            display: flex;
            justify-content: space-between;
        }

        .finance-card p strong {
            color: var(--text-primary);
        }

        .finance-card p span.positive { color: var(--success-color); font-weight: bold; }
        .finance-card p span.negative { color: var(--danger-color); font-weight: bold; }
        .finance-card p span.neutral { color: var(--warning-color); font-weight: bold; }

        /* Estilos para as tabelas de balanço */
        .balance-table-container {
            margin-top: 20px;
            margin-bottom: 30px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow-x: auto;
        }

        .balance-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
            min-width: 500px;
        }

        .balance-table th, .balance-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .balance-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        .balance-table tbody tr:nth-child(even) {
            background-color: var(--background-card);
        }
        .balance-table tbody tr:hover {
            background-color: #f0f0f0;
        }

        .balance-table tfoot td {
            font-weight: bold;
            background-color: #e9ecef;
            border-top: 2px solid var(--border-color);
        }

        /* OTIMIZAÇÕES PARA IMPRESSÃO */
        @media print {
            body { 
                margin: 0; 
                padding: 0; 
                font-size: 12px; /* Otimização: Menor fonte para impressão */
                line-height: 1.1; /* Otimização: Espaçamento entre linhas reduzido para impressão */
            }
            .container { 
                box-shadow: none; 
                margin: 0; 
                padding: 10mm; /* Otimização: Margens mais controladas para impressão */
                width: 100%; 
                max-width: 100%; 
                border-radius: 0;
                line-height: 1.1; /* Otimização: Espaçamento entre linhas reduzido para impressão */
            }
            .cards-grid, .atalhos-section, .btn-add-full, .filters-container, .form-actions,
            #config-section, .modal, .financial-summary, .finance-section-group {
                display: none; /* Esconde elementos não relevantes para impressão */
            }
            /* Exibe as tabelas de balanço na impressão */
            .balance-table-container, .balance-table {
                display: block !important;
                width: 100% !important;
                overflow-x: visible !important;
                border: none !important;
                margin-top: 0 !important;
            }
            .balance-table {
                font-size: 10px;
                page-break-inside: auto;
            }
            .balance-table th, .balance-table td {
                padding: 4px 6px;
                border-bottom: 0.5px solid #ccc;
            }
            .tab-content.active { display: block !important; }
            .tab-pane { display: block !important; }
            .generic-table-container { 
                overflow-x: visible !important; 
                border: none; 
                margin-top: 0; 
                line-height: 1.1; /* Otimização: Espaçamento entre linhas reduzido para impressão */
            }
            .generic-table { 
                width: 100%; 
                font-size: 11px; /* Otimização: Menor fonte para tabelas na impressão */
                page-break-inside: auto; /* Permite quebrar tabela entre páginas */
            }
            .generic-table th, .generic-table td { 
                padding: 5px 7px; /* Otimização: Reduz padding de células para impressão */
                border-bottom: 0.5px solid #ccc; /* Linhas mais finas */
                line-height: 1.1; /* Otimização: Espaçamento entre linhas reduzido para impressão */
            }
            .generic-table thead { display: table-header-group; }
            .generic-table tr { page-break-inside: avoid; page-break-after: auto; }
            h3 { font-size: 1.2em; margin-top: 10px; margin-bottom: 5px; page-break-before: always; } /* Otimização: Controla quebras de página */
            p, label, input, select, textarea { font-size: 12px; line-height: 1.2; }
            
            /* Ajustes específicos para o PDF gerado via jsPDF para simular margens */
            .jsPDF {
                margin: 0;
                padding: 0;
            }
        }

        @media (max-width: 768px) {
            body { padding: 5px; font-size: 14px; }
            .container { padding: 15px; }
            .cards-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
            .card { padding: 10px; }
            .icon-card { font-size: 1.8em; }
            .btn-add { padding: 8px 12px; font-size: 0.9em; }
            .form-row { gap: 10px; }
            .form-group { flex: 1 1 100%; min-width: unset; }
            .form-actions { flex-direction: column; gap: 10px; }
            .btn { width: 100%; box-sizing: border-box; }
            .modal-content { padding: 20px; margin: 5% auto; }
            .close-button { top: 5px; right: 15px; font-size: 24px; }
            .filters-container { flex-direction: column; }
            .filters-container .btn { width: auto; }
            #config-section { grid-template-columns: 1fr; }
            .finance-section-group { grid-template-columns: 1fr; }
        }
         @media (max-width: 480px) {
            .cards-grid { grid-template-columns: 1fr 1fr; }
            h2, h3 { font-size: 1.2em; }
            .financial-summary p { font-size: 1em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="birthday-alerts" style="display: none;">
            <h4><i class="fas fa-birthday-cake"></i> Aniversariantes Próximos!</h4>
            <ul id="birthday-list"></ul>
        </div>
        <div class="cards-grid">
            <div class="card" data-tab="pedidos"><i class="fas fa-file-invoice icon-card"></i><span>Pedidos</span></div>
            <div class="card" data-tab="agenda"><i class="fas fa-calendar-alt icon-card"></i><span>Agenda</span></div>
            <div class="card" data-tab="financeiro"><i class="fas fa-dollar-sign icon-card"></i><span>Financeiro</span></div>
            <div class="card" data-tab="clientes"><i class="fas fa-users icon-card"></i><span>Clientes</span></div>
            <div class="card" data-tab="materiaisEstoque"><i class="fas fa-boxes icon-card"></i><span>Materiais</span></div>
            <div class="card" data-tab="servicos"><i class="fas fa-clipboard-list icon-card"></i><span>Serviços</span></div>
        </div>

        <div class="atalhos-section">
            <h2>PAINEL DE CONTROLE</h2>
            <button class="settings-button" data-tab="configuracoes" title="Configurações"><i class="fas fa-cog"></i></button>
        </div>
        <button class="btn btn-add btn-add-full" id="btn-add-pedido-main"><i class="fas fa-plus"></i> CRIAR NOVO PEDIDO</button>

        <div id="tab-content" class="tab-content active">
            <div id="pedidos-tab" class="tab-pane active">
                <h3>Gerenciamento de Pedidos</h3>
                <div class="filters-container">
                    <button class="btn filter-btn active" data-filter="todos">Todos</button>
                    <button class="btn filter-btn" data-filter="pendente">Pendentes</button>
                    <button class="btn filter-btn" data-filter="concluido">Concluídos</button>
                    <button class="btn filter-btn" data-filter="cancelado">Cancelados</button>
                    <button class="btn btn-pdf btn-small" id="btn-report-pedidos"><i class="fas fa-file-pdf"></i> Relatório</button>
                </div>
                <div class="generic-table-container">
                    <table class="generic-table finance-table">
                        <thead><tr><th>ID</th><th>Cliente</th><th>Tipo</th><th>Data</th><th>Status</th><th>Valor</th><th>Pago</th><th>Ações</th></tr></thead>
                        <tbody id="pedidos-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="agenda-tab" class="tab-pane">
                <h3>Agenda de Compromissos</h3>
                <button class="btn btn-add" id="btn-add-agenda"><i class="fas fa-plus"></i> Adicionar</button>
                <button class="btn btn-pdf btn-small" id="btn-report-agenda"><i class="fas fa-file-pdf"></i> Relatório</button>
                <div class="generic-table-container">
                    <table class="generic-table">
                        <thead><tr><th>Data</th><th>Horário</th><th>Descrição</th><th>Cliente</th><th>Status</th><th>Ações</th></tr></thead>
                        <tbody id="agenda-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="financeiro-tab" class="tab-pane">
                <h3>Controle Financeiro</h3>
                 <button class="btn btn-add" id="btn-add-despesa" style="background-color: var(--danger-color);"><i class="fas fa-minus"></i> Adicionar Despesa</button>
                 <button class="btn btn-pdf btn-small" id="btn-report-financeiro"><i class="fas fa-file-pdf"></i> Relatório</button>
                
                <div class="finance-section-group">
                    <div class="financial-summary finance-card">
                        <h4>Resumo Financeiro (Geral):</h4>
                        <p>Total a Receber: <span id="total-a-receber">R$ 0,00</span></p>
                        <p>Total Recebido: <span id="total-recebido">R$ 0,00</span></p>
                        <p>Total Despesas: <span id="total-despesas-fin">R$ 0,00</span></p>
                        <p><strong>Saldo Atual (Recebido - Despesas):</strong> <span id="saldo-atual">R$ 0,00</span></p>
                    </div>

                    <div class="financial-forecast finance-card">
                        <h4>Previsão Financeira:</h4>
                        <p>Total Previsto a Receber: <span id="previsto-a-receber" class="positive">R$ 0,00</span></p>
                        <p>Total Previsto a Pagar (Despesas Futuras): <span id="previsto-a-pagar" class="negative">R$ 0,00</span></p>
                        <p><strong>Saldo Projetado:</strong> <span id="saldo-projetado" class="neutral">R$ 0,00</span></p>
                    </div>
                </div>

                <div class="balance-table-container">
                    <h4>Balanço Mensal:</h4>
                    <table class="balance-table">
                        <thead><tr><th>Mês/Ano</th><th>Receitas</th><th>Despesas</th><th>Saldo</th></tr></thead>
                        <tbody id="monthly-balance-body"></tbody>
                        <tfoot id="monthly-balance-footer"></tfoot>
                    </table>
                </div>

                <div class="balance-table-container">
                    <h4>Balanço Anual:</h4>
                    <table class="balance-table">
                        <thead><tr><th>Ano</th><th>Receitas</th><th>Despesas</th><th>Saldo</th></tr></thead>
                        <tbody id="annual-balance-body"></tbody>
                        <tfoot id="annual-balance-footer"></tfoot>
                    </table>
                </div>

                <div class="filters-container">
                    <div>
                        <button class="btn finance-filter-btn active" data-filter="todos">Todos</button>
                        <button class="btn finance-filter-btn" data-filter="receita">Receitas</button>
                        <button class="btn finance-filter-btn" data-filter="despesa">Despesas</button>
                        <button class="btn finance-filter-btn" data-filter="a_receber">A Receber</button>
                    </div>
                    <div class="date-filter">
                        <label>De:</label> <input type="date" id="finance-start-date">
                        <label>Até:</label> <input type="date" id="finance-end-date">
                        <button class="btn btn-info btn-small" id="btn-filter-date"><i class="fas fa-filter"></i> Filtrar Período</button>
                         <button class="btn btn-secondary btn-small" id="btn-clear-date-filter"><i class="fas fa-times"></i> Limpar</button>
                    </div>
                </div>
                <div class="generic-table-container">
                    <table class="generic-table finance-table">
                        <thead><tr><th>Data</th><th>Tipo</th><th>Descrição</th><th>Valor</th><th>Status/Pedido</th><th>Ações</th></tr></thead>
                        <tbody id="financeiro-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="clientes-tab" class="tab-pane">
                <h3>Gerenciamento de Clientes</h3>
                 <button class="btn btn-add" id="btn-add-cliente"><i class="fas fa-user-plus"></i> Adicionar</button>
                 <button class="btn btn-pdf btn-small" id="btn-report-clientes"><i class="fas fa-file-pdf"></i> Relatório</button>
                <div class="generic-table-container">
                    <table class="generic-table">
                        <thead><tr><th>Nome</th><th>Contato</th><th>Aniversário</th><th>Observações</th><th>Ações</th></tr></thead>
                        <tbody id="clientes-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="materiaisEstoque-tab" class="tab-pane">
                <h3>Materiais & Estoque</h3>
                <button class="btn btn-add" id="btn-add-material"><i class="fas fa-plus"></i> Adicionar</button>
                <button class="btn btn-pdf btn-small" id="btn-report-materiais"><i class="fas fa-file-pdf"></i> Relatório</button>
                 <div class="generic-table-container">
                    <table class="generic-table">
                        <thead><tr><th>Item</th><th>Quantidade</th><th>Observações</th><th>Ações</th></tr></thead>
                        <tbody id="materiais-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="servicos-tab" class="tab-pane">
                <h3>Serviços Oferecidos</h3>
                <button class="btn btn-add" id="btn-add-servico"><i class="fas fa-plus"></i> Adicionar</button>
                <button class="btn btn-pdf btn-small" id="btn-report-servicos"><i class="fas fa-file-pdf"></i> Relatório</button>
                 <div class="generic-table-container">
                    <table class="generic-table">
                        <thead><tr><th>Serviço</th><th>Descrição</th><th>Valor Base</th><th>Ações</th></tr></thead>
                        <tbody id="servicos-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="configuracoes-tab" class="tab-pane">
                <h3>Configurações Gerais</h3>
                <div id="config-section">
                    <div>
                        <h4>Dados da Empresa</h4>
                         <form id="config-form">
                            <div class="form-group full-width"><label>Nome da Empresa/DJ:</label><input type="text" name="empresaNome"></div>
                            <div class="form-group full-width"><label>CNPJ/CPF:</label><input type="text" name="empresaDoc"></div>
                            <div class="form-group full-width"><label>Endereço Completo:</label><input type="text" name="empresaEndereco"></div>
                            <div class="form-group full-width"><label>Telefone/WhatsApp:</label><input type="text" name="empresaContato"></div>
                            <div class="form-group full-width"><label>Email:</label><input type="email" name="empresaEmail"></div>
                            <div class="form-group full-width"><label>Website/Social:</label><input type="text" name="empresaSite"></div>
                            <div class="form-actions"><button type="submit" class="btn">Salvar Dados</button></div>
                         </form>
                    </div>
                     <div>
                         <h4>Logomarca</h4>
                         <div class="form-group full-width">
                            <label>Carregar Logomarca (PNG recomendado):</label>
                            <input type="file" id="logoUpload" accept="image/*">
                            <img id="logo-preview" src="#" alt="Pré-visualização da Logo" style="display: none;">
                            <button id="btn-remove-logo" class="btn btn-small btn-danger" style="display: none;"><i class="fas fa-trash"></i> Remover Logo</button>
                         </div>
                         <hr>
                         <h4>Backup & Restauração</h4>
                         <div class="form-group full-width">
                            <label>Faça o backup ou restaure seus dados:</label>
                            <button id="btn-export-data" class="btn btn-info"><i class="fas fa-download"></i> Exportar Backup</button>
                            <input type="file" id="import-file" accept=".json" style="display: none;">
                            <button id="btn-import-data" class="btn btn-warning"><i class="fas fa-upload"></i> Importar Backup</button>
                            <p><small>Importar um backup substituirá TODOS os dados atuais.</small></p>
                         </div>
                         <hr>
                         <h4>Dados do Sistema</h4>
                          <button id="btn-clear-data" class="btn btn-danger"><i class="fas fa-exclamation-triangle"></i> Limpar Todos os Dados</button>
                          <p><small><strong>Atenção:</strong> Esta ação é irreversível.</small></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="pedidoModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span> <h2 id="pedido-modal-title">Novo Pedido</h2>
            <form id="pedido-form">
                <input type="hidden" name="id">
                 <div class="form-row">
                    <div class="form-group full-width">
                        <label for="pedido-cliente-select">Cliente:</label>
                        <select name="clienteId" id="pedido-cliente-select" required> <option value="">Selecione...</option> </select>
                        <small>Não encontrou? <a href="#" id="link-add-cliente-modal">Adicione um novo cliente</a>.</small>
                    </div>
                </div>
                 <div class="form-row">
                    <div class="form-group"><label>Data do Evento:</label><input type="date" name="dataEvento" required></div>
                    <div class="form-group"><label>Tipo do Evento:</label><input type="text" name="tipoEvento" required></div>
                 </div>
                 <div class="form-row">
                    <div class="form-group"><label>Hora Início:</label><input type="time" name="horaInicio" required></div>
                    <div class="form-group"><label>Hora Final:</label><input type="time" name="horaFinal" required></div>
                 </div>
                 <div class="form-row">
                    <div class="form-group"><label>Tema do Evento:</label><input type="text" name="temaEvento"></div>
                    <div class="form-group"><label>Nº de Pessoas:</label><input type="number" name="numeroPessoas" min="1"></div>
                 </div>
                 <div class="form-row"><div class="form-group full-width"><label>Local do Evento:</label><input type="text" name="localEvento" required></div></div>
                 <div class="form-row">
                    <div class="form-group"><label>Valor Total (R$):</label><input type="number" step="0.01" name="valorTotal" required></div>
                    <div class="form-group"><label>Status:</label>
                        <select name="status"> <option value="pendente">Pendente</option> <option value="concluido">Concluído</option> <option value="cancelado">Cancelado</option> </select>
                    </div>
                 </div>
                 <div class="form-row"><div class="form-group full-width"><label>Serviços Inclusos (1 por linha):</label><textarea name="servicos" placeholder="DJ Sonorização (Até 100 pessoas)&#10;Iluminação Pista de Dança&#10;Projetor e Telão"></textarea></div></div>
                 <div class="form-row"><div class="form-group full-width"><label>Observações:</label><textarea name="observacoes"></textarea></div></div>
                 <div class="form-actions">
                    <button type="submit" class="btn"><i class="fas fa-save"></i> Salvar Pedido</button>
                    <button type="button" class="btn btn-pdf" id="btn-download-pdf"><i class="fas fa-file-pdf"></i> Baixar Pedido</button>
                    <button type="button" class="btn btn-whatsapp" id="btn-send-whatsapp"><i class="fab fa-whatsapp"></i> Enviar WhatsApp</button>
                    <button type="button" class="btn btn-secondary close-btn">Cancelar</button>
                 </div>
            </form>
        </div>
    </div>
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span> <h2 id="client-modal-title">Adicionar Cliente</h2>
            <form id="client-form">
                <input type="hidden" name="id">
                <div class="form-row"><div class="form-group full-width"><label>Nome Completo:</label><input type="text" name="nome" required></div></div>
                <div class="form-row"><div class="form-group"><label>CPF/CNPJ:</label><input type="text" name="docCliente"></div>
                                   <div class="form-group"><label>Contato (Tel/WhatsApp):</label><input type="text" name="contato"></div></div>
                <div class="form-row"><div class="form-group"><label>Email:</label><input type="email" name="emailCliente"></div>
                                   <div class="form-group"><label>Aniversário:</label><input type="date" name="aniversario"></div></div>
                <div class="form-row"><div class="form-group full-width"><label>Endereço:</label><input type="text" name="enderecoCliente"></div></div>
                <div class="form-row"><div class="form-group full-width"><label>Observações:</label><textarea name="obs"></textarea></div></div>
                <div class="form-actions"><button type="submit" class="btn">Salvar</button><button type="button" class="btn btn-secondary close-btn">Cancelar</button></div>
            </form>
        </div>
    </div>
     <div id="pagamentoModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span> <h2>Lançar Pagamento Parcial/Total</h2>
            <form id="pagamento-form">
                <input type="hidden" name="pedidoId">
                <input type="hidden" name="financeiroId">
                <div class="form-row"><div class="form-group full-width"><label>Descrição:</label><input type="text" name="descricao" value="Pagamento Recebido" required></div></div>
                <div class="form-row"><div class="form-group"><label>Data:</label><input type="date" name="data" required></div></div>
                <div class="form-row">
                    <div class="form-group"><label>Valor Recebido (R$):</label><input type="number" step="0.01" name="valor" required></div>
                    <div class="form-group">
                        <label for="formaPagamento">Forma de Pagamento:</label>
                        <select name="formaPagamento" id="formaPagamento" required>
                            <option value="">Selecione...</option>
                            <option value="PIX">PIX</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Transferencia Bancaria">Transferência Bancária</option>
                            <option value="Cartao de Credito">Cartão de Crédito</option>
                            <option value="Cartao de Debito">Cartão de Débito</option>
                            <option value="Boleto">Boleto</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions"><button type="submit" class="btn">Lançar Pagamento</button><button type="button" class="btn btn-secondary close-btn">Cancelar</button></div>
            </form>
        </div>
    </div>
    <div id="agendaDetailsModal" class="modal"> 
        <div class="modal-content"> 
            <span class="close-button">&times;</span> 
            <h2>Detalhes do Compromisso</h2> 
            <form id="agenda-details-form"> 
                <input type="hidden" name="id"> 
                <div class="form-row">
                    <div class="form-group full-width"><label>Cliente:</label><input type="text" name="cliente" readonly></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Data:</label><input type="date" name="data" readonly></div>
                    <div class="form-group"><label>Horário:</label><input type="time" name="horario" readonly></div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width"><label>Descrição:</label><input type="text" name="descricao" readonly></div>
                </div>
                 <div class="form-row">
                    <div class="form-group full-width"><label>Observações:</label><textarea name="obsAgenda" rows="3"></textarea></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Status:</label>
                        <select name="statusAgenda" id="statusAgendaSelect">
                            <option value="pendente">Pendente</option>
                            <option value="concluido">Concluído</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label>Pedido Relacionado:</label>
                        <input type="text" name="pedidoRelacionado" readonly>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-success" id="btn-complete-agenda"><i class="fas fa-check-circle"></i> Marcar como Concluído</button>
                    <button type="button" class="btn btn-danger" id="btn-cancel-agenda"><i class="fas fa-times-circle"></i> Marcar como Cancelado</button>
                    <button type="button" class="btn" id="btn-save-agenda-details"><i class="fas fa-save"></i> Salvar Observações/Status</button>
                    <button type="button" class="btn btn-secondary close-btn">Fechar</button>
                </div>
            </form> 
        </div> 
    </div>
    <div id="addAgendaModal" class="modal"> <div class="modal-content"> <span class="close-button">&times;</span> <h2 id="add-agenda-modal-title">Adicionar Compromisso</h2> <form id="add-agenda-form"> <input type="hidden" name="id"> <input type="hidden" name="pedidoId"> <div class="form-row"><div class="form-group full-width"><label>Descrição:</label><input type="text" name="descricao" required></div></div> <div class="form-row"><div class="form-group"><label>Data:</label><input type="date" name="data" required></div><div class="form-group"><label>Horário:</label><input type="time" name="horario" required></div></div> <div class="form-row"><div class="form-group"><label>Cliente:</label><input type="text" name="cliente"></div></div> <div class="form-actions"><button type="submit" class="btn">Salvar</button><button type="button" class="btn btn-secondary close-btn">Cancelar</button></div> </form> </div> </div>
    <div id="materialModal" class="modal"> <div class="modal-content"> <span class="close-button">&times;</span> <h2 id="material-modal-title">Adicionar Material</h2> <form id="material-form"> <input type="hidden" name="id"> <div class="form-row"><div class="form-group full-width"><label>Item:</label><input type="text" name="item" required></div></div> <div class="form-row"><div class="form-group"><label>Quantidade:</label><input type="number" name="quantidade" min="0" value="1" required></div></div> <div class="form-row"><div class="form-group full-width"><label>Observações:</label><textarea name="obs"></textarea></div></div> <div class="form-actions"><button type="submit" class="btn">Salvar</button><button type="button" class="btn btn-secondary close-btn">Cancelar</button></div> </form> </div> </div>
    <div id="servicoModal" class="modal"> <div class="modal-content"> <span class="close-button">&times;</span> <h2 id="servico-modal-title">Adicionar Serviço</h2> <form id="servico-form"> <input type="hidden" name="id"> <div class="form-row"><div class="form-group full-width"><label>Serviço:</label><input type="text" name="nome" required></div></div> <div class="form-row"><div class="form-group full-width"><label>Descrição:</label><textarea name="descricao"></textarea></div></div> <div class="form-row"><div class="form-group"><label>Valor Base (R$):</label><input type="number" step="0.01" name="valor"></div></div> <div class="form-actions"><button type="submit" class="btn">Salvar</button><button type="button" class="btn btn-secondary close-btn">Cancelar</button></div> </form> </div> </div>
    <div id="despesaModal" class="modal"> <div class="modal-content"> <span class="close-button">&times;</span> <h2>Adicionar Despesa</h2> <form id="despesa-form"> <input type="hidden" name="id"> <div class="form-row"><div class="form-group full-width"><label>Descrição:</label><input type="text" name="descricao" required></div></div> <div class="form-row"><div class="form-group"><label>Data:</label><input type="date" name="data" required></div></div> <div class="form-row"><div class="form-group"><label>Valor (R$):</label><input type="number" step="0.01" name="valor" required></div></div> <div class="form-actions"><button type="submit" class="btn">Salvar Despesa</button><button type="button" class="btn btn-secondary close-btn">Cancelar</button></div> </form> </div> </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("CRM DJ V5.4 - Inicializando Sistema...");
            const { jsPDF } = window.jspdf;

            // ==================================================================
            // 1. SELETORES GLOBAIS
            // ==================================================================
            const selectors = {
                cards: document.querySelectorAll('.card'), tabContent: document.getElementById('tab-content'),
                tabPanes: document.querySelectorAll('.tab-pane'), settingsButton: document.querySelector('.settings-button'),
                pedidosTableBody: document.getElementById('pedidos-table-body'), pedidoModal: document.getElementById('pedidoModal'),
                pedidoForm: document.getElementById('pedido-form'), btnAddPedido: document.getElementById('btn-add-pedido-main'),
                filterButtons: document.querySelectorAll('.filter-btn'), pedidoClienteSelect: document.getElementById('pedido-cliente-select'),
                linkAddClienteModal: document.getElementById('link-add-cliente-modal'),
                clientesTableBody: document.getElementById('clientes-table-body'), clientModal: document.getElementById('clientModal'),
                clientForm: document.getElementById('client-form'), btnAddCliente: document.getElementById('btn-add-cliente'),
                agendaTableBody: document.getElementById('agenda-table-body'),
                // Renomeado agendaModal para addAgendaModal para evitar conflito
                addAgendaModal: document.getElementById('addAgendaModal'), 
                addAgendaForm: document.getElementById('add-agenda-form'), 
                btnAddAgenda: document.getElementById('btn-add-agenda'),
                materiaisTableBody: document.getElementById('materiais-table-body'), materialModal: document.getElementById('materialModal'),
                materialForm: document.getElementById('material-form'), btnAddMaterial: document.getElementById('btn-add-material'),
                servicosTableBody: document.getElementById('servicos-table-body'), servicoModal: document.getElementById('servicoModal'),
                servicoForm: document.getElementById('servico-form'), btnAddServico: document.getElementById('btn-add-servico'),
                financeiroTableBody: document.getElementById('financeiro-table-body'), totalAReceber: document.getElementById('total-a-receber'),
                totalRecebido: document.getElementById('total-recebido'), totalDespesasFin: document.getElementById('total-despesas-fin'),
                saldoAtual: document.getElementById('saldo-atual'), btnAddDespesa: document.getElementById('btn-add-despesa'),
                despesaModal: document.getElementById('despesaModal'), despesaForm: document.getElementById('despesa-form'),
                btnClearData: document.getElementById('btn-clear-data'),
                configForm: document.getElementById('config-form'), logoUpload: document.getElementById('logoUpload'),
                logoPreview: document.getElementById('logo-preview'), btnRemoveLogo: document.getElementById('btn-remove-logo'),
                btnExportData: document.getElementById('btn-export-data'), btnImportData: document.getElementById('btn-import-data'),
                importFile: document.getElementById('import-file'), btnDownloadPdf: document.getElementById('btn-download-pdf'),
                btnSendWhatsapp: document.getElementById('btn-send-whatsapp'), birthdayAlerts: document.getElementById('birthday-alerts'),
                birthdayList: document.getElementById('birthday-list'),
                pagamentoModal: document.getElementById('pagamentoModal'), pagamentoForm: document.getElementById('pagamento-form'),
                financeFilterButtons: document.querySelectorAll('.finance-filter-btn'),
                financeStartDate: document.getElementById('finance-start-date'),
                financeEndDate: document.getElementById('finance-end-date'),
                btnFilterDate: document.getElementById('btn-filter-date'),
                btnClearDateFilter: document.getElementById('btn-clear-date-filter'),

                // Novos seletores para botões de relatório
                btnReportPedidos: document.getElementById('btn-report-pedidos'),
                btnReportAgenda: document.getElementById('btn-report-agenda'),
                btnReportFinanceiro: document.getElementById('btn-report-financeiro'),
                btnReportClientes: document.getElementById('btn-report-clientes'),
                btnReportMateriais: document.getElementById('btn-report-materiais'),
                btnReportServicos: document.getElementById('btn-report-servicos'),

                // NOVOS SELETORES PARA O MODAL agendaDetailsModal
                agendaDetailsModal: document.getElementById('agendaDetailsModal'),
                agendaDetailsForm: document.getElementById('agenda-details-form'),
                btnCompleteAgenda: document.getElementById('btn-complete-agenda'),
                btnCancelAgenda: document.getElementById('btn-cancel-agenda'),
                btnSaveAgendaDetails: document.getElementById('btn-save-agenda-details'),
                statusAgendaSelect: document.getElementById('statusAgendaSelect'),

                // NOVOS SELETORES PARA A ABA FINANCEIRA
                previstoAReceber: document.getElementById('previsto-a-receber'),
                previstoAPagar: document.getElementById('previsto-a-pagar'),
                saldoProjetado: document.getElementById('saldo-projetado'),
                monthlyBalanceBody: document.getElementById('monthly-balance-body'),
                monthlyBalanceFooter: document.getElementById('monthly-balance-footer'),
                annualBalanceBody: document.getElementById('annual-balance-body'),
                annualBalanceFooter: document.getElementById('annual-balance-footer'),
            };

            // ==================================================================
            // 2. ESTADO DA APLICAÇÃO
            // ==================================================================
             const loadData = (key, defaultValue = []) => {
                try { const data = localStorage.getItem(key); return data ? JSON.parse(data) : defaultValue; }
                catch (e) { console.error(`ERRO ao carregar '${key}'. Dados reiniciados.`, e); localStorage.removeItem(key); return defaultValue; }
            };
            const saveData = (key, data) => {
                try { localStorage.setItem(key, JSON.stringify(data)); }
                catch (e) { console.error(`ERRO ao salvar '${key}'.`, e); alert(`Atenção: Não foi possível salvar os dados.`); }
            };

            let state = {
                pedidos: loadData('pedidos_v4'), clientes: loadData('clientes_v4'),
                agenda: loadData('agenda_v4'), materiais: loadData('materiais_v4'),
                servicos: loadData('servicos_v4'), financeiro: loadData('financeiro_v4'),
                configuracoes: loadData('configuracoes_v4', { logo: null, empresa: {} }),
                currentFilter: 'todos',
                financeFilter: 'todos',
            };

            // ==================================================================
            // 3. FUNÇÕES UTILITÁRIAS
            // ==================================================================
            const formatCurrency = (value) => (parseFloat(value) || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const formatDate = (dateStr) => {
                if (!dateStr) return 'N/A';
                const date = new Date(`${dateStr}T00:00:00`);
                return date.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
            };
            // Função para formatar data para exibição de Mês/Ano
            const formatMonthYear = (dateStr) => {
                if (!dateStr) return 'N/A';
                const date = new Date(`${dateStr}T00:00:00`);
                return date.toLocaleDateString('pt-BR', { month: '2-digit', year: 'numeric', timeZone: 'UTC' });
            };
             const formatDateToISO = (dateStr) => {
                if (!dateStr) return null;
                const date = new Date(dateStr);
                return date.toISOString().split('T')[0];
            };
            const generateId = (prefix) => `${prefix}_${Date.now()}`;
            const closeModal = (modal) => { if(modal) modal.style.display = 'none'; };
            const openModal = (modal, formElement, title = 'Adicionar', itemData = null) => {
                const titleElement = modal.querySelector('h2');
                formElement.reset();
                if(titleElement) titleElement.textContent = title;
                const idInput = formElement.querySelector('[name="id"]');
                if (idInput) idInput.value = '';

                if (itemData) {
                    if(titleElement) titleElement.textContent = title.replace('Adicionar', 'Editar').replace('Novo', 'Editar');
                    Object.keys(itemData).forEach(key => {
                        const input = formElement.querySelector(`[name="${key}"]`);
                        if (input) input.value = itemData[key];
                    });
                }
                modal.style.display = 'flex';
            };
            const getClientById = (clientId) => state.clientes.find(c => c.id === clientId) || {};
            const getClientNameById = (clientId) => getClientById(clientId).nome || 'Cliente Desconhecido';
            const getPedidoById = (pedidoId) => state.pedidos.find(p => p.id === pedidoId) || {};
            const getAgendaById = (agendaId) => state.agenda.find(a => a.id === agendaId) || {};


            const getCidadeFromConfig = () => {
                const endereco = state.configuracoes.empresa?.empresaEndereco;
                if (endereco) {
                    const parts = endereco.split(',').map(s => s.trim());
                    for (let i = parts.length - 1; i >= 0; i--) {
                        if (isNaN(parseInt(parts[i])) && parts[i].length > 2) {
                            return parts[i];
                        }
                    }
                }
                return "Cidade Não Informada";
            };

            const getCidadeFromCliente = () => {
                const clientesComEndereco = state.clientes.filter(c => c.enderecoCliente);
                if (clientesComEndereco.length > 0) {
                    const endereco = clientesComEndereco[0].enderecoCliente;
                     const parts = endereco.split(',').map(s => s.trim());
                    for (let i = parts.length - 1; i >= 0; i--) {
                        if (isNaN(parseInt(parts[i])) && parts[i].length > 2) {
                            return parts[i];
                        }
                    }
                }
                return "Cidade Não Informada";
            };


            // ==================================================================
            // 4. LÓGICA DE CRUD E INTEGRAÇÃO
            // ==================================================================
             const savePedido = () => {
                const form = selectors.pedidoForm;
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return null;
                }

                const formData = new FormData(form);
                const data = {};
                formData.forEach((v, k) => data[k] = v);
                const isNew = !data.id;

                if (parseFloat(data.valorTotal) <= 0) {
                    alert("O Valor Total deve ser maior que zero.");
                    return null;
                }

                if (isNew) {
                    data.id = generateId('ped');
                    state.pedidos.push(data);
                } else {
                    const index = state.pedidos.findIndex(item => item.id === data.id);
                    if (index !== -1) { state.pedidos[index] = { ...state.pedidos[index], ...data }; }
                }

                saveData('pedidos_v4', state.pedidos);
                handlePedidoIntegrations(data, isNew);
                displayPedidos();
                return data;
            };

            const handleFormSubmit = (e, type, formElement, modal, displayFn) => {
                 e.preventDefault();
                 if (!formElement.checkValidity()) {
                    formElement.reportValidity();
                    return;
                }
                 const formData = new FormData(formElement);
                 const data = {};
                 formData.forEach((v, k) => data[k] = v);
                 const isNew = !data.id;

                 if (isNew) {
                    data.id = generateId(type.slice(0, 3));
                    if (type === 'agenda') { // Novo compromisso da agenda tem status inicial "pendente" e observações vazias
                        data.status = 'pendente';
                        data.obsAgenda = '';
                    }
                    state[type].push(data);
                 } else {
                     const index = state[type].findIndex(item => item.id === data.id);
                     if (index !== -1) state[type][index] = { ...state[type][index], ...data };
                 }

                 saveData(`${type}_v4`, state[type]);
                 alert(`${type.slice(0, -1).replace('materiai', 'material')} salvo!`);
                 closeModal(modal);
                 displayFn();

                 if (type === 'pedidos') handlePedidoIntegrations(data, isNew);
                 if (type === 'clientes') { populateClientSelect(); checkBirthdays(); }
            };

             const handlePedidoIntegrations = (pedido, isNew) => {
                const clienteNome = getClientNameById(pedido.clienteId);
                const hoje = new Date().toISOString().split('T')[0];
                const descEvento = `Evento: ${pedido.tipoEvento || 'N/A'} - ${clienteNome}`;

                let agendaEntry = state.agenda.find(a => a.pedidoId === pedido.id);
                if (agendaEntry) {
                    agendaEntry.data = pedido.dataEvento;
                    agendaEntry.horario = pedido.horaInicio;
                    agendaEntry.descricao = descEvento;
                    agendaEntry.cliente = clienteNome;
                    // Mantém status e obsAgenda existentes
                } else if (pedido.dataEvento && pedido.horaInicio) {
                    state.agenda.push({
                        id: generateId('age'),
                        data: pedido.dataEvento,
                        horario: pedido.horaInicio,
                        descricao: descEvento,
                        cliente: clienteNome,
                        pedidoId: pedido.id,
                        status: 'pendente', // Status padrão para novos compromissos da agenda
                        obsAgenda: '' // Observações vazias
                    });
                }
                saveData('agenda_v4', state.agenda); displayAgenda();

                state.financeiro = state.financeiro.filter(f => !(f.pedidoId === pedido.id && f.tipo === 'a_receber'));

                if (pedido.status !== 'cancelado' && parseFloat(pedido.valorTotal) > 0) {
                    const totalPagoExistente = state.financeiro
                        .filter(f => f.pedidoId === pedido.id && f.tipo === 'receita')
                        .reduce((sum, f) => sum + parseFloat(f.valor), 0);
                    const valorPendente = parseFloat(pedido.valorTotal) - totalPagoExistente;

                    // Apenas adiciona como 'a_receber' se ainda houver valor pendente e não for cancelado
                    if (valorPendente > 0.01) {
                        state.financeiro.push({
                            id: generateId('fin'),
                            data: pedido.dataEvento || hoje, // A data do evento é a data de previsão de recebimento
                            tipo: 'a_receber',
                            descricao: `Pedido: ${clienteNome} (#${pedido.id.substring(4, 10)})`,
                            valor: valorPendente,
                            status: 'pendente', // Status "pendente" para financeiro a receber
                            pedidoId: pedido.id
                        });
                    }
                }
                saveData('financeiro_v4', state.financeiro); displayFinanceiro();
            };

            window.handleDelete = (type, id) => {
                if (!confirm(`Tem certeza que deseja excluir este item?`)) return;

                state[type] = state[type].filter(item => item.id !== id);
                saveData(`${type}_v4`, state[type]);

                if (type === 'pedidos') {
                    state.agenda = state.agenda.filter(a => a.pedidoId !== id);
                    state.financeiro = state.financeiro.filter(f => f.pedidoId !== id);
                    saveData('agenda_v4', state.agenda);
                    saveData('financeiro_v4', state.financeiro);
                    displayAgenda(); // Adicionado para atualizar a agenda
                    displayFinanceiro();
                }
                if (type === 'financeiro') {
                    const deletedFinanceEntry = state.financeiro.find(f => f.id === id);
                    if (deletedFinanceEntry && deletedFinanceEntry.pedidoId) {
                         const relatedPedido = getPedidoById(deletedFinanceEntry.pedidoId);
                         if (relatedPedido) handlePedidoIntegrations(relatedPedido, false);
                    }
                    displayFinanceiro();
                    displayPedidos();
                }
                if (type === 'clientes') { populateClientSelect(); checkBirthdays(); }

                // Chamada da função de display adequada para cada tipo
                if (type === 'pedidos') displayPedidos();
                else if (type === 'clientes') displayClientes();
                else if (type === 'agenda') displayAgenda();
                else if (type === 'materiais') displayMateriaisEstoque();
                else if (type === 'servicos') displayServicos();
                else if (type === 'financeiro') displayFinanceiro();
            };

            window.openPagamentoModal = (pedidoId, financeiroId) => {
                const form = selectors.pagamentoForm;
                form.reset();
                form.querySelector('[name="pedidoId"]').value = pedidoId;
                form.querySelector('[name="data"]').value = new Date().toISOString().split('T')[0];

                // Preencher descrição com base no pedido, se houver
                if (pedidoId) {
                    const pedido = getPedidoById(pedidoId);
                    if (pedido) {
                        const clienteNome = getClientNameById(pedido.clienteId);
                        form.querySelector('[name="descricao"]').value = `Pagamento ref. ao evento "${pedido.tipoEvento}" do dia ${formatDate(pedido.dataEvento)} - ${clienteNome}`;
                    }
                } else {
                    form.querySelector('[name="descricao"]').value = `Pagamento Recebido`;
                }

                selectors.pagamentoModal.style.display = 'flex';
            };


            // ==================================================================
            // 5. FUNÇÕES DE DISPLAY
            // ==================================================================
            const createButton = (className, icon, title, onclick, extraClass = '') => `<button class="btn btn-small ${className} ${extraClass}" onclick="${onclick}" title="${title}"><i class="fas ${icon}"></i></button>`;

            window.displayPedidos = (filter = state.currentFilter) => {
                const body = selectors.pedidosTableBody; body.innerHTML = '';
                const filtered = (state.pedidos || []).filter(p => p && (filter === 'todos' || p.status === filter));
                if (filtered.length === 0) { body.innerHTML = `<tr><td colspan="8" style="text-align: center;">Nenhum pedido.</td></tr>`; return; }

                filtered.sort((a,b) => new Date(b.dataEvento) - new Date(a.dataEvento)).forEach(p => {
                    const row = body.insertRow(); row.dataset.id = p.id;
                    const status = p.status || 'pendente';
                    const clienteNome = getClientNameById(p.clienteId);
                    const totalPago = state.financeiro
                        .filter(f => f.pedidoId === p.id && f.tipo === 'receita')
                        .reduce((sum, f) => sum + parseFloat(f.valor), 0);
                    const pendente = parseFloat(p.valorTotal) - totalPago;

                    let statusDisplay = status.charAt(0).toUpperCase() + status.slice(1);
                    if (pendente > 0.01 && status !== 'cancelado') {
                         statusDisplay = `A Receber`;
                    } else if (status === 'concluido' || pendente <= 0.01) {
                        statusDisplay = `Concluído / Pago`;
                    }

                    row.innerHTML = `
                        <td>${p.id ? p.id.substring(4, 10) : 'ERRO'}</td> <td>${clienteNome}</td> <td>${p.tipoEvento || 'N/A'}</td>
                        <td>${formatDate(p.dataEvento)}</td> <td class="${status}">${statusDisplay}</td>
                        <td>${formatCurrency(p.valorTotal)}</td>
                        <td>${formatCurrency(totalPago)} (${pendente > 0.01 && status !== 'cancelado' ? `Falta ${formatCurrency(pendente)}` : 'Pago'})</td>
                        <td>
                            ${createButton('btn-edit', 'fa-edit', 'Editar', `openPedidoModal('${p.id}')`)}
                            ${createButton('btn-contract', 'fa-file-signature', 'Gerar Contrato', `generateContract('${p.id}')`)}
                            ${createButton('btn-danger', 'fa-trash', 'Excluir', `handleDelete('pedidos', '${p.id}')`)}
                        </td>`;
                });
            };
            window.displayClientes = () => {
                const body = selectors.clientesTableBody; body.innerHTML = '';
                if (!state.clientes || state.clientes.length === 0) { body.innerHTML = `<tr><td colspan="5" style="text-align: center;">Nenhum cliente.</td></tr>`; return; }
                state.clientes.forEach(c => {
                    const row = body.insertRow(); row.dataset.id = c.id;
                    row.innerHTML = `<td>${c.nome || 'N/A'}</td> <td>${c.contato || 'N/A'}</td> <td>${formatDate(c.aniversario)}</td> <td>${c.obs || ''}</td> <td> ${createButton('btn-edit', 'fa-edit', 'Editar', `openClientModal('${c.id}')`)} ${createButton('btn-danger', 'fa-trash', 'Excluir', `handleDelete('clientes', '${c.id}')`)} </td>`;
                });
                populateClientSelect(); checkBirthdays();
            };
            window.displayAgenda = () => {
                const body = selectors.agendaTableBody; body.innerHTML = '';
                if (!state.agenda || state.agenda.length === 0) { body.innerHTML = `<tr><td colspan="6" style="text-align: center;">Nenhum compromisso.</td></tr>`; return; }
                state.agenda.sort((a,b) => new Date(a.data + 'T' + (a.horario||'00:00')) - new Date(b.data + 'T' + (b.horario||'00:00'))).forEach(a => {
                     const row = body.insertRow(); row.dataset.id = a.id;
                     const statusClass = a.status || 'pendente'; // Define classe para cor de status
                    row.innerHTML = `<td>${formatDate(a.data)}</td> <td>${a.horario || 'N/A'}</td> <td>${a.descricao || 'N/A'}</td> <td>${a.cliente || 'N/A'}</td> 
                    <td class="${statusClass}">${statusClass.charAt(0).toUpperCase() + statusClass.slice(1)}</td>
                    <td> 
                        ${createButton('btn-info', 'fa-eye', 'Visualizar Detalhes', `openAgendaDetailsModal('${a.id}')`)}
                        ${createButton('btn-edit', 'fa-edit', 'Editar', `openAddAgendaModal('${a.id}')`)}
                        ${createButton('btn-danger', 'fa-trash', 'Excluir', `handleDelete('agenda', '${a.id}')`)} 
                    </td>`;
                });
            };
            window.displayMateriaisEstoque = () => {
                 const body = selectors.materiaisTableBody; body.innerHTML = '';
                if (!state.materiais || state.materiais.length === 0) { body.innerHTML = `<tr><td colspan="4" style="text-align: center;">Nenhum material.</td></tr>`; return; }
                state.materiais.forEach(m => {
                    const row = body.insertRow(); row.dataset.id = m.id;
                    row.innerHTML = `<td>${m.item || 'N/A'}</td> <td>${m.quantidade || '0'}</td> <td>${m.obs || ''}</td> <td> ${createButton('btn-edit', 'fa-edit', 'Editar', `openMaterialModal('${m.id}')`)} ${createButton('btn-danger', 'fa-trash', 'Excluir', `handleDelete('materiais', '${m.id}')`)} </td>`;
                });
            };
            window.displayServicos = () => {
                const body = selectors.servicosTableBody; body.innerHTML = '';
                if (!state.servicos || state.servicos.length === 0) { body.innerHTML = `<tr><td colspan="4" style="text-align: center;">Nenhum serviço.</td></tr>`; return; }
                state.servicos.forEach(s => {
                    const row = body.insertRow(); row.dataset.id = s.id;
                    row.innerHTML = `<td>${s.nome || 'N/A'}</td> <td>${s.descricao || ''}</td> <td>${formatCurrency(s.valor)}</td> <td> ${createButton('btn-edit', 'fa-edit', 'Editar', `openServicoModal('${s.id}')`)} ${createButton('btn-danger', 'fa-trash', 'Excluir', `handleDelete('servicos', '${s.id}')`)} </td>`;
                });
            };

            // Função principal de display financeiro, agora responsável por chamar as novas análises
            window.displayFinanceiro = () => {
                const body = selectors.financeiroTableBody; body.innerHTML = '';
                let aReceber = 0, recebido = 0, despesas = 0;
                const filterType = state.financeFilter;
                const startDate = selectors.financeStartDate.value;
                const endDate = selectors.financeEndDate.value;
                const hoje = new Date().toISOString().split('T')[0];

                let allEntries = [...state.financeiro];

                // Calcula os totais gerais (recebido, despesas, a receber)
                 allEntries.forEach(f => {
                    const valor = parseFloat(f.valor) || 0;
                    if (f.tipo === 'a_receber' && f.status !== 'cancelado' && f.data >= hoje) aReceber += valor;
                    else if (f.tipo === 'receita') recebido += valor;
                    else if (f.tipo === 'despesa') despesas += valor;
                });

                selectors.totalAReceber.textContent = formatCurrency(aReceber);
                selectors.totalRecebido.textContent = formatCurrency(recebido);
                selectors.totalDespesasFin.textContent = formatCurrency(despesas);
                selectors.saldoAtual.textContent = formatCurrency(recebido - despesas);

                // Chama as novas funções de balanço e previsão
                calculateFinancialForecast();
                calculateMonthlyBalance();
                calculateAnnualBalance();


                const filteredEntries = allEntries.filter(f => {
                    const typeMatch = filterType === 'todos' || f.tipo === filterType;
                    const dateMatch = (!startDate || f.data >= startDate) && (!endDate || f.data <= endDate);
                    const statusMatch = !(f.tipo === 'a_receber' && f.status === 'cancelado');
                    return typeMatch && dateMatch && statusMatch;
                });

                if (filteredEntries.length === 0) { body.innerHTML = `<tr><td colspan="6" style="text-align: center;">Nenhum lançamento para este filtro.</td></tr>`; }
                else {
                    filteredEntries.sort((a, b) => {
                        const dateA = new Date(a.data);
                        const dateB = new Date(b.data);
                        if (dateA.getTime() === dateB.getTime()) {
                            if (a.tipo === 'a_receber' && b.tipo !== 'a_receber') return -1;
                            if (a.tipo !== 'a_receber' && b.tipo === 'a_receber') return 1;
                            return 0;
                        }
                        return dateB - dateA;
                    }).forEach(f => {
                         const row = body.insertRow();
                        const valor = parseFloat(f.valor) || 0;
                        const tipo = f.tipo || 'N/A';
                        let statusText = f.status || '';
                        let actions = createButton('btn-danger', 'fa-trash', 'Excluir', `handleDelete('financeiro', '${f.id}')`);

                        if (tipo === 'a_receber') {
                            actions = createButton('btn-success', 'fa-hand-holding-usd', 'Lançar Pagamento', `openPagamentoModal('${f.pedidoId}', '${f.id}')`) + ' ' + actions;
                            statusText = `<span class="pendente">${statusText.charAt(0).toUpperCase() + statusText.slice(1)}</span>`;
                        } else if (tipo === 'receita') {
                            actions = createButton('btn-receipt', 'fa-receipt', 'Gerar Recibo', `generateReceipt('${f.id}')`) + ' ' + actions;
                            statusText = `<span class="pago">Receita</span>`;
                        } else if (tipo === 'despesa') {
                            statusText = `<span class="despesa">Despesa</span>`;
                        }

                        row.innerHTML = `
                            <td>${formatDate(f.data)}</td> <td class="${tipo}">${tipo.replace('_',' ').toUpperCase()}</td>
                            <td>${f.descricao || 'N/A'}</td> <td>${formatCurrency(valor)}</td>
                            <td>${f.pedidoId ? `Pedido #${f.pedidoId.substring(4,10)}` : statusText}</td>
                            <td>${actions}</td>`;
                    });
                }
            };
            
            // NOVO: Função para calcular e exibir a Previsão Financeira
            const calculateFinancialForecast = () => {
                const hoje = new Date().toISOString().split('T')[0];
                let previstoAReceber = 0;
                let previstoAPagar = 0;

                // Previsão a Receber: Lançamentos 'a_receber' com data igual ou posterior a hoje
                state.financeiro.filter(f => f.tipo === 'a_receber' && f.status !== 'cancelado' && f.data >= hoje)
                    .forEach(f => {
                        previstoAReceber += parseFloat(f.valor) || 0;
                    });

                // Previsão a Pagar: Despesas com data igual ou posterior a hoje
                state.financeiro.filter(f => f.tipo === 'despesa' && f.data >= hoje)
                    .forEach(f => {
                        previstoAPagar += parseFloat(f.valor) || 0;
                    });
                
                selectors.previstoAReceber.textContent = formatCurrency(previstoAReceber);
                selectors.previstoAPagar.textContent = formatCurrency(previstoAPagar);
                selectors.saldoProjetado.textContent = formatCurrency(previstoAReceber - previstoAPagar);

                // Aplica classe de cor ao saldo projetado
                const saldoProjetadoElement = selectors.saldoProjetado;
                saldoProjetadoElement.classList.remove('positive', 'negative', 'neutral');
                if ((previstoAReceber - previstoAPagar) > 0) {
                    saldoProjetadoElement.classList.add('positive');
                } else if ((previstoAReceber - previstoAPagar) < 0) {
                    saldoProjetadoElement.classList.add('negative');
                } else {
                    saldoProjetadoElement.classList.add('neutral');
                }
            };

            // NOVO: Função para calcular e exibir o Balanço Mensal
            const calculateMonthlyBalance = () => {
                const monthlyData = {}; // { 'YYYY-MM': { receitas: 0, despesas: 0 } }
                const body = selectors.monthlyBalanceBody;
                const footer = selectors.monthlyBalanceFooter;
                body.innerHTML = '';
                footer.innerHTML = '';

                state.financeiro.forEach(f => {
                    if (!f.data) return;
                    const monthYear = f.data.substring(0, 7); // YYYY-MM
                    if (!monthlyData[monthYear]) {
                        monthlyData[monthYear] = { receitas: 0, despesas: 0 };
                    }
                    if (f.tipo === 'receita') {
                        monthlyData[monthYear].receitas += parseFloat(f.valor) || 0;
                    } else if (f.tipo === 'despesa') {
                        monthlyData[monthYear].despesas += parseFloat(f.valor) || 0;
                    }
                });

                const sortedMonths = Object.keys(monthlyData).sort().reverse(); // Mais recente primeiro

                let totalReceitasMensal = 0;
                let totalDespesasMensal = 0;

                if (sortedMonths.length === 0) {
                    body.innerHTML = `<tr><td colspan="4" style="text-align: center;">Nenhum dado para o balanço mensal.</td></tr>`;
                    return;
                }

                sortedMonths.forEach(monthYear => {
                    const data = monthlyData[monthYear];
                    const saldo = data.receitas - data.despesas;
                    totalReceitasMensal += data.receitas;
                    totalDespesasMensal += data.despesas;

                    const row = body.insertRow();
                    row.innerHTML = `
                        <td>${formatMonthYear(`${monthYear}-01`)}</td>
                        <td class="positive">${formatCurrency(data.receitas)}</td>
                        <td class="negative">${formatCurrency(data.despesas)}</td>
                        <td class="${saldo >= 0 ? 'positive' : 'negative'}">${formatCurrency(saldo)}</td>
                    `;
                });

                // Totalizador mensal
                const totalRow = footer.insertRow();
                const finalSaldoMensal = totalReceitasMensal - totalDespesasMensal;
                totalRow.innerHTML = `
                    <td>Total:</td>
                    <td class="positive">${formatCurrency(totalReceitasMensal)}</td>
                    <td class="negative">${formatCurrency(totalDespesasMensal)}</td>
                    <td class="${finalSaldoMensal >= 0 ? 'positive' : 'negative'}">${formatCurrency(finalSaldoMensal)}</td>
                `;
            };

            // NOVO: Função para calcular e exibir o Balanço Anual
            const calculateAnnualBalance = () => {
                const annualData = {}; // { 'YYYY': { receitas: 0, despesas: 0 } }
                const body = selectors.annualBalanceBody;
                const footer = selectors.annualBalanceFooter;
                body.innerHTML = '';
                footer.innerHTML = '';

                state.financeiro.forEach(f => {
                    if (!f.data) return;
                    const year = f.data.substring(0, 4); // YYYY
                    if (!annualData[year]) {
                        annualData[year] = { receitas: 0, despesas: 0 };
                    }
                    if (f.tipo === 'receita') {
                        annualData[year].receitas += parseFloat(f.valor) || 0;
                    } else if (f.tipo === 'despesa') {
                        annualData[year].despesas += parseFloat(f.valor) || 0;
                    }
                });

                const sortedYears = Object.keys(annualData).sort().reverse(); // Mais recente primeiro

                let totalReceitasAnual = 0;
                let totalDespesasAnual = 0;

                if (sortedYears.length === 0) {
                    body.innerHTML = `<tr><td colspan="4" style="text-align: center;">Nenhum dado para o balanço anual.</td></tr>`;
                    return;
                }

                sortedYears.forEach(year => {
                    const data = annualData[year];
                    const saldo = data.receitas - data.despesas;
                    totalReceitasAnual += data.receitas;
                    totalDespesasAnual += data.despesas;

                    const row = body.insertRow();
                    row.innerHTML = `
                        <td>${year}</td>
                        <td class="positive">${formatCurrency(data.receitas)}</td>
                        <td class="negative">${formatCurrency(data.despesas)}</td>
                        <td class="${saldo >= 0 ? 'positive' : 'negative'}">${formatCurrency(saldo)}</td>
                    `;
                });

                // Totalizador anual
                const totalRow = footer.insertRow();
                const finalSaldoAnual = totalReceitasAnual - totalDespesasAnual;
                totalRow.innerHTML = `
                    <td>Total:</td>
                    <td class="positive">${formatCurrency(totalReceitasAnual)}</td>
                    <td class="negative">${formatCurrency(totalDespesasAnual)}</td>
                    <td class="${finalSaldoAnual >= 0 ? 'positive' : 'negative'}">${formatCurrency(finalSaldoAnual)}</td>
                `;
            };

            const populateClientSelect = () => {
                const select = selectors.pedidoClienteSelect; const currentVal = select.value;
                select.innerHTML = '<option value="">Selecione um cliente...</option>';
                state.clientes.sort((a,b) => (a.nome || '').localeCompare(b.nome || '')).forEach(client => {
                    const option = document.createElement('option'); option.value = client.id; option.textContent = client.nome; select.appendChild(option);
                });
                select.value = currentVal;
            };
            const displayConfig = () => {
                const config = state.configuracoes;
                const form = selectors.configForm;
                Object.keys(config.empresa || {}).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) input.value = config.empresa[key];
                });
                if (config.logo) {
                    selectors.logoPreview.src = config.logo;
                    selectors.logoPreview.style.display = 'block';
                    selectors.btnRemoveLogo.style.display = 'inline-block';
                } else {
                    selectors.logoPreview.style.display = 'none';
                    selectors.btnRemoveLogo.style.display = 'none';
                }
            };

            const checkBirthdays = () => {
                const today = new Date();
                const upcoming = [];
                const checkDays = 7;

                state.clientes.forEach(client => {
                    if (!client.aniversario) return;
                    const birthDate = new Date(`${client.aniversario}T00:00:00`);

                    let currentYearBirthDate = new Date(birthDate);
                    currentYearBirthDate.setFullYear(today.getFullYear());

                    if (currentYearBirthDate < today && (today.getMonth() > birthDate.getMonth() || (today.getMonth() === birthDate.getMonth() && today.getDate() > birthDate.getDate()))) {
                        currentYearBirthDate.setFullYear(today.getFullYear() + 1);
                    }

                    const diffTime = currentYearBirthDate.getTime() - today.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays >= 0 && diffDays <= checkDays) {
                        upcoming.push({ name: client.nome, date: formatDate(client.aniversario), daysLeft: diffDays });
                    }
                });

                if (upcoming.length > 0) {
                    upcoming.sort((a,b) => a.daysLeft - b.daysLeft);

                    selectors.birthdayList.innerHTML = upcoming
                        .map(b => `<li>${b.name} - ${b.date.substring(0,5)} (${b.daysLeft === 0 ? 'Hoje!' : `em ${b.daysLeft} dias`})</li>`)
                        .join('');
                    selectors.birthdayAlerts.style.display = 'block';
                } else {
                    selectors.birthdayAlerts.style.display = 'none';
                }
            };

            // ==================================================================
            // 6. NAVEGAÇÃO e ABERTURA MODAIS
            // ==================================================================
            window.showTab = (tabId) => {
                selectors.tabPanes.forEach(p => p.classList.remove('active'));
                const activeTab = document.getElementById(`${tabId}-tab`);
                if (activeTab) {
                    activeTab.classList.add('active'); selectors.tabContent.classList.add('active');
                    let displayFnName = `display${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`;
                    if (tabId === 'materiaisEstoque') displayFnName = 'displayMateriaisEstoque';
                    if (tabId === 'configuracoes') displayFnName = 'displayConfig';

                    if (window[displayFnName]) window[displayFnName]();
                    if (tabId === 'financeiro') displayFinanceiro(); // Adicionado para garantir o refresh de todos os dados financeiros
                    if (tabId === 'pedidos') displayPedidos();
                } else { console.warn(`Aba '${tabId}-tab' não encontrada.`); }
            };
            window.openPedidoModal = (id = null) => { populateClientSelect(); openModal(selectors.pedidoModal, selectors.pedidoForm, 'Novo Pedido', id ? state.pedidos.find(i=>i.id===id) : null); };
            window.openClientModal = (id = null) => openModal(selectors.clientModal, selectors.clientForm, 'Adicionar Cliente', id ? state.clientes.find(i=>i.id===id) : null);
            // Renomeado para openAddAgendaModal
            window.openAddAgendaModal = (id = null) => openModal(selectors.addAgendaModal, selectors.addAgendaForm, 'Adicionar Compromisso', id ? state.agenda.find(i=>i.id===id) : null);
            window.openMaterialModal = (id = null) => openModal(selectors.materialModal, selectors.materialForm, 'Adicionar Material', id ? state.materiais.find(i=>i.id===id) : null);
            window.openServicoModal = (id = null) => openModal(selectors.servicoModal, selectors.servicoForm, 'Adicionar Serviço', id ? state.servicos.find(i=>i.id===id) : null);
            window.openDespesaModal = () => { openModal(selectors.despesaModal, selectors.despesaForm, 'Adicionar Despesa'); selectors.despesaForm.querySelector('[name="data"]').value = new Date().toISOString().split('T')[0]; };

            // NOVA FUNÇÃO PARA ABRIR O MODAL DE DETALHES DA AGENDA
            window.openAgendaDetailsModal = (id) => {
                const agendaItem = getAgendaById(id);
                if (!agendaItem) {
                    alert("Compromisso não encontrado.");
                    return;
                }
                const form = selectors.agendaDetailsForm;
                form.querySelector('[name="id"]').value = agendaItem.id;
                form.querySelector('[name="cliente"]').value = agendaItem.cliente || 'N/A';
                form.querySelector('[name="data"]').value = agendaItem.data || '';
                form.querySelector('[name="horario"]').value = agendaItem.horario || '';
                form.querySelector('[name="descricao"]').value = agendaItem.descricao || 'N/A';
                form.querySelector('[name="obsAgenda"]').value = agendaItem.obsAgenda || ''; // Campo de observações editável
                selectors.statusAgendaSelect.value = agendaItem.status || 'pendente'; // Campo de status editável

                // Popula o campo de pedido relacionado
                if (agendaItem.pedidoId) {
                    const pedido = getPedidoById(agendaItem.pedidoId);
                    if (pedido) {
                         form.querySelector('[name="pedidoRelacionado"]').value = `#${agendaItem.pedidoId.substring(4, 10)} - ${pedido.tipoEvento || ''}`;
                    } else {
                        form.querySelector('[name="pedidoRelacionado"]').value = `Pedido #${agendaItem.pedidoId.substring(4, 10)} (Não encontrado)`;
                    }
                } else {
                    form.querySelector('[name="pedidoRelacionado"]').value = 'Nenhum';
                }

                selectors.agendaDetailsModal.style.display = 'flex';
            };


            // ==================================================================
            // 7. FUNÇÕES DE PDF
            // ==================================================================
            const addHeader = (doc, config, yPosRef) => {
                const margin = 15;
                const pageWidth = doc.internal.pageSize.getWidth();
                let startY = 10;

                doc.setTextColor(0, 0, 0);

                if (config.logo) {
                    try {
                        const imgProps = doc.getImageProperties(config.logo);
                        const aspectRatio = imgProps.width / imgProps.height;
                        const logoHeight = 20; // Tamanho padrão do logo
                        const logoWidth = logoHeight * aspectRatio;
                        doc.addImage(config.logo, imgProps.fileType || 'PNG', margin, startY, logoWidth, logoHeight);
                        startY = Math.max(startY, logoHeight + 10);
                    } catch (e) {
                        console.warn("Erro ao adicionar logo (verifique o formato/Base64):", e.message);
                    }
                }

                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                let textY = 15;

                if (config.logo) {
                    const imgProps = doc.getImageProperties(config.logo);
                    const logoHeight = 20;
                    // Ajusta textY para ficar ao lado do logo, se o logo for maior
                    textY = Math.max(textY, 10 + logoHeight - (4 * 3));
                } else {
                     textY = 15;
                }

                const companyDetails = [];
                // Adiciona apenas se o campo não estiver vazio
                if(config.empresa?.empresaNome && config.empresa.empresaNome.trim() !== '') companyDetails.push({text: config.empresa.empresaNome, font: 'bold', size: 9});
                if(config.empresa?.empresaEndereco && config.empresa.empresaEndereco.trim() !== '') companyDetails.push({text: config.empresa.empresaEndereco, font: 'normal', size: 8});
                if(config.empresa?.empresaContato && config.empresa.empresaContato.trim() !== '') companyDetails.push({text: config.empresa.empresaContato, font: 'normal', size: 8});
                if(config.empresa?.empresaEmail && config.empresa.empresaEmail.trim() !== '') companyDetails.push({text: config.empresa.empresaEmail, font: 'normal', size: 8});
                if(config.empresa?.empresaSite && config.empresa.empresaSite.trim() !== '') companyDetails.push({text: config.empresa.empresaSite, font: 'normal', size: 8});

                companyDetails.forEach(detail => {
                    doc.setFontSize(detail.size);
                    doc.setFont('helvetica', detail.font);
                    doc.text(detail.text, pageWidth - margin, textY, { align: 'right' });
                    textY += (detail.size * 0.3) + 0.5; /* Otimização: Reduz espaçamento entre linhas do cabeçalho */
                });

                yPosRef.y = Math.max(startY, textY) + 5;
                doc.setDrawColor(200);
                doc.line(margin, yPosRef.y, pageWidth - margin, yPosRef.y);
                yPosRef.y += 5;
            };

            const addFooter = (doc, pageNum, totalPages, message = '') => { /* Otimização: Adiciona mensagem de agradecimento como parâmetro */
                const margin = 15;
                const pageHeight = doc.internal.pageSize.getHeight();
                const pageWidth = doc.internal.pageSize.getWidth();
                doc.setDrawColor(200);
                doc.line(margin, pageHeight - 30, pageWidth - margin, pageHeight - 30); /* Ajusta linha para cima */
                doc.setFontSize(8);
                doc.setTextColor(100);

                // Mensagem de agradecimento
                if (message && message.trim() !== '') {
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'italic');
                    const splitMsg = doc.splitTextToSize(message, pageWidth - (2 * margin) - 10);
                    doc.text(splitMsg, pageWidth / 2, pageHeight - 24, { align: 'center' }); /* Otimização: Posição da mensagem no rodapé */
                }
                
                // Número da página
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text(`Página ${pageNum} de ${totalPages}`, pageWidth / 2, pageHeight - 15, { align: 'center' }); /* Posição do número da página */
                doc.setTextColor(0, 0, 0);
            };

            const addConditionalTextLine = (doc, yPosRef, label, value, size, style, spaceAfter, options = {}) => {
                const margin = options.margin || 15; /* Otimização: Margem padrão de 15 */
                const maxWidth = options.maxWidth || (doc.internal.pageSize.getWidth() - margin * 2);
                const align = options.align || 'left';
                const pageHeight = doc.internal.pageSize.getHeight();
                const footerHeight = 40; /* Otimização: Aumenta footerHeight para considerar mensagem de agradecimento */

                const stringValue = (value === undefined || value === null) ? '' : String(value).trim();

                // NÂO exibe se o valor estiver vazio
                if (!stringValue && options.hideIfEmpty !== false) { // hideIfEmpty default true
                    return;
                }

                doc.setFontSize(size);
                doc.setFont('helvetica', style || 'normal');
                const textToSplit = label ? `${label}: ${stringValue}` : stringValue;
                const splitText = doc.splitTextToSize(textToSplit, maxWidth);

                splitText.forEach((line) => {
                    const expectedY = yPosRef.y + (size * 0.35); /* Otimização: Reduz espaçamento entre linhas */

                    if (expectedY > pageHeight - footerHeight) {
                        addFooter(doc, yPosRef.pageNumber, yPosRef.totalPages, options.footerMessage || ''); // Passa a mensagem de rodapé
                        doc.addPage();
                        yPosRef.pageNumber++;
                        yPosRef.totalPages = Math.max(yPosRef.totalPages, yPosRef.pageNumber);
                        yPosRef.y = 15;
                        addHeader(doc, state.configuracoes, yPosRef); // Adiciona cabeçalho na nova página
                    }
                    doc.text(line, align === 'center' ? doc.internal.pageSize.getWidth() / 2 : margin, yPosRef.y, { align: align });
                    yPosRef.y += (size * 0.35) + 0.5; /* Otimização: Reduz espaçamento entre linhas */
                });
                yPosRef.y += spaceAfter;
            };


             const addSignatureLines = (doc, yPosRef, config, cliente) => {
                const margin = 15;
                const center = doc.internal.pageSize.getWidth() / 2;
                const lineLength = 70;
                const signatureBlockHeight = 50;

                yPosRef.y = addPageIfNeeded(doc, yPosRef, signatureBlockHeight, config);

                const currentY = yPosRef.y + 10;

                doc.setDrawColor(0);
                doc.setLineWidth(0.5);

                // Assinatura da Contratada (Empresa)
                doc.line(center - lineLength - 10, currentY, center - 10, currentY);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(config.empresa?.empresaNome || '______________________________', center - lineLength/2 - 10, currentY + 5, { align: 'center' });
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text('CONTRATADA', center - lineLength/2 - 10, currentY + 9, { align: 'center' });
                if(config.empresa?.empresaDoc && config.empresa.empresaDoc.trim() !== '') doc.text(`CPF/CNPJ: ${config.empresa.empresaDoc}`, center - lineLength/2 - 10, currentY + 13, { align: 'center' });
                if(config.empresa?.empresaContato && config.empresa.empresaContato.trim() !== '') doc.text(`Contato: ${config.empresa.empresaContato}`, center - lineLength/2 - 10, currentY + 17, { align: 'center' });


                // Assinatura da Contratante (Cliente)
                doc.line(center + 10, currentY, center + lineLength + 10, currentY);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(cliente?.nome || '______________________________', center + lineLength/2 + 10, currentY + 5, { align: 'center' });
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text('CONTRATANTE', center + lineLength/2 + 10, currentY + 9, { align: 'center' });
                if(cliente?.docCliente && cliente.docCliente.trim() !== '') doc.text(`CPF/CNPJ: ${cliente.docCliente}`, center + lineLength/2 + 10, currentY + 13, { align: 'center' });
                if(cliente?.contato && cliente.contato.trim() !== '') doc.text(`Contato: ${cliente.contato}`, center + lineLength/2 + 10, currentY + 17, { align: 'center' });

                yPosRef.y = currentY + 25;
             };

            const addPageIfNeeded = (doc, yPosRef, requiredHeight, config, message = '') => {
                const pageHeight = doc.internal.pageSize.getHeight();
                const footerHeight = 40; /* Otimização: Aumenta footerHeight para considerar mensagem de agradecimento */
                if (yPosRef.y + requiredHeight > pageHeight - footerHeight) {
                    doc.addPage();
                    yPosRef.pageNumber++;
                    yPosRef.totalPages = Math.max(yPosRef.totalPages, yPosRef.pageNumber);
                    yPosRef.y = 15; // Reset Y position for new page, header will be drawn by didDrawPage
                }
                return yPosRef.y;
            };

            const validateCompanyConfig = () => {
                const config = state.configuracoes.empresa;
                if (!config || !config.empresaNome || !config.empresaEndereco || !config.empresaContato) {
                    alert("Por favor, preencha os dados da sua empresa na aba 'Configurações' antes de gerar documentos.");
                    showTab('configuracoes');
                    return false;
                }
                return true;
            };

            const generateOrderPDF = (pedido) => {
                if (!validateCompanyConfig()) return;
                try {
                    if (!pedido) { alert("Pedido não encontrado."); return; }
                    const doc = new jsPDF();
                    const config = state.configuracoes;
                    const cliente = getClientById(pedido.clienteId);

                    const margin = 10; /* Otimização: Margens mais estreitas */
                    const pageWidth = doc.internal.pageSize.getWidth();
                    let yPosRef = { y: 15, pageNumber: 1, totalPages: 1 };

                    const primaryColor = [106, 90, 205];
                    const lightGray = [240, 240, 240];

                    addHeader(doc, config, yPosRef); // Adiciona o cabeçalho apenas uma vez para a primeira página

                    doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.rect(margin, yPosRef.y, pageWidth - 2 * margin, 10, 'F');
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text(`ORÇAMENTO / PEDIDO Nº ${pedido.id.substring(4, 10)}`, pageWidth / 2, yPosRef.y + 7, { align: 'center' });
                    doc.setTextColor(0, 0, 0);
                    yPosRef.y += 15;

                    yPosRef.y = addPageIfNeeded(doc, yPosRef, 120, config);
                    doc.setFontSize(11); /* Otimização: Fonte ligeiramente menor */
                    doc.setFont('helvetica', 'bold');
                    doc.text('Dados do Cliente:', margin, yPosRef.y);
                    yPosRef.y += 6; /* Otimização: Espaçamento reduzido */

                    const clienteData = [
                        ['Nome', cliente.nome || ''],
                        ['Contato', cliente.contato || ''],
                        ['Email', cliente.emailCliente || ''],
                        ['Endereço', cliente.enderecoCliente || '']
                    ].filter(row => row[1].trim() !== ''); // Filtra linhas com valores vazios

                    doc.autoTable({
                        startY: yPosRef.y,
                        body: clienteData,
                        theme: 'plain',
                        styles: { fontSize: 9, cellPadding: 1, textColor: [51, 51, 51], lineHeight: 1.1 }, /* Otimização: Fonte e padding menores, line-height */
                        columnStyles: { 0: { fontStyle: 'bold', cellWidth: 30 } },
                        margin: { left: margin, right: margin },
                        tableLineColor: [220, 220, 220],
                        tableLineWidth: 0.1,
                        didDrawPage: (data) => {
                            if (data.pageNumber > 1) { // Adiciona cabeçalho apenas em páginas subsequentes
                                addHeader(doc, config, yPosRef);
                            }
                            yPosRef.y = data.cursor.y;
                            yPosRef.pageNumber = doc.internal.getNumberOfPages();
                        }
                    });
                    yPosRef.y = doc.autoTable.previous.finalY + 8; /* Otimização: Espaçamento reduzido */

                    doc.setFontSize(11); /* Otimização: Fonte ligeiramente menor */
                    doc.setFont('helvetica', 'bold');
                    doc.text('Detalhes do Evento:', margin, yPosRef.y);
                    yPosRef.y += 6; /* Otimização: Espaçamento reduzido */

                    const eventData = [
                        ['Tipo', pedido.tipoEvento || ''],
                        ['Tema', pedido.temaEvento || ''],
                        ['Nº de Pessoas', pedido.numeroPessoas || ''],
                        ['Data', formatDate(pedido.dataEvento)],
                        ['Horário', `${pedido.horaInicio || ''}${pedido.horaInicio && pedido.horaFinal ? ' - ' : ''}${pedido.horaFinal || ''}`],
                        ['Local', pedido.localEvento || '']
                    ].filter(row => row[1].toString().trim() !== ''); // Converte para string e filtra

                    doc.autoTable({
                        startY: yPosRef.y,
                        body: eventData,
                        theme: 'plain',
                        styles: { fontSize: 9, cellPadding: 1, textColor: [51, 51, 51], lineHeight: 1.1 }, /* Otimização: Fonte e padding menores, line-height */
                        columnStyles: { 0: { fontStyle: 'bold', cellWidth: 30 } },
                        margin: { left: margin, right: margin },
                        tableLineColor: [220, 220, 220],
                        tableLineWidth: 0.1,
                        didDrawPage: (data) => {
                            if (data.pageNumber > 1) { // Adiciona cabeçalho apenas em páginas subsequentes
                                addHeader(doc, config, yPosRef);
                            }
                            yPosRef.y = data.cursor.y;
                            yPosRef.pageNumber = doc.internal.getNumberOfPages();
                        }
                    });
                    yPosRef.y = doc.autoTable.previous.finalY + 8; /* Otimização: Espaçamento reduzido */

                    yPosRef.y = addPageIfNeeded(doc, yPosRef, 80, config);
                    doc.setFontSize(11); /* Otimização: Fonte ligeiramente menor */
                    doc.setFont('helvetica', 'bold');
                    doc.text('Serviços Contratados:', margin, yPosRef.y);
                    yPosRef.y += 6; /* Otimização: Espaçamento reduzido */

                    const servicosArray = (pedido.servicos || '')
                                         .split('\n')
                                         .map(s => s.trim())
                                         .filter(s => s !== '')
                                         .map(s => [s]); // Garante que a linha é um array de array para autoTable
                                         
                    const servicosData = servicosArray.length > 0 ? servicosArray : [['Nenhum serviço detalhado.']];

                    doc.autoTable({
                        startY: yPosRef.y,
                        head: [['Descrição do Serviço']],
                        body: servicosData,
                        theme: 'striped',
                        headStyles: {
                            fillColor: primaryColor,
                            textColor: 255,
                            fontSize: 9, /* Otimização: Fonte menor */
                            fontStyle: 'bold'
                        },
                        styles: { cellPadding: 2, fontSize: 9, textColor: 51, lineHeight: 1.1 }, /* Otimização: Padding, fonte menor e line-height */
                        margin: { left: margin, right: margin },
                        didDrawPage: (data) => {
                            if (data.pageNumber > 1) { // Adiciona cabeçalho apenas em páginas subsequentes
                                addHeader(doc, config, yPosRef);
                            }
                            yPosRef.y = data.cursor.y;
                            yPosRef.pageNumber = doc.internal.getNumberOfPages();
                        }
                    });
                    yPosRef.y = doc.autoTable.previous.finalY + 5;

                    yPosRef.y = addPageIfNeeded(doc, yPosRef, 30, config);
                    doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
                    doc.rect(margin, yPosRef.y, pageWidth - 2 * margin, 10, 'F');
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(51, 51, 51);
                    doc.text('VALOR TOTAL:', margin + 5, yPosRef.y + 7);
                    doc.text(formatCurrency(pedido.valorTotal), pageWidth - margin - 5, yPosRef.y + 7, { align: 'right' });
                    yPosRef.y += 15;

                    yPosRef.y = addPageIfNeeded(doc, yPosRef, 50, config);
                    doc.setFontSize(11); /* Otimização: Fonte ligeiramente menor */
                    doc.setFont('helvetica', 'bold');
                    doc.text('Condições de Pagamento:', margin, yPosRef.y);
                    yPosRef.y += 6; /* Otimização: Espaçamento reduzido */
                    doc.setFontSize(9); /* Otimização: Fonte menor */
                    doc.setFont('helvetica', 'normal');
                    addConditionalTextLine(doc, yPosRef, null, 'Métodos de Pagamento: PIX / Dinheiro', 9, 'bold', 1, {margin: margin, footerMessage: 'Agradecemos a preferência! Faremos do seu evento um sucesso inesquecível.'}); /* Otimização: Reduz espaçamento */
                    addConditionalTextLine(doc, yPosRef, null, `Chave PIX: ${config.empresa?.empresaDoc || ''}`, 9, 'normal', 1, {margin: margin, footerMessage: 'Agradecemos a preferência! Faremos do seu evento um sucesso inesquecível.'}); /* Otimização: Reduz espaçamento */
                    addConditionalTextLine(doc, yPosRef, null, 'Condição: Sinal de 50% para reserva da data, e o restante antes do início do evento.', 9, 'normal', 8, {margin: margin, footerMessage: 'Agradecemos a preferência! Faremos do seu evento um sucesso inesquecível.'}); /* Otimização: Reduz espaçamento */

                    if (pedido.observacoes && pedido.observacoes.trim() !== '') {
                        yPosRef.y = addPageIfNeeded(doc, yPosRef, 40, config);
                        doc.setFontSize(11); /* Otimização: Fonte ligeiramente menor */
                        doc.setFont('helvetica', 'bold');
                        doc.text('Observações:', margin, yPosRef.y);
                        yPosRef.y += 6; /* Otimização: Espaçamento reduzido */
                        doc.setFontSize(9); /* Otimização: Fonte menor */
                        doc.setFont('helvetica', 'normal');
                        addConditionalTextLine(doc, yPosRef, null, pedido.observacoes, 9, 'normal', 8, {margin: margin, footerMessage: 'Agradecemos a preferência! Faremos do seu evento um sucesso inesquecível.'}); /* Otimização: Reduz espaçamento */
                    }

                    const cidadeRecibo = getCidadeFromConfig();
                    yPosRef.y = addPageIfNeeded(doc, yPosRef, 20, config); // Garante espaço para a data antes do rodapé
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'italic');
                    addConditionalTextLine(doc, yPosRef, null, `${cidadeRecibo}, ${new Date().toLocaleDateString('pt-BR')}.`, 9, 'italic', 10, {align: 'center', margin: 20, footerMessage: 'Agradecemos a preferência! Faremos do seu evento um sucesso inesquecível.'});
                   
                    const totalPages = doc.internal.getNumberOfPages();
                    for(let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        addFooter(doc, i, totalPages, 'Agradecemos a preferência! Faremos do seu evento um sucesso inesquecível.');
                    }
                    doc.save(`Orcamento_${pedido.id.substring(4, 10)}_${cliente?.nome || 'Cliente'}.pdf`);
                } catch (error) {
                    console.error("Erro ao gerar PDF do Pedido:", error);
                    alert(`Ocorreu um erro ao gerar o PDF do Pedido: ${error.message}\n${error.stack}`);
                }
            };

            const generateContractPDF = (pedido) => {
                 if (!validateCompanyConfig()) return;
                 try {
                    const doc = new jsPDF();
                    const config = state.configuracoes;
                    const cliente = getClientById(pedido.clienteId);
                    let yPosRef = { y: 15, pageNumber: 1, totalPages: 1 };

                    const primaryColor = [106, 90, 205];

                    addHeader(doc, config, yPosRef); // Adiciona o cabeçalho apenas uma vez para a primeira página

                    doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.rect(15, yPosRef.y, doc.internal.pageSize.getWidth() - 30, 12, 'F');
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('CONTRATO DE PRESTAÇÃO DE SERVIÇOS', doc.internal.pageSize.getWidth() / 2, yPosRef.y + 8, { align: 'center' });
                    doc.setTextColor(0, 0, 0);
                    yPosRef.y += 20;


                    yPosRef.y = addPageIfNeeded(doc, yPosRef, 80, config);
                    doc.setFontSize(13); /* Otimização: Fonte ligeiramente menor */
                    doc.setFont('helvetica', 'bold');
                    doc.text('1. IDENTIFICAÇÃO DAS PARTES', 15, yPosRef.y);
                    yPosRef.y += 8; /* Otimização: Espaçamento reduzido */

                    doc.setFontSize(10); /* Otimização: Fonte ligeiramente menor */
                    doc.setFont('helvetica', 'bold');
                    doc.text('CONTRATANTE:', 20, yPosRef.y);
                    yPosRef.y += 4; /* Otimização: Espaçamento reduzido */

                    const contratanteData = [
                        ['Nome', cliente.nome || ''],
                        ['CPF/CNPJ', cliente.docCliente || ''],
                        ['Endereço', cliente.enderecoCliente || ''],
                        ['Contato', cliente.contato || ''],
                        ['Email', cliente.emailCliente || '']
                    ].filter(row => row[1].trim() !== ''); // Filtra linhas com valores vazios

                    doc.autoTable({
                        startY: yPosRef.y,
                        body: contratanteData,
                        theme: 'plain',
                        styles: { fontSize: 9, cellPadding: 1, textColor: [51, 51, 51], lineHeight: 1.1 }, /* Otimização: Fonte e padding menores, line-height */
                        columnStyles: { 0: { fontStyle: 'bold', cellWidth: 30 } },
                        margin: { left: 25, right: 15 },
                        didDrawPage: (data) => {
                            if (data.pageNumber > 1) { // Adiciona cabeçalho apenas em páginas subsequentes
                                addHeader(doc, config, yPosRef);
                            }
                            yPosRef.y = data.cursor.y;
                            yPosRef.pageNumber = doc.internal.getNumberOfPages();
                        }
                    });
                    yPosRef.y = doc.autoTable.previous.finalY + 8; /* Otimização: Espaçamento reduzido */

                    yPosRef.y = addPageIfNeeded(doc, yPosRef, 60, config);
                    doc.setFontSize(10); /* Otimização: Fonte ligeiramente menor */
                    doc.setFont('helvetica', 'bold');
                    doc.text('CONTRATADA:', 20, yPosRef.y);
                    yPosRef.y += 4; /* Otimização: Espaçamento reduzido */

                    const contratadaData = [
                        ['Nome', config.empresa?.empresaNome || ''],
                        ['CNPJ/CPF', config.empresa?.empresaDoc || ''],
                        ['Endereço', config.empresa?.empresaEndereco || ''],
                        ['Contato', config.empresa?.empresaContato || ''],
                        ['Email', config.empresa?.empresaEmail || '']
                    ].filter(row => row[1].trim() !== ''); // Filtra linhas com valores vazios

                    doc.autoTable({
                        startY: yPosRef.y,
                        body: contratadaData,
                        theme: 'plain',
                        styles: { fontSize: 9, cellPadding: 1, textColor: [51, 51, 51], lineHeight: 1.1 }, /* Otimização: Fonte e padding menores, line-height */
                        columnStyles: { 0: { fontStyle: 'bold', cellWidth: 30 } },
                        margin: { left: 25, right: 15 },
                        didDrawPage: (data) => {
                            if (data.pageNumber > 1) { // Adiciona cabeçalho apenas em páginas subsequentes
                                addHeader(doc, config, yPosRef);
                            }
                            yPosRef.y = data.cursor.y;
                            yPosRef.pageNumber = doc.internal.getNumberOfPages();
                        }
                    });
                    yPosRef.y = doc.autoTable.previous.finalY + 12; /* Otimização: Espaçamento reduzido */

                    const clauses = [
                        { title: '2. DO OBJETO DO CONTRATO', content: `O presente contrato tem por objeto a prestação de serviços de Disc Jockey (DJ) ${pedido.servicos && pedido.servicos.trim() !== '' ? 'e serviços adicionais' : ''} para o evento "${pedido.tipoEvento && pedido.tipoEvento.trim() !== '' ? pedido.tipoEvento : '(Tipo não informado)'}", a ser realizado em ${formatDate(pedido.dataEvento)}, das ${pedido.horaInicio && pedido.horaInicio.trim() !== '' ? pedido.horaInicio : '(Hora Início não informada)'} às ${pedido.horaFinal && pedido.horaFinal.trim() !== '' ? pedido.horaFinal : '(Hora Final não informada)'}, no seguinte local: ${pedido.localEvento && pedido.localEvento.trim() !== '' ? pedido.localEvento : '(Local não informado)'}.${pedido.servicos && pedido.servicos.trim() !== '' ? `\n\nServiços Inclusos:\n- ${pedido.servicos.replace(/\n/g, '\n- ')}` : ''}` },
                        { title: '3. DAS OBRIGAÇÕES DA CONTRATADA', content: `I - Comparecer ao local do evento com antecedência mínima de 60 minutos para montagem e testes.\nII - Fornecer todo o equipamento necessário para a prestação dos serviços descritos na Cláusula 2ª, em perfeito estado de funcionamento.\nIII - Executar os serviços com zelo, profissionalismo e de acordo com o perfil musical previamente alinhado com a CONTRATANTE, se aplicável.\nIV - Manter-se disponível durante todo o período contratado.` },
                        { title: '4. DAS OBRIGAÇÕES DA CONTRATANTE', content: `I - Fornecer à CONTRATADA um local seguro e adequado para a instalação dos equipamentos, com ponto de energia elétrica estável e compatível.\nII - Garantir o acesso da CONTRATADA e sua equipe ao local do evento para montagem e desmontagem.\nIII - Efetuar o pagamento do valor acordado na forma e prazo estipulados na Cláusula 5ª.\nIV - Responsabilizar-se por eventuais danos causados aos equipamentos da CONTRATADA por seus convidados, exceto por falha técnica.` },
                        { title: '5. DO VALOR E FORMA DE PAGAMENTO', content: `Pelos serviços prestados, a CONTRATANTE pagará à CONTRATADA o valor total de ${formatCurrency(pedido.valorTotal)}. O pagamento será realizado da seguinte forma: 50% de sinal no ato da assinatura e o restante no dia do evento antes do início dos serviços.` },
                        { title: '6. DA RESCISÃO E CANCELAMENTO', content: `Em caso de cancelamento por parte da CONTRATANTE com menos de 15 dias de antecedência do evento, incidirá multa de 30% do valor total do contrato, retendo-se o sinal pago. Em caso de cancelamento pela CONTRATADA, exceto por motivo de força maior devidamente comprovado, esta devolverá integralmente os valores já pagos no prazo de 5 dias úteis e, se possível, indicará outro profissional qualificado de igual competência.` },
                        { title: '7. DAS DISPOSIÇÕES GERAIS', content: `Este contrato não estabelece vínculo empregatício entre as partes. Fica eleito o foro da comarca de ${getCidadeFromConfig() || getCidadeFromCliente()} para dirimir quaisquer dúvidas oriundas deste contrato.` }
                    ];

                    clauses.forEach(clause => {
                        yPosRef.y = addPageIfNeeded(doc, yPosRef, 50, config);
                        doc.setFontSize(13); doc.setFont('helvetica', 'bold'); /* Otimização: Fonte ligeiramente menor */
                        doc.text(clause.title, 15, yPosRef.y); yPosRef.y += 6; /* Otimização: Espaçamento reduzido */
                        doc.setFontSize(9); doc.setFont('helvetica', 'normal'); /* Otimização: Fonte menor */
                        addConditionalTextLine(doc, yPosRef, null, clause.content, 9, 'normal', 6, {margin: 20, footerMessage: ''});
                    });

                    yPosRef.y = addPageIfNeeded(doc, yPosRef, 50, config);
                    addConditionalTextLine(doc, yPosRef, null, `E, por estarem justas e contratadas, assinam o presente contrato em 2 (duas) vias de igual teor e forma.`, 9, 'normal', 8, {align: 'center', margin: 20, footerMessage: ''}); /* Otimização: Fonte e espaçamento */
                    const cidadeForo = getCidadeFromConfig() || getCidadeFromCliente();
                    addConditionalTextLine(doc, yPosRef, null, `${cidadeForo}, ${new Date().toLocaleDateString('pt-BR')}.`, 9, 'normal', 25, {align: 'center', margin: 20, footerMessage: ''}); /* Otimização: Fonte e espaçamento */

                    yPosRef.y = addPageIfNeeded(doc, yPosRef, 80, config);
                    addSignatureLines(doc, yPosRef, config, cliente);

                    const totalPagesFinal = doc.internal.getNumberOfPages();
                     for (let i = 1; i <= totalPagesFinal; i++) {
                        doc.setPage(i);
                        addFooter(doc, i, totalPagesFinal, ''); // Contrato não tem mensagem de agradecimento no rodapé padrão
                    }

                    doc.save(`Contrato_${pedido.id.substring(4, 10)}_${cliente?.nome || 'Cliente'}.pdf`);
                } catch (error) {
                    console.error("Erro detalhado ao gerar PDF do Contrato:", error);
                    alert(`Ocorreu um erro ao gerar o PDF do Contrato: ${error.message}\n\nStack: ${error.stack}`);
                }
            };

            const generateReceiptPDF = (financeEntry) => {
                if (!validateCompanyConfig()) return;
                try {
                    const doc = new jsPDF();
                    const config = state.configuracoes;
                    let clienteNome = "Cliente Diversos";
                    let pedidoRef = "";
                    let clienteDoc = "";
                    let cidadeRecibo = getCidadeFromConfig(); // Tenta a cidade da empresa primeiro

                    if (financeEntry.pedidoId) {
                        const pedidoAssociado = getPedidoById(financeEntry.pedidoId);
                        if (pedidoAssociado && pedidoAssociado.clienteId) {
                            const clienteAssociado = getClientById(pedidoAssociado.clienteId);
                            clienteNome = clienteAssociado.nome || 'Cliente Desconhecido';
                            clienteDoc = clienteAssociado.docCliente || '';

                            // Se houver cliente associado ao pedido, tenta obter a cidade do endereço do cliente
                            if (clienteAssociado?.enderecoCliente) {
                                const parts = clienteAssociado.enderecoCliente.split(',').map(s => s.trim());
                                for (let i = parts.length - 1; i >= 0; i--) {
                                    if (isNaN(parseInt(parts[i])) && parts[i].length > 2) {
                                        cidadeRecibo = parts[i];
                                        break;
                                    }
                                }
                            }
                        }
                        pedidoRef = `referente ao pedido #${financeEntry.pedidoId.substring(4, 10)}`;
                    }

                    let yPosRef = { y: 15, pageNumber: 1, totalPages: 1 };

                    // Cores para um visual mais moderno (iguais às do contrato)
                    const primaryColor = [106, 90, 205]; // Roxo
                    const lightGray = [240, 240, 240]; // Cinza claro
                    const darkText = [51, 51, 51]; // Texto escuro

                    addHeader(doc, config, yPosRef); // Adiciona o cabeçalho apenas uma vez para a primeira página

                    // Título do Recibo com fundo e borda
                    doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.rect(15, yPosRef.y, doc.internal.pageSize.getWidth() - 30, 12, 'F');
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(255, 255, 255); // Texto branco
                    doc.text('RECIBO DE PAGAMENTO', doc.internal.pageSize.getWidth() / 2, yPosRef.y + 8, { align: 'center' });
                    doc.setTextColor(darkText[0], darkText[1], darkText[2]); // Volta para cor de texto padrão
                    yPosRef.y += 20;

                    // Bloco de Informações do Recibo (centralizado e com espaçamento)
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');

                    const valueText = `Valor Recebido: ${formatCurrency(financeEntry.valor)}`;
                    addConditionalTextLine(doc, yPosRef, null, valueText, 14, 'bold', 10, { align: 'center', footerMessage: ''});

                    doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
                    doc.rect(20, yPosRef.y, doc.internal.pageSize.getWidth() - 40, 45, 'F'); // Um bloco maior para as informações principais /* Otimização: Altura do bloco */
                    doc.setDrawColor(200);
                    doc.setLineWidth(0.5);
                    doc.rect(20, yPosRef.y, doc.internal.pageSize.getWidth() - 40, 45, 'S'); // Borda no bloco /* Otimização: Altura do bloco */

                    yPosRef.y += 6; // Padding interno /* Otimização: Padding interno */
                    const textX = 25; // Posição X para o texto dentro do bloco

                    doc.setFontSize(9); /* Otimização: Fonte menor */
                    doc.setFont('helvetica', 'normal');
                    doc.text('Recebemos de:', textX, yPosRef.y);
                    doc.setFont('helvetica', 'bold');
                    doc.text(clienteNome, textX + 27, yPosRef.y); /* Otimização: Ajuste de posição */
                    yPosRef.y += 5; /* Otimização: Espaçamento reduzido */

                    if (clienteDoc && clienteDoc.trim() !== '') {
                        doc.setFont('helvetica', 'normal');
                        doc.text('CPF/CNPJ:', textX, yPosRef.y);
                        doc.setFont('helvetica', 'bold');
                        doc.text(clienteDoc, textX + 20, yPosRef.y); /* Otimização: Ajuste de posição */
                        yPosRef.y += 5; /* Otimização: Espaçamento reduzido */
                    }

                    doc.setFont('helvetica', 'normal');
                    doc.text('Data do Recebimento:', textX, yPosRef.y);
                    doc.setFont('helvetica', 'bold');
                    doc.text(formatDate(financeEntry.data), textX + 38, yPosRef.y); /* Otimização: Ajuste de posição */
                    yPosRef.y += 5; /* Otimização: Espaçamento reduzido */

                    if (financeEntry.formaPagamento && financeEntry.formaPagamento.trim() !== '') {
                        doc.setFont('helvetica', 'normal');
                        doc.text('Forma de Pagamento:', textX, yPosRef.y);
                        doc.setFont('helvetica', 'bold');
                        doc.text(financeEntry.formaPagamento, textX + 41, yPosRef.y); /* Otimização: Ajuste de posição */
                        yPosRef.y += 8; // Mais espaço para a descrição
                    }

                    // Ajusta yPosRef.y para fora do bloco cinza
                    yPosRef.y = Math.max(yPosRef.y, doc.autoTable.previous ? doc.autoTable.previous.finalY : doc.internal.pageSize.getHeight() / 2) + 10; /* Otimização: Espaçamento */


                    doc.setFontSize(9); /* Otimização: Fonte menor */
                    doc.setFont('helvetica', 'normal');
                    let descriptionText = `A quantia de ${formatCurrency(financeEntry.valor)}`;

                    // Usar a descrição do formulário se ela for específica, senão usar a referência do pedido
                    if (financeEntry.descricao && financeEntry.descricao.trim() !== "Pagamento Recebido") {
                        descriptionText += `, referente a: "${financeEntry.descricao}".`;
                    } else if (pedidoRef) {
                        descriptionText += `, ${pedidoRef}.`;
                    } else {
                        descriptionText += `.`;
                    }
                    addConditionalTextLine(doc, yPosRef, null, descriptionText, 9, 'normal', 15, {footerMessage: ''});

                    // Informações da empresa e data do recibo
                    if (cidadeRecibo && cidadeRecibo.trim() !== '') {
                        addConditionalTextLine(doc, yPosRef, null, `${cidadeRecibo}, ${new Date().toLocaleDateString('pt-BR')}.`, 9, 'normal', 20, { align: 'center', footerMessage: ''}); /* Otimização: Fonte e espaçamento */
                    }

                    // Assinatura
                    const center = doc.internal.pageSize.getWidth() / 2;
                    doc.setDrawColor(0);
                    doc.setLineWidth(0.5);
                    doc.line(center - 35, yPosRef.y, center + 35, yPosRef.y);
                    yPosRef.y += 5;
                    doc.setFontSize(9); /* Otimização: Fonte menor */
                    doc.setFont('helvetica', 'bold');
                    if (config.empresa?.empresaNome && config.empresa.empresaNome.trim() !== '') addConditionalTextLine(doc, yPosRef, null, config.empresa.empresaNome, 9, 'normal', 3, { align: 'center', force: true, footerMessage: ''}); /* Otimização: Fonte e espaçamento */
                    doc.setFont('helvetica', 'normal');
                    addConditionalTextLine(doc, yPosRef, null, 'Recebido por', 9, 'normal', 0, { align: 'center', force: true, footerMessage: ''}); /* Otimização: Fonte */

                    const totalPages = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        addFooter(doc, i, totalPages, ''); // Recibo não tem mensagem de agradecimento padrão
                    }
                    doc.save(`Recibo_${financeEntry.id.substring(4, 10)}_${clienteNome}.pdf`);
                } catch (error) {
                    console.error("Erro ao gerar PDF do Recibo:", error);
                    alert(`Ocorreu um erro ao gerar o PDF do Recibo: ${error.message}\n${error.stack}`);
                }
            };

            // Nova função para gerar relatórios gerais
            const generateReportPDF = (type, title, headers, dataMapper, filterFn = null) => {
                if (!validateCompanyConfig()) return;
                try {
                    const doc = new jsPDF('p', 'mm', 'a4'); // 'p' para retrato, 'mm' para milímetros, 'a4' para tamanho de página
                    const config = state.configuracoes;
                    let yPosRef = { y: 15, pageNumber: 1, totalPages: 1 };

                    addHeader(doc, config, yPosRef); // Adiciona o cabeçalho apenas uma vez para a primeira página

                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text(title, doc.internal.pageSize.getWidth() / 2, yPosRef.y, { align: 'center' });
                    yPosRef.y += 10;
                    doc.setDrawColor(200);
                    doc.line(15, yPosRef.y, doc.internal.pageSize.getWidth() - 15, yPosRef.y);
                    yPosRef.y += 5;

                    const filteredData = filterFn ? state[type].filter(filterFn) : state[type];
                    // Mapper modificado para garantir que os valores nulos/vazios sejam tratados consistentemente
                    const tableData = filteredData.map(item => {
                        const mappedRow = dataMapper(item);
                        return mappedRow.map(cell => (cell === 'N/A' || cell === null || cell === undefined || (typeof cell === 'string' && cell.trim() === '')) ? '' : cell);
                    }).filter(row => row.some(cell => cell !== '')); // Remove linhas completamente vazias

                    if (tableData.length === 0) {
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'normal');
                        doc.text('Nenhum dado encontrado para este relatório.', doc.internal.pageSize.getWidth() / 2, yPosRef.y + 20, { align: 'center' });
                    } else {
                        doc.autoTable({
                            startY: yPosRef.y,
                            head: [headers],
                            body: tableData,
                            theme: 'striped',
                            headStyles: { fillColor: [106, 90, 205], textColor: 255, fontSize: 9, fontStyle: 'bold' },
                            styles: { fontSize: 8, cellPadding: 2, textColor: [51, 51, 51], lineHeight: 1.1 }, /* Otimização: Fonte e espaçamento */
                            margin: { top: 10, left: 15, right: 15 },
                            didDrawPage: (data) => {
                                if (data.pageNumber > 1) { // Adiciona cabeçalho apenas em páginas subsequentes
                                    addHeader(doc, config, yPosRef);
                                }
                                yPosRef.y = data.cursor.y;
                                yPosRef.pageNumber = doc.internal.getNumberOfPages();
                            }
                        });
                        yPosRef.y = doc.autoTable.previous.finalY + 10;
                    }
                    
                    const totalPagesFinal = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPagesFinal; i++) {
                        doc.setPage(i);
                        addFooter(doc, i, totalPagesFinal, ''); // Relatórios não precisam de mensagem de agradecimento padrão
                    }

                    doc.save(`Relatorio_${type}_${new Date().toISOString().split('T')[0]}.pdf`);

                } catch (error) {
                    console.error(`Erro ao gerar relatório de ${type}:`, error);
                    alert(`Ocorreu um erro ao gerar o relatório: ${error.message}`);
                }
            };


            const sendWhatsApp = (pedido) => {
                try {
                    if (!pedido) { alert("Pedido não encontrado ou não salvo."); return; }
                    const config = state.configuracoes;
                    const cliente = getClientById(pedido.clienteId);

                    let msg = `*Orçamento - ${config.empresa?.empresaNome || 'DJ'}*\n\n`;
                    msg += `Olá ${cliente?.nome || 'Cliente'}!\n`;
                    msg += `Segue um resumo do seu pedido (#${pedido.id.substring(4, 10)}):\n\n`;
                    if(pedido.tipoEvento && pedido.tipoEvento.trim() !== '') msg += `*Evento:* ${pedido.tipoEvento}\n`;
                    // Ajuste para não incluir linha se data ou horário estiverem vazios
                    const dataHoraEvento = `${formatDate(pedido.dataEvento)} (${pedido.horaInicio || ''}${pedido.horaInicio && pedido.horaFinal ? ' - ' : ''}${pedido.horaFinal || ''})`;
                    if(dataHoraEvento.trim() !== '( - )' && dataHoraEvento.trim() !== 'N/A ( - )') msg += `*Data:* ${dataHoraEvento}\n`;
                    
                    if(pedido.localEvento && pedido.localEvento.trim() !== '') msg += `*Local:* ${pedido.localEvento}\n`;
                    if(pedido.servicos && pedido.servicos.trim() !== '') msg += `*Serviços:* ${pedido.servicos.replace(/\n/g, ' / ')}\n`;
                    msg += `*Valor Total:* ${formatCurrency(pedido.valorTotal)}\n\n`;
                    if(pedido.observacoes && pedido.observacoes.trim() !== '') msg += `*Observações:* ${pedido.observacoes}\n\n`; // Adicionado observações no WhatsApp
                    msg += `Qualquer dúvida, estou à disposição!\n`;
                    if(config.empresa?.empresaNome && config.empresa.empresaNome.trim() !== '') msg += `${config.empresa.empresaNome}\n`;
                    if(config.empresa?.empresaContato && config.empresa.empresaContato.trim() !== '') msg += `${config.empresa.empresaContato}`;

                    const encodedMsg = encodeURIComponent(msg);
                    const clienteNumero = (cliente?.contato || '').replace(/\D/g, '');

                    if (!clienteNumero) {
                        alert("Número de telefone do cliente não encontrado. Por favor, cadastre o contato do cliente.");
                        return;
                    }

                    const whatsappURL = `https://wa.me/${clienteNumero}?text=${encodedMsg}`;

                    window.open(whatsappURL, '_blank');
                } catch (error) {
                    console.error("Erro ao enviar mensagem via WhatsApp:", error);
                    alert(`Ocorreu um erro ao tentar enviar via WhatsApp: ${error.message}`);
                }
            };
            const exportData = () => {
                const dataStr = JSON.stringify(state, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = `backup_dj_system_${new Date().toISOString().split('T')[0]}.json`;
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            };
            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                if (!confirm("Tem certeza que deseja importar este backup? TODOS os dados atuais serão substituídos.")) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedState = JSON.parse(e.target.result);
                        if (importedState.pedidos && importedState.clientes && importedState.configuracoes) {
                            state = importedState;
                            Object.keys(state).forEach(key => {
                                if(key !== 'currentFilter' && key !== 'financeFilter') saveData(`${key}_v4`, state[key]);
                            });
                            alert("Backup importado com sucesso! A página será recarregada.");
                            location.reload();
                        } else { alert("Arquivo de backup inválido. Verifique se o arquivo está correto."); }
                    } catch (err) { alert("Erro ao ler o arquivo de backup: " + err.message); }
                    finally { selectors.importFile.value = ''; }
                };
                reader.readAsText(file);
            };

            // ==================================================================
            // 8. FUNÇÕES GLOBAIS e LISTENERS
            // ==================================================================
             window.generateContract = (pedidoId) => {
                const pedido = state.pedidos.find(p => p.id === pedidoId);
                if (!pedido) { alert("Pedido não encontrado para gerar contrato."); return; }
                generateContractPDF(pedido);
            };
             window.generateReceipt = (financeId) => {
                const financeEntry = state.financeiro.find(f => f.id === financeId);
                if (!financeEntry) { alert("Lançamento financeiro não encontrado."); return; }
                generateReceiptPDF(financeEntry);
            };

            selectors.cards.forEach(c => c.onclick = () => showTab(c.dataset.tab));
            selectors.settingsButton.onclick = () => showTab('configuracoes');
            selectors.btnAddPedido.onclick = () => openPedidoModal();
            selectors.btnAddCliente.onclick = () => openClientModal();
            // Usando openAddAgendaModal para o botão "Adicionar" na aba Agenda
            selectors.btnAddAgenda.onclick = () => openAddAgendaModal();
            selectors.btnAddMaterial.onclick = () => openMaterialModal();
            selectors.btnAddServico.onclick = () => openServicoModal();
            selectors.btnAddDespesa.onclick = () => openDespesaModal();

            selectors.pedidoForm.onsubmit = (e) => {
                e.preventDefault();
                const pedidoSalvo = savePedido();
                if (pedidoSalvo) {
                    closeModal(selectors.pedidoModal);
                }
            };

            selectors.btnDownloadPdf.onclick = () => {
                const pedidoId = selectors.pedidoForm.querySelector('[name="id"]').value;
                let pedidoParaGerar = null;

                if (pedidoId) {
                    pedidoParaGerar = getPedidoById(pedidoId);
                } else {
                    pedidoParaGerar = savePedido();
                }

                if (pedidoParaGerar) {
                    generateOrderPDF(pedidoParaGerar);
                    closeModal(selectors.pedidoModal);
                } else {
                    alert("Por favor, preencha todos os campos obrigatórios do pedido antes de gerar o PDF.");
                }
            };

            selectors.btnSendWhatsapp.onclick = () => {
                const pedidoId = selectors.pedidoForm.querySelector('[name="id"]').value;
                let pedidoParaEnviar = null;

                if (pedidoId) {
                    pedidoParaEnviar = getPedidoById(pedidoId);
                } else {
                    pedidoParaEnviar = savePedido();
                }

                if (pedidoParaEnviar) {
                    sendWhatsApp(pedidoParaEnviar);
                    closeModal(selectors.pedidoModal);
                } else {
                     alert("Por favor, preencha todos os campos obrigatórios do pedido antes de enviar por WhatsApp.");
                }
            };

            selectors.clientForm.onsubmit = (e) => handleFormSubmit(e, 'clientes', selectors.clientForm, selectors.clientModal, displayClientes);
            // Usando addAgendaForm para o formulário de adição/edição da agenda
            selectors.addAgendaForm.onsubmit = (e) => handleFormSubmit(e, 'agenda', selectors.addAgendaForm, selectors.addAgendaModal, displayAgenda);
            selectors.materialForm.onsubmit = (e) => handleFormSubmit(e, 'materiais', selectors.materialForm, selectors.materialModal, displayMateriaisEstoque);
            selectors.servicoForm.onsubmit = (e) => handleFormSubmit(e, 'servicos', selectors.servicoForm, selectors.servicoModal, displayServicos);
            selectors.despesaForm.onsubmit = (e) => {
                 e.preventDefault();
                 if (!selectors.despesaForm.checkValidity()) {
                    selectors.despesaForm.reportValidity();
                    return;
                }
                 const formData = new FormData(selectors.despesaForm);
                 const valorDespesa = parseFloat(formData.get('valor')) || 0;
                 if (valorDespesa <= 0) { alert("O valor da despesa deve ser positivo."); return; }

                 state.financeiro.push({ id: generateId('des'), tipo: 'despesa', status: 'pago', descricao: formData.get('descricao'), data: formData.get('data'), valor: valorDespesa });
                 saveData('financeiro_v4', state.financeiro); alert('Despesa salva!'); closeModal(selectors.despesaModal); displayFinanceiro();
            };
            selectors.pagamentoForm.onsubmit = (e) => {
                e.preventDefault();
                if (!selectors.pagamentoForm.checkValidity()) {
                    selectors.pagamentoForm.reportValidity();
                    return;
                }
                const formData = new FormData(selectors.pagamentoForm);
                const valorPago = parseFloat(formData.get('valor')) || 0;
                const formaPagamento = formData.get('formaPagamento');

                if (valorPago <= 0) { alert("O valor recebido deve ser positivo."); return; }

                const pedidoId = formData.get('pedidoId');

                const newReceipt = { id: generateId('rec'), tipo: 'receita', status: 'pago', descricao: formData.get('descricao'), data: formData.get('data'), valor: valorPago, pedidoId: pedidoId, formaPagamento: formaPagamento };
                state.financeiro.push(newReceipt);
                saveData('financeiro_v4', state.financeiro);
                alert('Pagamento lançado!');
                closeModal(selectors.pagamentoModal);

                if (pedidoId) {
                    const relatedPedido = getPedidoById(pedidoId);
                    if (relatedPedido) {
                        handlePedidoIntegrations(relatedPedido, false);
                    }
                }

                displayFinanceiro();
                displayPedidos();
                if(confirm("Deseja gerar o recibo deste pagamento agora?")) {
                    generateReceiptPDF(newReceipt);
                }
            };
            selectors.configForm.onsubmit = (e) => {
                e.preventDefault();
                const formData = new FormData(selectors.configForm);
                formData.forEach((v, k) => state.configuracoes.empresa[k] = v);
                saveData('configuracoes_v4', state.configuracoes); alert('Dados da empresa salvos!');
            };
            selectors.logoUpload.onchange = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onloadend = () => { state.configuracoes.logo = reader.result; saveData('configuracoes_v4', state.configuracoes); displayConfig(); };
                reader.readAsDataURL(file);
            };
            selectors.btnRemoveLogo.onclick = () => {
                if (confirm("Remover logomarca?")) { state.configuracoes.logo = null; saveData('configuracoes_v4', state.configuracoes); selectors.logoUpload.value = ''; displayConfig(); }
            };
            selectors.btnExportData.onclick = exportData;
            selectors.btnImportData.onclick = () => selectors.importFile.click();
            selectors.importFile.onchange = importData;

            document.querySelectorAll('.close-button, .close-btn').forEach(btn => btn.onclick = (e) => { e.preventDefault(); closeModal(btn.closest('.modal')); });
            window.onclick = (e) => { if (e.target.classList.contains('modal')) closeModal(e.target); };

            selectors.filterButtons.forEach(b => b.onclick = (e) => {
                selectors.filterButtons.forEach(btn => btn.classList.remove('active'));
                e.currentTarget.classList.add('active');
                state.currentFilter = e.currentTarget.dataset.filter;
                displayPedidos();
            });
            selectors.financeFilterButtons.forEach(b => b.onclick = (e) => {
                selectors.financeFilterButtons.forEach(btn => btn.classList.remove('active'));
                e.currentTarget.classList.add('active');
                state.financeFilter = e.currentTarget.dataset.filter;
                displayFinanceiro();
            });
            selectors.btnFilterDate.onclick = () => displayFinanceiro();
            selectors.btnClearDateFilter.onclick = () => {
                selectors.financeStartDate.value = '';
                selectors.financeEndDate.value = '';
                displayFinanceiro();
            };

            selectors.linkAddClienteModal.onclick = (e) => { e.preventDefault(); closeModal(selectors.pedidoModal); openClientModal(); };
            selectors.btnClearData.onclick = () => {
                if (confirm("TEM CERTEZA ABSOLUTA?\n\nTodos os dados serão PERMANENTEMENTE APAGADOS.\n\nEsta ação NÃO PODE ser desfeita!")) {
                    if(confirm("ÚLTIMO AVISO!\n\nConfirma a exclusão de TUDO?")){
                        localStorage.clear();
                        alert("Todos os dados foram apagados. A página será recarregada.");
                        location.reload();
                    }
                }
            };

            // NOVO: Listeners para o agendaDetailsModal
            selectors.btnCompleteAgenda.onclick = () => {
                const agendaId = selectors.agendaDetailsForm.querySelector('[name="id"]').value;
                const agendaItem = getAgendaById(agendaId);
                if (agendaItem) {
                    agendaItem.status = 'concluido';
                    saveData('agenda_v4', state.agenda);
                    alert('Compromisso marcado como Concluído!');
                    closeModal(selectors.agendaDetailsModal);
                    displayAgenda();
                }
            };
            selectors.btnCancelAgenda.onclick = () => {
                const agendaId = selectors.agendaDetailsForm.querySelector('[name="id"]').value;
                const agendaItem = getAgendaById(agendaId);
                if (agendaItem) {
                    agendaItem.status = 'cancelado';
                    saveData('agenda_v4', state.agenda);
                    alert('Compromisso marcado como Cancelado!');
                    closeModal(selectors.agendaDetailsModal);
                    displayAgenda();
                }
            };
            selectors.btnSaveAgendaDetails.onclick = () => {
                const agendaId = selectors.agendaDetailsForm.querySelector('[name="id"]').value;
                const agendaItem = getAgendaById(agendaId);
                if (agendaItem) {
                    agendaItem.obsAgenda = selectors.agendaDetailsForm.querySelector('[name="obsAgenda"]').value;
                    agendaItem.status = selectors.statusAgendaSelect.value;
                    saveData('agenda_v4', state.agenda);
                    alert('Observações e status do compromisso salvos!');
                    closeModal(selectors.agendaDetailsModal);
                    displayAgenda();
                }
            };


            // ==================================================================
            // 9. LISTENERS DOS BOTÕES DE RELATÓRIO
            // ==================================================================
            selectors.btnReportPedidos.onclick = () => {
                const headers = ['ID', 'Cliente', 'Tipo', 'Data', 'Status', 'Valor Total', 'Valor Pago'];
                const dataMapper = (p) => {
                    const clienteNome = getClientNameById(p.clienteId);
                    const totalPago = state.financeiro
                        .filter(f => f.pedidoId === p.id && f.tipo === 'receita')
                        .reduce((sum, f) => sum + parseFloat(f.valor), 0);
                    return [
                        p.id ? p.id.substring(4, 10) : 'ERRO',
                        clienteNome || '',
                        p.tipoEvento || '',
                        formatDate(p.dataEvento),
                        p.status || '',
                        formatCurrency(p.valorTotal),
                        formatCurrency(totalPago)
                    ];
                };
                const filterFn = (p) => p && (state.currentFilter === 'todos' || p.status === state.currentFilter);
                generateReportPDF('pedidos', 'Relatório de Pedidos', headers, dataMapper, filterFn);
            };

            selectors.btnReportAgenda.onclick = () => {
                const headers = ['Data', 'Horário', 'Descrição', 'Cliente', 'Status', 'Observações'];
                const dataMapper = (a) => [
                    formatDate(a.data),
                    a.horario || '',
                    a.descricao || '',
                    a.cliente || '',
                    (a.status || 'pendente').charAt(0).toUpperCase() + (a.status || 'pendente').slice(1),
                    a.obsAgenda || ''
                ];
                generateReportPDF('agenda', 'Relatório da Agenda', headers, dataMapper);
            };

            selectors.btnReportFinanceiro.onclick = () => {
                const headers = ['Data', 'Tipo', 'Descrição', 'Valor', 'Status/Pedido'];
                const dataMapper = (f) => {
                    let statusText = f.status || '';
                    if (f.tipo === 'a_receber') {
                        statusText = `A Receber`;
                    } else if (f.tipo === 'receita') {
                        statusText = `Receita`;
                    } else if (f.tipo === 'despesa') {
                        statusText = `Despesa`;
                    }
                    return [
                        formatDate(f.data),
                        f.tipo.replace('_',' ').toUpperCase(),
                        f.descricao || '',
                        formatCurrency(f.valor),
                        f.pedidoId ? `Pedido #${f.pedidoId.substring(4,10)}` : statusText
                    ];
                };
                const filterFn = (f) => {
                    const typeMatch = state.financeFilter === 'todos' || f.tipo === state.financeFilter;
                    const startDate = selectors.financeStartDate.value;
                    const endDate = selectors.financeEndDate.value;
                    const dateMatch = (!startDate || f.data >= startDate) && (!endDate || f.data <= endDate);
                    const statusMatch = !(f.tipo === 'a_receber' && f.status === 'cancelado');
                    return typeMatch && dateMatch && statusMatch;
                };
                generateReportPDF('financeiro', 'Relatório Financeiro', headers, dataMapper, filterFn);
            };

            selectors.btnReportClientes.onclick = () => {
                const headers = ['Nome', 'Contato', 'Email', 'Aniversário', 'Endereço', 'Observações'];
                const dataMapper = (c) => [
                    c.nome || '',
                    c.contato || '',
                    c.emailCliente || '',
                    formatDate(c.aniversario),
                    c.enderecoCliente || '',
                    c.obs || ''
                ];
                generateReportPDF('clientes', 'Relatório de Clientes', headers, dataMapper);
            };

            selectors.btnReportMateriais.onclick = () => {
                const headers = ['Item', 'Quantidade', 'Observações'];
                const dataMapper = (m) => [
                    m.item || '',
                    m.quantidade || '0',
                    m.obs || ''
                ];
                generateReportPDF('materiais', 'Relatório de Materiais e Estoque', headers, dataMapper);
            };

            selectors.btnReportServicos.onclick = () => {
                const headers = ['Serviço', 'Descrição', 'Valor Base'];
                const dataMapper = (s) => [
                    s.nome || '',
                    s.descricao || '',
                    formatCurrency(s.valor)
                ];
                generateReportPDF('servicos', 'Relatório de Serviços Oferecidos', headers, dataMapper);
            };

            // ==================================================================
            // 10. INICIALIZAÇÃO
            // ==================================================================
            displayConfig();
            populateClientSelect();
            checkBirthdays();
            showTab('pedidos');
            console.log("CRM DJ V5.4 - Inicialização Concluída.");
        });
    </script>
</body>
</html>